# 開発環境の特殊仕様

このファイルは開発環境でのみ適用される特殊な仕様やワークアラウンドをまとめたドキュメントです。

## 目次
- [ユーザー管理](#ユーザー管理)
- [データベース](#データベース)
- [テストデータ](#テストデータ)
- [注意事項](#注意事項)

## ユーザー管理

### 自動ユーザー作成機能
**場所**: `internal/repository/room_repository.go` の `JoinRoom` メソッド

開発環境では、存在しないユーザーIDでの部屋参加時に自動的にダミーユーザーを作成します。

**動作**:
- 部屋参加時にユーザーID存在チェック
- 存在しない場合、以下の形式でダミーユーザーを自動作成:
  ```go
  user = models.User{
      ID:             userID, // 認証システムから来るID
      SupabaseUserID: userID, // 開発用（本来は別のUUID）
      Email:          "dev-user-{userID[:8]}@example.com",
      DisplayName:    "開発ユーザー_{userID[:8]}",
      IsActive:       true,
      Role:           "user",
  }
  ```

**理由**:
- 認証システム（Supabase等）から来るユーザーIDとDBのユーザーIDが一致しない場合の外部キー制約エラーを回避
- テスト時の利便性向上

**本番環境での注意**:
- この機能は本番環境では無効化する必要がある
- 本番では適切な認証フローでユーザー作成を行う

## データベース

### テストデータベース
**データベース名**: `mhp_rooms_dev`

**接続情報**:
```bash
docker compose exec db psql -U mhp_user -d mhp_rooms_dev
```

### テストユーザー一覧
シードデータで作成されるテストユーザー（`cmd/seed/main.go`参照）:

| 表示名 | メールアドレス | 説明 |
|--------|---------------|------|
| ハンター太郎 | hunter1@example.com | MHP2Gメイン |
| 猫好きハンター | hunter2@example.com | 初心者歓迎 |
| 素材コレクター | hunter3@example.com | 効率重視 |

## テストデータ

### テスト部屋一覧
シードデータで作成される部屋（`cmd/seed/main.go`参照）:

| 部屋名 | ルームコード | 説明 |
|--------|-------------|------|
| 上位ティガレックス討伐 | ROOM-001 | MHP2G、HR6以上 |
| 初心者歓迎部屋 | ROOM-002 | MHP3、制限なし |
| レア素材狙い | ROOM-003 | MHP2、HR4以上 |
| 進行中の部屋 | ROOM-004 | MHP、HR3以上 |

## 注意事項

### 開発環境でのワークアラウンド

1. **N+1問題の解決**
   - `internal/repository/user_repository.go`に`FindUsersByIDs`メソッドを追加
   - `internal/handlers/room_detail.go`でバッチ取得を使用

2. **RoomMember作成時の修正**
   - `PlayerNumber`: アクティブメンバーの最大番号+1
   - `JoinedAt`: 現在時刻を設定
   - 空の日時（`0000-00-00 00:00:00`）エラーを回避

3. **外部キー制約対応**
   - 部屋参加時のユーザー存在チェック強化
   - 開発環境でのダミーユーザー自動作成

4. **部屋参加機能の修正**
   - `internal/handlers/rooms.go`の`JoinRoom`と`LeaveRoom`で認証情報からユーザーIDを取得
   - `middleware.GetDBUserFromContext()`を使用してDBユーザー情報を取得
   - 参加成功時に部屋詳細画面へのリダイレクトURL返却
   - 認証が必要な操作に認証ミドルウェアを適用
   - フロントエンドでJWTトークンをAuthorizationヘッダーに送信

5. **RoomMember再参加機能の修正**
   - 退室後の再参加時に既存の`left`レコードを再利用
   - `status`を`left`→`active`に更新、`left_at`をクリア
   - 重複レコード作成を防止
   - `LeaveRoom`処理で`left_at`フィールドを適切に設定

### 本番環境移行時の注意点

- [ ] 自動ユーザー作成機能の無効化
- [ ] 適切な認証フローの実装
- [ ] テストデータのクリーンアップ
- [ ] 本番用の設定ファイルの確認

### 開発チームへの注意

- この機能は開発・テスト専用です
- 本番環境では絶対に使用しないでください
- 新しいワークアラウンドを追加した場合は、このドキュメントを更新してください

## 更新履歴

- 2025-07-21: 初版作成
  - 自動ユーザー作成機能の追加
  - N+1問題解決
  - RoomMember作成修正