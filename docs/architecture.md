# システムアーキテクチャ

## 概要

モンスターハンターポータブルシリーズのアドホックパーティルーム管理システムのアーキテクチャドキュメントです。本システムは、リアルタイムでのルーム管理とユーザー間のコミュニケーションを実現するWebアプリケーションとして設計されています。

## 技術スタック

### フロントエンド
- **UIライブラリ**: htmx
  - サーバーサイドレンダリングによる高速な画面遷移
  - HTMLパーシャルレスポンスによる効率的な更新
  - WebSocketサポートによるリアルタイム通信
- **JavaScript**: Alpine.js
  - htmxで実現できないクライアントサイドのインタラクション
  - 軽量で学習コストの低いリアクティブフレームワーク
- **CSSフレームワーク**: Tailwind CSS
  - ユーティリティファーストによる高速な開発
  - カスタマイズ可能なデザインシステム

### バックエンド
- **言語**: Go (Golang)
  - 高速な処理性能と効率的なメモリ使用
  - 優れた並行処理サポート
  - 静的型付けによる安全性
- **Webフレームワーク**: Echo または Gin
  - 軽量で高速なHTTPルーティング
  - ミドルウェアサポート
- **テンプレートエンジン**: html/template
  - Goの標準テンプレートエンジン
  - htmxとの相性が良い
- **リアルタイム通信**: Gorilla WebSocket
  - Go向けの成熟したWebSocketライブラリ
  - 効率的な双方向通信

### 認証・認可
- **認証サービス**: Supabase Authentication
  - メールアドレス/パスワード認証
  - Google OAuth 2.0認証（Supabase Auth経由）
  - 統一されたJWT トークン管理
  - マルチデバイス対応

### データベース
- **ホスティング**: Render PostgreSQL
  - マネージドPostgreSQLサービス
  - 自動バックアップ
  - SSL接続必須
- **ORMライブラリ**: GORM
  - Go向けの人気ORM
  - マイグレーション機能付き
- **キャッシュ**: Redis (Render Redis)
  - セッション管理
  - リアルタイムデータのキャッシング
  - Render上でのマネージドRedis
- **Redisクライアント**: go-redis
  - Go向けの高速Redisクライアント

### インフラストラクチャ
- **コンテナ**: Docker
  - 開発環境の統一
  - デプロイメントの簡素化
- **オーケストレーション**: Docker Compose（開発環境）
- **本番環境**:
  - Render（Webサービス、PostgreSQL、Redis）
  - 自動デプロイ、スケーリング
  - Cloudflare CDN（静的アセット配信）

## システム構成

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│                 │     │                 │     │                 │
│   クライアント   │────▶│   Render LB     │────▶│   CDN (静的)    │
│   (ブラウザ)    │     │                 │     │  (Cloudflare)   │
└─────────────────┘     └─────────────────┘     └─────────────────┘
         │                       │
         │ htmx/WebSocket       │
         ▼                       ▼
┌─────────────────────────────────────────┐       ┌────────────────────┐
│                                         │       │                    │
│      Render Web Service (Go App)        │───────│ Supabase Auth     │
│  ┌─────────────┐  ┌─────────────────┐  │       │ - メール/PW認証  │
│  │  HTTPハンドラ │  │ WebSocketハンドラ│  │       │ - Google OAuth    │
│  └─────────────┘  └─────────────────┘  │       │ - 統一JWT管理     │
│  ┌─────────────────────────────────┐   │       └────────────────────┘
│  │      ビジネスロジック層          │   │
│  └─────────────────────────────────┘   │
│  ┌─────────────────────────────────┐   │
│  │      データアクセス層 (GORM)     │   │
│  └─────────────────────────────────┘   │
└─────────────────────────────────────────┘
                    │
           ┌────────┴────────┐
           │                 │
           ▼                 ▼
   ┌───────────────────┐   ┌───────────────┐
   │                   │   │               │
   │ Render PostgreSQL │   │ Render Redis  │
   │                   │   │               │
   └───────────────────┘   └───────────────┘
```

## 主要コンポーネント

### 1. プレゼンテーション層
- **HTMLテンプレート**: サーバーサイドでレンダリング
- **htmxエンドポイント**: 部分的なHTML更新を返すAPI
- **Alpine.jsコンポーネント**: クライアントサイドの状態管理
- **静的アセット**: CSS、JavaScript、画像ファイル

### 2. アプリケーション層
- **HTTPハンドラ**: リクエストの受付とレスポンスの生成
- **WebSocketハンドラ**: リアルタイム通信の管理
- **ミドルウェア**: 認証、ロギング、エラーハンドリング
- **バリデーション**: 入力値の検証

### 3. ビジネスロジック層
- **サービス**: ビジネスロジックの実装
- **リポジトリインターフェース**: データアクセスの抽象化
- **ドメインモデル**: ビジネスエンティティの定義
- **イベントハンドラ**: WebSocketイベントの処理

### 4. データアクセス層
- **リポジトリ実装**: GORMを使用したデータアクセス
- **マイグレーション**: データベーススキーマの管理
- **キャッシング**: Redisを使用した高速アクセス

## htmxの活用パターン

### 1. ページ遷移
```html
<!-- ルーム一覧の動的更新 -->
<div hx-get="/rooms" hx-trigger="every 5s" hx-swap="innerHTML">
  <!-- ルーム一覧がここに表示される -->
</div>
```

### 2. フォーム送信
```html
<!-- ルーム作成フォーム -->
<form hx-post="/rooms" hx-target="#room-list" hx-swap="afterbegin">
  <!-- フォーム要素 -->
</form>
```

### 3. WebSocket統合
```html
<!-- WebSocket接続 -->
<div hx-ws="connect:/ws/room/{id}">
  <div id="messages" hx-swap-oob="morphdom">
    <!-- メッセージがリアルタイムで更新される -->
  </div>
</div>
```

## Alpine.jsの活用パターン

### 1. クライアントサイド状態管理
```html
<!-- モーダルダイアログの制御 -->
<div x-data="{ open: false }">
  <button @click="open = true">ルーム作成</button>
  <div x-show="open" x-transition>
    <!-- モーダルコンテンツ -->
  </div>
</div>
```

### 2. フォームバリデーション
```html
<!-- リアルタイムバリデーション -->
<div x-data="{ password: '', valid: false }">
  <input x-model="password" @input="valid = password.length >= 8">
  <span x-show="!valid">パスワードは8文字以上必要です</span>
</div>
```

## セキュリティ設計

### 認証・認可
- Supabase Authenticationによる統一JWTベース認証
- サポートする認証方法:
  - メールアドレス/パスワード認証
  - Google OAuth 2.0認証（Supabase Auth経由）
- CSRF対策（Gorilla CSRF）
- セキュアなCookie設定
- トップページ以外は認証必須

### データ保護
- HTTPS通信の強制
- SQLインジェクション対策（プリペアドステートメント）
- XSS対策（html/templateの自動エスケープ）
- 入力値のサニタイズ

### レート制限
- tollboothミドルウェアによるレート制限
- IPベースおよびユーザーベースの制限

## スケーラビリティ

### 水平スケーリング
- ステートレスなアプリケーション設計
- Redisによるセッション共有
- ロードバランサーによる負荷分散

### パフォーマンス最適化
- Goの高速な処理性能
- 効率的なメモリ使用
- コネクションプーリング
- 適切なインデックス設計

## 監視・ログ

### アプリケーション監視
- Prometheusによるメトリクス収集
- Grafanaによる可視化
- アラート設定

### ログ管理
- 構造化ログ（JSON形式）
- ログレベルの管理
- ログローテーション

## 開発フロー

### 環境構成
- 開発環境: Docker Compose
- ホットリロード: Air（Goアプリケーション）
- 本番環境: Renderデプロイ
  - GitHub統合による自動デプロイ
  - Web Service + PostgreSQL + Redisの統合環境

### CI/CD
- GitHub Actions による自動テスト
- golangci-lintによる静的解析
- 自動デプロイメント

## プロジェクト構造

```
mhp-rooms/
├── cmd/
│   └── server/
│       └── main.go          # エントリーポイント
├── internal/
│   ├── handlers/            # HTTPハンドラ
│   ├── websocket/          # WebSocketハンドラ
│   ├── services/           # ビジネスロジック
│   ├── repository/         # データアクセス
│   ├── models/             # ドメインモデル
│   └── middleware/         # ミドルウェア
├── web/
│   ├── templates/          # HTMLテンプレート
│   ├── static/            # 静的ファイル
│   │   ├── css/          # Tailwind CSS
│   │   └── js/           # Alpine.js
│   └── components/        # 再利用可能なテンプレート
├── migrations/            # DBマイグレーション
├── docker/               # Docker設定
└── configs/             # 設定ファイル
```


## 今後の拡張計画

1. **リアルタイムチャット機能の強化**
   - 現在は基本的なチャット機能
   - 必要に応じてリアルタイム性を強化

2. **パフォーマンス向上**
   - キャッシング戦略の最適化
   - データベースクエリの最適化

3. **機能拡張**
   - プッシュ通知機能
   - モバイル対応の強化
