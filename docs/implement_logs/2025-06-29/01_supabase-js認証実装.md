# Supabase-js認証実装

**実装開始時刻**: 2025-06-29 (開始時刻不明)  
**実装完了時刻**: 2025-06-29 (完了時刻不明)  
**実装時間**: 約1-2時間

## 実装概要

フロントエンドでSupabase-jsを使用し、バックエンドでJWT検証を行うハイブリッド認証システムを実装しました。従来のサーバーサイド認証（supabase-go）から、フロントエンド主導の認証方式に変更することで、より柔軟で現代的な認証システムを構築しました。

## 実装した機能

### 1. 環境変数の準備
- `.env.example`にSupabase JWT Secret設定を追加
- フロントエンド用（SUPABASE_URL, SUPABASE_ANON_KEY）とサーバー用（SUPABASE_JWT_SECRET）を分離

### 2. フロントエンド認証システム
- **Supabase初期化スクリプト** (`static/js/supabase.js`)
  - Supabaseクライアントの自動初期化
  - 認証状態の監視とイベント発火
  - 認証関連のヘルパー関数（ログイン、サインアップ、ログアウト等）

- **Alpine.js認証ストア** (`static/js/auth-store.js`)
  - 認証状態の一元管理
  - リアルタイムでの認証状態更新
  - エラーハンドリング

- **htmx統合** (`static/js/htmx-auth.js`)
  - API呼び出し時の自動JWT トークン付与
  - 401エラーのハンドリング
  - トークンリフレッシュ機能

### 3. バックエンドJWT検証システム
- **JWT認証ミドルウェア** (`internal/middleware/auth.go`)
  - SupabaseのJWTトークン検証
  - 必須認証とオプショナル認証の両方をサポート
  - コンテキストへのユーザー情報格納

- **設定エンドポイント** (`internal/handlers/config.go`)
  - フロントエンド用のSupabase設定を安全に公開

### 4. 認証テンプレートの更新
- **ベースレイアウト** (`templates/layouts/base.html`)
  - Supabase-jsとカスタムスクリプトの読み込み
  - 従来の認証ストア定義を削除

- **ログインページ** (`templates/pages/login.html`)
  - Supabase-jsを使用したログイン処理
  - 適切なエラーメッセージ表示

- **新規登録ページ** (`templates/pages/register.html`)
  - Supabase-jsを使用したサインアップ処理
  - メタデータ（PSN ID）の設定

### 5. APIエンドポイントの保護
- JWT認証が必要なエンドポイントとオプショナルなエンドポイントを分離
- CurrentUserハンドラーをJWT認証に対応するよう更新

## 特に注意した点・工夫した点

### 1. セキュリティ
- JWT検証はサーバーサイドで厳密に実行
- 環境変数による秘密鍵の管理
- フロントエンドに秘密鍵が露出しないよう設計

### 2. ユーザビリティ
- 認証状態のリアルタイム同期
- 自動トークンリフレッシュ
- 直感的なエラーメッセージ

### 3. 開発効率
- 既存のテンプレートとの互換性維持
- Alpine.jsストアパターンの活用
- htmxとの自然な統合

### 4. エラーハンドリング
- 401エラーの自動検出とログインページへのリダイレクト
- トークン期限切れの適切な処理
- ユーザーフレンドリーなエラーメッセージ

## テスト結果・動作確認

### 実装完了項目
- ✅ Supabase設定とクライアント初期化
- ✅ フロントエンド認証フロー
- ✅ JWT認証ミドルウェア
- ✅ 保護されたAPIエンドポイント
- ✅ 認証状態の自動同期
- ✅ ログアウト機能

### 要確認項目
- 実際のSupabaseプロジェクトでの動作テスト
- 環境変数設定の確認
- メール確認フローのテスト
- パスワードリセット機能との統合

## 今後の改善点

1. **OAuth統合**: Google認証をSupabase-jsで実装
2. **エラー監視**: Supabaseエラーの詳細ログ
3. **パフォーマンス**: トークンキャッシングの最適化
4. **テスト**: 自動テストの実装

## 注意事項

- 本実装を動作させるには、以下の環境変数設定が必要です：
  - `SUPABASE_URL`: SupabaseプロジェクトのURL
  - `SUPABASE_ANON_KEY`: Supabaseの匿名キー
  - `SUPABASE_JWT_SECRET`: JWT検証用の秘密鍵

- 既存のsupabase-go実装は維持されているため、段階的な移行が可能です。