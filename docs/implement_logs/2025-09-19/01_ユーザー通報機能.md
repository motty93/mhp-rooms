# ユーザー通報機能の実装

**実装日**: 2025年9月19日
**開始時刻**: 11:50
**完了時刻**: 12:05
**所要時間**: 約75分

## 実装概要

GitHub Issue #37「ユーザー 通報機能」の要件に基づき、プロフィール画面の通報ボタンから通報モーダルを表示し、通報理由の選択・画像アップロード・詳細入力を可能にする機能を実装しました。

## 実装内容

### 1. データベース設計

#### 新規テーブル作成
- **user_reports**: 通報情報を管理
  - reporter_user_id: 通報者のユーザーID
  - reported_user_id: 通報対象のユーザーID
  - reasons: 通報理由（JSONB型で複数選択可能）
  - description: 詳細説明
  - status: ステータス（pending/reviewing/resolved/rejected）
  - admin_note: 管理者メモ
  - resolved_at: 解決日時

- **report_attachments**: 通報の添付ファイル
  - report_id: 通報ID
  - file_path: ファイルパス
  - file_type: ファイルタイプ
  - file_size: ファイルサイズ
  - original_name: 元のファイル名

### 2. 通報理由カテゴリー

以下9つの通報理由を実装：
- スパム・迷惑行為
- 嫌がらせ・誹謗中傷
- なりすまし
- 不適切なコンテンツ
- 詐欺・フィッシング
- プライバシー侵害
- **チート行為**（ゲーム特化）
- **公序良俗違反**（追加要望）
- その他

### 3. バックエンド実装

#### モデル（internal/models/）
- `user_report.go`: 通報メインモデル、理由定義、ステータス管理
- `report_attachment.go`: 添付ファイルモデル

#### リポジトリ（internal/repositories/）
- `report_repository.go`: 通報CRUD操作、重複チェック、検索機能

#### ハンドラー（internal/handlers/）
- `report_handler.go`: 通報作成・画像アップロード・理由取得API

#### APIエンドポイント
- `POST /api/users/{id}/report`: 通報送信
- `POST /api/reports/{id}/upload`: 画像アップロード
- `GET /api/report/reasons`: 通報理由一覧取得

### 4. フロントエンド実装

#### UIコンポーネント（templates/components/）
- `report_modal.tmpl`: 通報モーダル（Alpine.js使用）
  - 通報理由の複数選択（チェックボックス）
  - 画像アップロード（最大3枚、5MB制限）
  - 詳細説明（500文字制限）
  - バリデーション機能

#### 既存コンポーネント修正
- `block_report_buttons.tmpl`: 通報ボタンにモーダル表示機能追加

#### 統合
- `user_profile.tmpl`: 通報モーダルとイベントハンドラー統合

### 5. セキュリティ対策

- **重複通報防止**: 24時間以内の同一ユーザーへの通報を制限
- **認証チェック**: 全APIエンドポイントで認証必須
- **バリデーション**:
  - ファイル形式・サイズチェック
  - 文字数制限
  - 自己通報防止
- **ファイルアップロード**: 安全なディレクトリ配置

### 6. 技術的な工夫

#### データベース設計
- **Turso対応**: SQLiteベースのため、JSONはtext型で保存してGoでシリアライズ・デシリアライズ
- 適切なインデックス設計（ステータス、作成日時、ユーザー関係）

#### UI/UX
- Alpine.jsによるリアクティブなモーダル
- 段階的な入力フロー
- リアルタイムバリデーション
- レスポンシブデザイン対応

#### システム連携
- 既存のリポジトリパターンとの統合
- 統一されたエラーハンドリング
- 適切な型安全性

## 動作確認

- ✅ マイグレーション実行成功
- ✅ ビルド成功
- ✅ サーバー起動確認
- ✅ 既存機能への影響なし

## 今後の拡張予定

### Phase 2（管理機能）
- 管理画面での通報一覧表示
- 通報内容の確認・対応機能
- ペナルティシステム実装
- 通報統計とレポート機能

### 改善点
- 通報理由の詳細カテゴリー追加検討
- 自動判定システムの導入
- メール通知機能

## 特記事項

- **チート行為**と**公序良俗違反**の通報理由を追加要望に基づき実装
- ゲーム特化の通報システムとして設計
- 開発環境・本番環境共通ロジックで実装（環境別分岐なし）
- **Turso/SQLite対応**: JSONはtext型で保存し、Goで適切にシリアライズ・デシリアライズ処理
- 実装完了時点で管理機能は未実装（Phase 2で対応予定）

## ファイル一覧

### 新規作成
- `internal/models/user_report.go`
- `internal/models/report_attachment.go`
- `internal/repositories/report_repository.go`
- `internal/repository/report_repository_interface.go`
- `internal/handlers/report_handler.go`
- `templates/components/report_modal.tmpl`

### 修正
- `internal/infrastructure/persistence/postgres/db.go`
- `internal/infrastructure/persistence/turso/db.go`
- `internal/repository/repository.go`
- `cmd/server/application.go`
- `cmd/server/routes.go`
- `templates/components/block_report_buttons.tmpl`
- `templates/pages/user_profile.tmpl`

### ディレクトリ作成
- `static/uploads/reports/`（画像アップロード用）