# 通報機能エラー修正

**実装日**: 2025年9月23日  
**実装者**: Claude Code  
**実装時間**: 約1時間30分

## 概要

repository層統合作業の影響で通報機能にエラーが発生していた問題を段階的に修正しました。

## 発生していた問題

### 1. 初期エラー: 通報理由の受け取りエラー
```
通報エラー：Error: 通報理由を選択してください
```
**原因**: フロントエンドとバックエンドのAPI仕様不一致

### 2. Repository初期化エラー
**原因**: `NewReportRepository`の引数型が他のRepositoryと異なっていた

### 3. Foreign Key制約エラー
```
SQLite error: FOREIGN KEY constraint failed
通報者ユーザーが見つかりません: 7c92fde0-2785-454d-86d7-dd19f4290034
```
**原因**: SupabaseユーザーIDとローカルDBのIDの混在

## 修正内容

### 1. API仕様の統一

**ファイル**: `templates/components/report_modal.tmpl`

```javascript
// 修正前
body: JSON.stringify({
  reasons: [this.selectedReason], // 配列形式
  description: this.description,
})

// 修正後
body: JSON.stringify({
  reason: this.selectedReason,    // 単一値
  description: this.description,
})
```

### 2. Repository初期化の修正

**ファイル**: `internal/repository/repository.go`

```go
// 修正前
Report: NewReportRepository(db.GetConn()),

// 修正後
Report: NewReportRepository(db),
```

**ファイル**: `internal/repository/report_repository.go`

```go
// 修正前
func NewReportRepository(db *gorm.DB) ReportRepository {

// 修正後
func NewReportRepository(db DBInterface) ReportRepository {
    return &reportRepository{db: db.GetConn()}
}
```

### 3. ユーザー自動作成機能の修正

**ファイル**: `internal/middleware/auth.go`

```go
// 修正前: ユーザーが見つからない場合はnilを返すだけ
existingUser, err := j.repo.User.FindUserBySupabaseUserID(supabaseUserID)
if err != nil || existingUser == nil {
    return nil
}

// 修正後: ユーザーが見つからない場合は自動作成を試行
existingUser, err := j.repo.User.FindUserBySupabaseUserID(supabaseUserID)
if err != nil || existingUser == nil {
    // ユーザーが見つからない場合は自動作成を試行
    newUser, createErr := j.EnsureUserExistsWithContext(ctx, authUser)
    if createErr != nil {
        return nil
    }
    // キャッシュに保存（5分間）
    j.userCache.Set(supabaseUserID, newUser, 5*time.Minute)
    return newUser
}
```

### 4. ID管理の修正（最も重要）

**ファイル**: `internal/handlers/report.go`

```go
// 修正前: SupabaseIDとローカルDBのIDが混在
func getUserIDFromSession(r *http.Request) uuid.UUID {
    if user, ok := middleware.GetUserFromContext(r.Context()); ok && user != nil {
        if id, err := uuid.Parse(user.ID); err == nil {
            return id  // SupabaseのID ❌
        }
    }
    if dbUser, ok := middleware.GetDBUserFromContext(r.Context()); ok && dbUser != nil {
        return dbUser.ID  // ローカルDBのID ✅
    }
    return uuid.Nil
}

// 修正後: ローカルDBのIDを優先
func getUserIDFromSession(r *http.Request) uuid.UUID {
    // 最初にDBUserContextKeyを確認（ローカルDBのIDが必要）
    if dbUser, ok := middleware.GetDBUserFromContext(r.Context()); ok && dbUser != nil {
        return dbUser.ID
    }
    // DBUserが見つからない場合はNilを返す
    return uuid.Nil
}
```

## 技術的学習点

### 1. ID管理の重要性
- **SupabaseユーザーID**: 認証システムで使用される外部ID
- **ローカルDBのID**: Foreign Key制約で必要な内部ID
- **使い分け**: 機能に応じて適切なIDを使用する必要がある

### 2. Repository Pattern の一貫性
- すべてのRepositoryで同じインターフェース(`DBInterface`)を使用
- コンストラクタの引数も統一する
- 他のRepositoryと異なる実装は後々問題を引き起こす

### 3. API設計の重要性
- フロントエンドとバックエンドの仕様は厳密に一致させる
- データ構造（配列 vs 単一値）の違いは実行時エラーになる

### 4. 開発環境でのユーザー管理
- 認証されたユーザーが自動的にローカルDBに作成される仕組みが必要
- middlewareでの適切な処理順序が重要

## テスト結果

### ✅ 成功ケース
- 通報理由の選択: 正常動作
- 通報詳細の入力: 正常動作  
- 通報の送信: 正常動作
- DBへの保存: Foreign Key制約エラー解消

### 🔍 確認項目
- [ ] 各通報理由での動作確認
- [ ] 画像添付機能の動作確認
- [ ] 重複通報防止機能の確認
- [ ] 管理者側での通報確認機能

## 今後の改善点

1. **エラーハンドリングの強化**
   - より詳細なログ出力
   - ユーザーフレンドリーなエラーメッセージ

2. **テストケースの追加**
   - 通報機能の自動テスト
   - ID変換処理のテスト

3. **パフォーマンス最適化**
   - ユーザー存在確認の最適化
   - キャッシュ戦略の見直し

## まとめ

Repository層統合による副作用として通報機能にエラーが発生しましたが、段階的な問題解決により正常動作を回復しました。

特に、SupabaseユーザーIDとローカルDBのIDの使い分けが重要であることが判明し、これは他の機能でも参考になる学習点でした。

**最重要**: 機能間の依存関係とID管理の一貫性を保つことの重要性を再認識しました。