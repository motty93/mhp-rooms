# アクティビティ表示修正

## 実装時間
開始: 2025-11-15
完了: 2025-11-16
所要時間: 約1時間30分

## 対応Issue
GitHub Issue #147: プロフィール画面 アクティビティでフォローしたユーザー名、部屋のホスト名が表示されていない

## 問題の概要
アクティビティタブで以下の問題が発生していた：
1. フォロー時のユーザー名が表示されず「さんをフォローしました」となっている
2. 部屋に参加したとき、ホスト名が表示されず「ホスト：」だけになっている

## 原因
`internal/services/activity_service.go`のアクティビティ記録時に、`DisplayName`が空の場合のフォールバック処理が実装されていなかった。

## 修正内容

### 1. `RecordFollow`メソッドの修正（190-199行目）
```go
// DisplayNameが空の場合はUsernameを使用
displayName := followingUser.DisplayName
if displayName == "" && followingUser.Username != nil {
    displayName = *followingUser.Username
}

title := fmt.Sprintf("%sさんをフォローしました", displayName)
if isMutual {
    title = fmt.Sprintf("%sさんと相互フォローになりました", displayName)
}
```

### 2. `RecordRoomJoin`メソッドの修正（92-102行目）
```go
// DisplayNameが空の場合はUsernameを使用
hostDisplayName := hostUser.DisplayName
if hostDisplayName == "" && hostUser.Username != nil {
    hostDisplayName = *hostUser.Username
}

activity := &models.UserActivity{
    UserID:            userID,
    ActivityType:      models.ActivityRoomJoin,
    Title:             fmt.Sprintf("【部屋参加】%s", room.Name),
    Description:       stringPtr(fmt.Sprintf("ホスト: %s", hostDisplayName)),
    // ...
}
```

### 3. エラーハンドリングの確認
`internal/handlers/follow.go`と`internal/handlers/rooms.go`のエラーハンドリングを確認し、既に適切に実装されていることを確認した。

### 4. 既存データの修正（データマイグレーション）
既存のアクティビティレコードで`description`が空または「ホスト: 」だけになっているものを修正するため、データマイグレーションスクリプトを作成・実行した。

**スクリプトファイル**: `cmd/fix-activity/main.go`

**処理内容**:
1. `room_join`タイプのアクティビティで`description`が空または「ホスト: 」のレコードを検索
2. 各アクティビティの`metadata`から`host_user_id`を抽出
3. ホストユーザー情報を取得（DisplayNameが空の場合はUsernameを使用）
4. `description`を「ホスト: [ホスト名]」に更新

**実行結果**: 22件のアクティビティレコードを正常に更新

**実行方法**:
```bash
# 開発環境（Turso staging）
ENV=development DB_TYPE=turso go run cmd/fix-activity/main.go

# または
make fix-activity
```

## 修正ファイル
- `internal/services/activity_service.go` - フォールバック処理の追加
- `cmd/fix-activity/main.go` - 既存データ修正スクリプト（新規作成）

## テスト結果
- フォロー機能でDisplayNameが空のユーザーをフォローした場合、Usernameが表示される
- 部屋参加機能でDisplayNameが空のホストの部屋に参加した場合、Usernameが表示される
- データマイグレーションスクリプトで22件の既存レコードを正常に更新
- ユーザーが共有したレコードID `c3600a4a-c63e-41bf-bf19-4cb913b0fe15` を含む全ての対象レコードが「ホスト: momomomomotty.co18」に更新された

## 特に注意した点
1. **安全なフォールバック処理**: `DisplayName`が空かつ`Username`がnilでない場合のみフォールバック
2. **既存の実装との整合性**: 他の箇所でのユーザー名表示方法と統一
3. **エラーハンドリング**: ハンドラー側のエラーハンドリングは既に適切に実装されていることを確認

## 残存課題・今後の改善点
1. ~~**既存データの修正**~~: ✅ データマイグレーションスクリプトで対応済み
2. **ユーザー登録時の保証**: ユーザー登録時に`DisplayName`が必ず設定されるようにする必要がある
3. **テンプレート側のフォールバック**: テンプレート側でも念のため、空の値の場合に「不明なユーザー」などを表示する処理を追加することも検討できる
4. **フォローアクティビティ**: フォロー関連のアクティビティでも同様の問題がある可能性があるため、必要に応じて確認・修正が必要

## 本番環境での実行方法

本番環境（Turso production）でスクリプトを実行する場合：

### 方法1: ローカルから本番DBに接続（推奨）

```bash
# Cloud Runの環境変数を確認（本番用のTurso接続情報）
gcloud run services describe mhp-rooms --region=asia-northeast-1 --format="get(spec.template.spec.containers[0].env)"

# 環境変数を設定して実行
TURSO_DATABASE_URL="libsql://..." \
TURSO_AUTH_TOKEN="..." \
DB_TYPE=turso \
ENV=production \
go run cmd/fix-activity/main.go

# または
TURSO_DATABASE_URL="libsql://..." \
TURSO_AUTH_TOKEN="..." \
DB_TYPE=turso \
ENV=production \
make fix-activity
```

### 方法2: .env.productionファイルを使用

```bash
# .env.productionを作成
cat > .env.production <<EOF
DB_TYPE=turso
TURSO_DATABASE_URL="libsql://..."
TURSO_AUTH_TOKEN="..."
ENV=production
EOF

# .envにコピーして実行
cp .env.production .env
make fix-activity

# 元に戻す
git checkout .env
```

### 注意事項
- 本番環境のTurso接続情報は、Cloud Runの環境変数から取得してください
- スクリプトは冪等性があり、何度実行しても安全です
- 実行前に念のためTursoコンソールでバックアップを確認することを推奨します

## 備考
- 新規に作成されるアクティビティレコードでは、ユーザー名やホスト名が適切に表示される
- 開発環境（Turso staging）で22件のレコードをデータマイグレーションにより修正済み
- マイグレーションスクリプトは再実行可能で、新たに問題が発生した場合にも使用できる
- 本番環境では必要に応じて手動で実行してください
