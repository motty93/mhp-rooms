# GCS アバター画像アップロード機能の実装

**実装日**: 2025-09-16
**実装時間**: 約2時間

## 実装した機能の概要

プロフィール編集画面でユーザーがアバター画像をアップロードできる機能を、Google Cloud Storage (GCS) を使用して実装しました。アップロードされた画像はGCSのpublicバケットに保存され、環境別（dev/prod）のフォルダ構造で管理されます。

## 主要な実装内容

### 1. ストレージ層の実装 (`internal/storage/gcs.go`)

- **GCSUploader構造体**: Google Cloud Storageクライアントのラッパー
- **環境変数管理**:
  - `GCS_BUCKET`: バケット名
  - `BASE_PUBLIC_ASSET_URL`: 公開URL（CDN対応可能）
  - `ASSET_PREFIX`: 環境別プレフィックス（dev/prod）
  - `MAX_UPLOAD_BYTES`: ファイルサイズ制限（デフォルト10MB）
  - `ALLOW_CONTENT_TYPES`: 許可されるファイル形式

- **セキュリティ機能**:
  - ファイルサイズ制限（10MB）
  - ファイル形式制限（JPEG、PNG、WebP）
  - ファイル名のサニタイズ処理
  - MD5ハッシュによる重複防止とキャッシュ無効化

- **パス構造**:
  ```
  {ASSET_PREFIX}/avatars/{user-id}/{basename}-{hash12}.{ext}
  例: dev/avatars/123e4567-e89b/avatar-abc123def456.jpg
  ```

### 2. ハンドラー層の実装 (`internal/handlers/profile.go`)

- **UploadAvatarハンドラー**:
  - マルチパートフォームの解析（最大32MB）
  - 認証チェック
  - GCSへのアップロード処理
  - データベースのアバターURL更新
  - JSON形式のレスポンス返却

### 3. フロントエンド実装 (`static/js/profile.js`)

- **Alpine.jsによるアップロード処理**:
  - ファイル選択時の即座のプレビュー表示
  - ファイルタイプとサイズのクライアント側検証
  - FormDataを使用した非同期アップロード
  - アップロード成功後のプロフィール画面への自動遷移

## 特に注意した点や工夫した点

### 1. セキュリティとパフォーマンス

- **キャッシュ戦略**: `Cache-Control: public, max-age=31536000, immutable`を設定し、ファイル名にハッシュを含めることで、ブラウザキャッシュを最大限活用しつつ、画像更新時は新しいURLで即座に反映
- **ファイル検証**: サーバー側でContent-Type検証とファイルサイズ制限を厳密に実施
- **環境分離**: 開発環境と本番環境でGCSバケット内のフォルダを分離（dev/prod）

### 2. ユーザビリティ

- **即座のプレビュー**: FileReader APIを使用して、アップロード前に画像をプレビュー表示
- **自動アップロード**: ファイル選択後、即座にアップロード処理を開始
- **エラーハンドリング**: ユーザーに分かりやすいエラーメッセージを表示

### 3. 拡張性

- **CDN対応**: `BASE_PUBLIC_ASSET_URL`を変更するだけでCDN経由の配信に切り替え可能
- **環境変数による設定**: ハードコードを避け、環境変数で柔軟に設定可能

## テスト結果や動作確認の内容

1. **ファイルアップロードテスト**:
   - JPEG、PNG、WebP形式のファイルアップロード成功を確認
   - 10MB超のファイルで適切なエラーメッセージ表示を確認
   - 不正なファイル形式で適切な拒否を確認

2. **GCS統合テスト**:
   - アップロードされたファイルがGCSバケットの正しいパスに保存されることを確認
   - 公開URLからのアクセス可能性を確認
   - Cache-Controlヘッダーが正しく設定されることを確認

3. **UI/UXテスト**:
   - プレビュー機能の動作確認
   - アップロード後のプロフィール画面への遷移確認
   - エラー時の通知表示確認

## 今後の改善点

1. **画像最適化**: アップロード時の画像リサイズ・圧縮機能の追加
2. **プログレスバー**: 大きなファイルアップロード時の進捗表示
3. **画像削除機能**: デフォルトアバターへの戻し機能
4. **複数画像対応**: プロフィールに複数の画像を追加できる機能

## 関連ファイル

- `/docs/gcs-avatar-setup.md`: GCSセットアップガイド
- `/internal/storage/gcs.go`: GCSアップローダー実装
- `/internal/handlers/profile.go`: プロフィールハンドラー
- `/static/js/profile.js`: フロントエンドJS
