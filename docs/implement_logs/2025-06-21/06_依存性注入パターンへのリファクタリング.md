# 依存性注入パターンへのリファクタリング作業ログ

## 実施日時
2025-06-21
実装時間: 45分

## 作業概要
グローバル変数パターンから依存性注入パターンへの大規模リファクタリングを実施

## 実施内容

### 1. 問題の認識
従来の`database.DB`グローバル変数パターンの課題：
- テストが困難（モックしにくい）
- 密結合（すべてのコードが`database.DB`に直接依存）
- 並行処理での問題
- 初期化順序の不明確さ

### 2. databaseパッケージの改修

#### 新しいDB構造体の作成（db.go）
```go
type DB struct {
    conn *gorm.DB
}

func NewDB(cfg *config.Config) (*DB, error) {
    // 設定から接続を作成
    // 接続プールの設定
    return &DB{conn: conn}, nil
}
```

#### 主要メソッドの実装
- `GetConn()`: GORM接続を返す（移行期間用）
- `Close()`: 接続を閉じる
- `Migrate()`: マイグレーション実行
- `addConstraintsAndIndexes()`: 制約・インデックス追加
- `insertInitialData()`: 初期データ投入

#### wait.goの修正
```go
func WaitForDB(cfg *config.Config, maxRetries int, retryInterval time.Duration) error
```
- グローバル設定への依存を排除
- 設定を引数で受け取るように変更

### 3. repositoryパッケージの新規作成

#### 構造
- `repository.go`: 全体的なRepository管理
- `user_repository.go`: ユーザー関連データアクセス
- `game_version_repository.go`: ゲームバージョン関連
- `room_repository.go`: ルーム関連データアクセス

#### 実装パターン
```go
type UserRepository struct {
    db *database.DB
}

func NewUserRepository(db *database.DB) *UserRepository {
    return &UserRepository{db: db}
}

func (r *UserRepository) FindByID(id uuid.UUID) (*models.User, error) {
    // データアクセスロジック
}
```

#### 主要メソッド
**UserRepository:**
- Create, FindByID, FindBySupabaseUserID, FindByEmail, Update, GetActiveUsers

**GameVersionRepository:**
- FindByID, FindByCode, GetActiveVersions

**RoomRepository:**
- Create, FindByID, FindByRoomCode, GetActiveRooms, Update, UpdateStatus, IncrementPlayerCount, DecrementPlayerCount

### 4. handlersパッケージの改修

#### Handler構造体の作成
```go
type Handler struct {
    repo *repository.Repository
}

func NewHandler(repo *repository.Repository) *Handler {
    return &Handler{repo: repo}
}
```

#### メソッドの変更
- 関数 → メソッドに変更
- `func HomeHandler()` → `func (h *Handler) HomeHandler()`
- `database.DB`直接参照 → `h.repo`経由でのアクセス

#### rooms.goの大幅改修
- 直接的なGORM呼び出しをRepository経由に変更
- エラーハンドリングの改善
- コードの簡潔化

### 5. main.goの改修

#### 依存性の組み立て
```go
// 設定初期化
config.Init()

// データベース接続
db, err := database.NewDB(config.AppConfig)

// 依存関係構築
repo := repository.NewRepository(db)
handler := handlers.NewHandler(repo)

// ルーター設定
r.HandleFunc("/", handler.HomeHandler).Methods("GET")
```

### 6. ファイルの整理
- 古い`database.go`を削除（グローバル変数版）
- 新しい`db.go`に置き換え

## 技術的な改善点

### 1. テスタビリティの向上
- インターフェースを後から追加可能
- モックRepositoryの作成が容易
- 単体テストが書きやすい

### 2. 関心の分離
- データアクセス（Repository）
- ビジネスロジック（Service層追加予定）
- プレゼンテーション（Handler）

### 3. 保守性の向上
- 各コンポーネントが独立
- 依存関係が明示的
- 変更の影響範囲が限定的

### 4. 並行処理対応
- 各インスタンスが独立した状態
- グローバル状態への依存を排除

## 注意点・工夫

### 1. 移行期間のサポート
- `GetConn()`メソッドで既存コードとの互換性確保
- 段階的な移行が可能

### 2. エラーハンドリング
- Repository層でgorm.ErrRecordNotFoundを適切に処理
- アプリケーション固有のエラーメッセージに変換

### 3. パフォーマンス考慮
- Preloadの適切な使用
- N+1問題の回避

## 今後の拡張性

### 1. インターフェース化
```go
type UserRepositoryInterface interface {
    Create(*models.User) error
    FindByID(uuid.UUID) (*models.User, error)
}
```

### 2. Service層の追加
- ビジネスロジックの分離
- Repository間の調整

### 3. テストの充実
- モックを使った単体テスト
- 統合テスト

## 成果
- よりテストしやすいアーキテクチャ
- Clean Architectureの基盤構築
- 将来的な拡張に対応可能な設計