# リポジトリの分離

**実装時間**: 約15分

## 実装概要

単一の`repository.go`ファイルを、テーブルごとに分離してより保守性の高い構造に再編成しました。

## 実装内容

### 1. 新規作成ファイル

#### interfaces.go
- 各リポジトリのインターフェースを定義
- `UserRepository`、`GameVersionRepository`、`RoomRepository`の3つのインターフェース
- 依存性の注入とテスタビリティの向上

#### user_repository.go
- ユーザー関連のCRUD操作を実装
- `UserRepository`インターフェースの実装
- 具体的なメソッド：
  - `CreateUser`、`FindUserByID`、`FindUserBySupabaseUserID`
  - `FindUserByEmail`、`UpdateUser`、`GetActiveUsers`

#### game_version_repository.go
- ゲームバージョン関連の操作を実装
- `GameVersionRepository`インターフェースの実装
- 具体的なメソッド：
  - `FindGameVersionByID`、`FindGameVersionByCode`
  - `GetActiveGameVersions`

#### room_repository.go
- ルーム関連の操作を実装
- `RoomRepository`インターフェースの実装
- 具体的なメソッド：
  - `CreateRoom`、`FindRoomByID`、`FindRoomByRoomCode`
  - `GetActiveRooms`、`UpdateRoom`、`UpdateRoomStatus`
  - `IncrementRoomPlayerCount`、`DecrementRoomPlayerCount`
  - `JoinRoom`、`LeaveRoom`

### 2. 既存ファイルの改修

#### repository.go
- 統合リポジトリとして各専用リポジトリを組み合わせ
- 後方互換性のための委譲メソッドを提供
- 段階的な移行を可能にする設計

## 技術的な改善点

### 1. 単一責任の原則
- 各リポジトリファイルが特定のテーブルの操作のみを担当
- コードの可読性とメンテナビリティが向上

### 2. 依存性の注入
- インターフェースベースの設計
- テストでのモック作成が容易
- 実装の差し替えが可能

### 3. 段階的移行
- 既存のコードを破壊しない委譲メソッドを提供
- 新しいコードでは`repo.User.CreateUser()`の形式で利用可能
- 既存のコードは`repo.CreateUser()`でそのまま動作

## ファイル構造

```
internal/repository/
├── interfaces.go              # インターフェース定義
├── repository.go              # 統合リポジトリ（委譲）
├── user_repository.go         # ユーザーリポジトリ実装
├── game_version_repository.go # ゲームバージョンリポジトリ実装
└── room_repository.go         # ルームリポジトリ実装
```

## 使用方法

### 新しい推奨方法
```go
repo := repository.NewRepository(db)

// ユーザー操作
user, err := repo.User.FindUserByID(id)

// ゲームバージョン操作
versions, err := repo.GameVersion.GetActiveGameVersions()

// ルーム操作
rooms, err := repo.Room.GetActiveRooms(nil, 100, 0)
```

### 既存の方法（後方互換性）
```go
repo := repository.NewRepository(db)

// 従来通りの呼び出しも可能
user, err := repo.FindUserByID(id)
versions, err := repo.GetActiveGameVersions()
rooms, err := repo.GetActiveRooms(nil, 100, 0)
```

## 実装の特徴

### 1. Clean Architecture準拠
- ビジネスロジックからデータアクセスを分離
- インターフェースによる抽象化
- テスタビリティの向上

### 2. 拡張性
- 新しいテーブル用のリポジトリを追加しやすい
- 各リポジトリが独立して機能

### 3. 保守性
- 関心の分離により、変更の影響範囲を限定
- コードの理解が容易

## 今後の改善案

### 1. トランザクション管理
- 複数リポジトリにまたがるトランザクションの統一管理
- UnitOfWorkパターンの検討

### 2. キャッシュ層
- リポジトリレベルでのキャッシュ機能
- Redis等の外部キャッシュとの統合

### 3. 段階的な移行完了
- 委譲メソッドの段階的削除
- 新しいインターフェースベースの使用への完全移行

## 動作確認

- ビルドエラーなし
- 既存のコードは変更なしで動作
- 新しいインターフェースベースの使用も可能