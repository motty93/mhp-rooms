# トップページのパフォーマンス改善

実装時間: 約45分

## 概要
トップページアクセス時に同じユーザーに対するデータベースクエリが重複実行される問題を修正しました。

## 問題の詳細
ログ分析の結果、以下の問題が発生していました：
- 同じSupabase User IDに対するSELECTクエリが5回実行
- 同じユーザーのUPDATEクエリが5回実行（updated_atのみ更新）

## 原因
1. **フロントエンドの重複実行**
   - `auth-store.js`の初期化処理が複数回実行されていた
   - `syncUser`メソッドが重複して呼ばれていた

2. **バックエンドの不要な更新**
   - `/api/auth/sync`エンドポイントで、変更がなくても毎回UPDATE処理を実行していた

## 実装内容

### 1. auth-store.jsの修正
- 初期化フラグ`_initStarted`を追加して、`init()`メソッドの重複実行を防止
- 同期処理フラグ`_syncInProgress`を追加して、`syncUser()`メソッドの重複実行を防止

### 2. base.tmplの修正
- Alpine.js初期化時の重複した認証チェック処理を削除
- 認証ストアの初期化は`auth-store.js`内で一元管理するように変更

### 3. auth.goのSyncUserメソッドの修正
- ユーザー情報に変更がある場合のみDBを更新するように条件分岐を追加
- Email、PSN IDが既存の値と同じ場合は更新をスキップ

## 効果
- データベースへのクエリ数が大幅に削減
- トップページの読み込み速度が向上
- 不要なネットワーク通信の削減

## テスト結果
- フロントエンドの初期化処理が1回のみ実行されることを確認
- 認証済みユーザーのトップページアクセス時のクエリ数が削減されることを確認
- ユーザー情報に変更がない場合、UPDATE処理がスキップされることを確認

## 追加修正（第2回）

### 残存していた問題
初回修正後も、同じユーザーIDに対するSELECTクエリが4回実行される問題が残っていました。

### 原因
1. **ルーティング設定の問題**
   - `setupPageRoutes`で`PathPrefix("")`を使用していたため、すべてのリクエストに`OptionalMiddleware`が適用されていた
   - 静的ファイル（CSS、JS、画像等）へのアクセスでもミドルウェアが実行されていた

2. **ミドルウェアの重複実行**
   - 同一リクエスト内で既にユーザー情報が取得済みでも、再度DBアクセスが発生していた

### 追加実装内容

1. **ルーティング順序の変更**
   - 静的ファイルのルーティングを最初に設定し、ミドルウェアが適用されないように修正

2. **OptionalMiddlewareの改善**
   - 既にコンテキストにユーザー情報がある場合はスキップする処理を追加
   - DBユーザー取得時も、既に取得済みの場合はスキップするように修正

### 最終的な効果
- トップページアクセス時のSELECTクエリが1回のみに削減（静的ファイルへのアクセスではクエリが発生しない）
- 不要なミドルウェア実行の削減

## 追加修正（第3回）

### 最終的な問題の特定
デバッグログを追加して調査した結果、`PathPrefix("")`を使用していたため、以下のすべてのリクエストに`OptionalMiddleware`が適用されていたことが判明：
- `/` - トップページ本体
- `/api/config/supabase` - Supabase設定取得
- その他のAPIエンドポイント

### 最終修正内容

1. **ミドルウェアの適用範囲を限定**
   - `PathPrefix("")`によるサブルーターの使用を廃止
   - 各ページルートに個別にミドルウェアを適用するように変更
   - これにより、APIエンドポイントへの不要なミドルウェア適用を防止

2. **デバッグログの削除**
   - 問題特定後、パフォーマンスへの影響を避けるためデバッグログを削除

### 最終結果
- トップページアクセス時のSELECTクエリが1回のみに削減
- APIエンドポイントへのアクセスでは認証ミドルウェアが実行されない
- 全体的なパフォーマンスの大幅な改善

## 今後の改善点
- より詳細なパフォーマンス計測の実施
- キャッシュ戦略の検討
- 他のページでも同様の最適化が必要か調査