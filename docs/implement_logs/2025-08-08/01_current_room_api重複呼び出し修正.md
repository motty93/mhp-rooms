# current-room API重複呼び出し修正

実装時間: 約30分

## 実装内容

部屋一覧アクセス時に`/api/user/current-room`が重複して呼び出され、不要なエラーログが大量に出力される問題を修正しました。

## 問題の詳細

### 発生していた問題
- 部屋一覧ページにアクセスすると、`/api/user/current-room`が繰り返し呼び出される
- 部屋に参加していない場合、"record not found"エラーが大量にログ出力される
- ヘッダーとモバイルメニューの両方で独立してAPIを呼び出していた

### 原因
1. header.tmplとbase.tmpl（モバイルメニュー）の両方で`$store.auth.isAuthenticated`を監視
2. 認証状態が変わるたびに、各コンポーネントが独立してAPIを呼び出し
3. 同じ情報を取得するのに重複したAPI呼び出しが発生

## 実装した修正

### 1. auth-store.jsの改修
- `currentRoom`データプロパティを追加
- `fetchCurrentRoom()`メソッドを追加して、API呼び出しを一元管理
- 重複呼び出しを防ぐためのフラグ管理を実装
- 認証時に自動的にcurrentRoomを取得するように変更

### 2. テンプレートの修正
- **header.tmpl**: 
  - `$watch`によるAPI呼び出しを削除
  - `$store.auth.currentRoom`を直接参照するように変更
- **base.tmpl**: 
  - `$watch`によるAPI呼び出しを削除
  - `$store.auth.currentRoom`を直接参照するように変更

## 修正による効果
1. API呼び出しが1回に削減
2. 不要なネットワークトラフィックの削減
3. サーバー負荷の軽減
4. ユーザー体験の向上（応答速度向上）

## 今後の改善案
1. GORMのログ設定を調整して、"record not found"エラーのログレベルを下げることを検討
2. currentRoomの更新タイミングを最適化（部屋参加/退出時の自動更新）
3. キャッシュの有効期限を設定して、一定時間後に再取得する仕組みの実装

## テスト項目
- [ ] ログイン後、部屋一覧ページで重複したAPI呼び出しが発生しないこと
- [ ] ヘッダーに現在参加中の部屋が正しく表示されること
- [ ] モバイルメニューに現在参加中の部屋が正しく表示されること
- [ ] 部屋から退出した際に、表示が正しく更新されること