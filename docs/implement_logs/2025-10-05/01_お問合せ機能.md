# お問合せ機能実装

## 実装時間
開始: 2025-10-05 15:30
完了: 2025-10-05 16:30
所要時間: 約1時間

## 実装内容

GitHub issue #48に基づき、お問合せ機能のバックエンド実装を完了しました。

### 1. データベース層

#### Contactモデル (`internal/models/contact.go`)
- お問合せ種類（inquiry_type）
- お名前（name）
- メールアドレス（email）
- 件名（subject）
- お問い合わせ内容（message）
- IPアドレス（ip_address）
- User Agent（user_agent）
- 認証済みユーザーかどうか（is_authenticated）
- Supabase User ID（supabase_user_id - nullable）
- BaseModel継承（ID、CreatedAt、UpdatedAt）

### 2. リポジトリ層

#### ContactRepository (`internal/repository/contact_repository.go`)
- `CreateContact`: お問合せの作成
- `FindContactByID`: IDでお問合せを検索（管理画面用）

### 3. Discord通知機能

#### Discord Webhook (`internal/utils/discord.go`)
- お問合せ内容を整形してDiscordに送信
- テストデータの場合は視覚的に区別（グレー色）
- お問合せ種類に応じた色分け
  - バグ報告: 赤
  - 機能要望: 緑
  - 使い方・操作方法: 青
  - アカウント関連: 黄色
  - その他: グレー
- 長文の自動切り詰め（メッセージ: 1000文字、User Agent: 200文字）

### 4. 設定層

#### Config設定 (`internal/config/config.go`)
- `DiscordConfig`構造体を追加
  - WebhookURL: Discord Webhook URL
- 環境変数`DISCORD_WEBHOOK_URL`からWebhook URLを読み込み

### 5. ハンドラー層

#### Contactハンドラー (`internal/handlers/contact.go`)
主な機能追加：
- **テストデータ検出**: 「test」「テスト」「てすと」「TEST」を含む場合、DB保存をスキップ
- **IPアドレス取得**: X-Forwarded-For → X-Real-IP → RemoteAddrの順で取得
- **User Agent取得**: リクエストヘッダーから取得
- **認証情報取得**: コンテキストからSupabase User IDを取得（オプショナル）
- **DB保存**: テストデータ以外をDBに保存
- **Discord通知**: すべてのお問合せを通知（テストデータも含む）
- **エラーハンドリング**: DB保存・Discord通知の失敗時もユーザーにはエラーを返さない

### 6. ルーティング層

#### ルーティング設定 (`cmd/server/routes.go`)
- `/contact`のPOSTルートを追加
- `withOptionalAuth`ミドルウェアを使用（未ログインでも送信可能）

### 7. マイグレーション

#### Turso (`internal/infrastructure/persistence/turso/db.go`)
- `commonMigrate`関数に`&models.Contact{}`を追加

#### PostgreSQL (`internal/infrastructure/persistence/postgres/db.go`)
- `commonMigrate`関数に`&models.Contact{}`を追加

### 8. プライバシーポリシー更新

#### テンプレート更新 (`templates/pages/privacy.tmpl`)
- 第2条（個人情報の収集方法）にIPアドレス・ブラウザ情報を追記
- 第3条（個人情報を収集・利用する目的）にお問合せ管理の目的を追記

## 特に注意した点

### 1. インポートサイクルの回避
- 当初、`internal/utils/discord.go`が`internal/models`をインポートしていたが、これによりインポートサイクルが発生
- 解決策として`utils.ContactInfo`構造体を作成し、モデルへの依存を排除

### 2. テストデータの扱い
- テストデータは通知のみ行い、DB保存はスキップ
- Discordでは視覚的に区別できるよう「🧪 テストデータ（DB保存なし）」というタイトルとグレー色を使用

### 3. エラーハンドリング
- DB保存失敗やDiscord通知失敗時も、ユーザーには正常完了を返す
- エラーはログに記録し、運用側で確認可能

### 4. セキュリティとプライバシー
- IPアドレスとUser Agentの収集についてプライバシーポリシーに明記
- プロキシ環境を考慮したIPアドレス取得（X-Forwarded-For優先）

### 5. 認証情報の扱い
- 認証はオプショナルで、未ログインでも送信可能
- 認証済みの場合はSupabase User IDを記録

## テスト結果

### ビルドテスト
- ✅ マイグレーション成功（contactsテーブル作成）
- ✅ ビルド成功（エラーなし）

### 動作確認項目
次の項目を確認してください：
- [ ] お問合せフォームからの送信
- [ ] テストデータの検出とDB保存スキップ
- [ ] Discord通知の受信
- [ ] 認証済みユーザーでの送信
- [ ] 未認証ユーザーでの送信
- [ ] IPアドレス・User Agentの正しい記録

## 今後の改善点・TODO

### 必須
1. Discord Webhook URLの設定
   - 環境変数`DISCORD_WEBHOOK_URL`を本番環境に設定
   - 開発環境でもテスト用Webhookを設定して動作確認

2. プライバシーポリシーの法的レビュー
   - IPアドレス・User Agentの収集について法的問題がないか確認

### 推奨
1. 管理画面の実装
   - お問合せ一覧表示
   - お問合せ詳細表示
   - ステータス管理（未対応・対応中・完了）

2. 通知の拡張
   - Slack通知オプションの追加
   - メール通知機能（任意）

3. レート制限
   - お問合せフォームへのレート制限追加（スパム対策）

4. バリデーション強化
   - 不適切な内容の検出
   - スパムフィルター

## 関連ファイル

### 新規作成
- `internal/models/contact.go`
- `internal/repository/contact_repository.go`
- `internal/utils/discord.go`

### 修正
- `internal/handlers/contact.go`
- `internal/repository/repository.go`
- `internal/repository/interfaces.go`
- `internal/config/config.go`
- `cmd/server/routes.go`
- `internal/infrastructure/persistence/turso/db.go`
- `internal/infrastructure/persistence/postgres/db.go`
- `templates/pages/privacy.tmpl`

## 参考情報

- GitHub Issue: #48
- Discord Webhook API: https://discord.com/developers/docs/resources/webhook
