# 部屋参加時の確認モーダル修正

## 実装時間
- 開始時刻: 2025-09-10 15:00（推定）
- 完了時刻: 2025-09-10 15:15（推定）
- 合計時間: 約15分

## 実装概要
既に部屋に参加している状態で他の部屋に参加しようとした際のエラーハンドリングを修正しました。

## 技術的詳細

### 修正内容
1. サーバー側のエラーレスポンス形式の統一
   - `http.Error()`によるプレーンテキストレスポンスをJSON形式に変更
   - `internal/handlers/rooms.go` の `JoinRoom` メソッドで、409エラー時にJSON形式でレスポンスを返すよう修正

2. クライアント側のエラーハンドリング修正
   - `templates/pages/rooms.tmpl` で、レスポンスボディを複数回読み込もうとしていた問題を修正
   - `response.json()` を一度だけ呼び出し、エラー種別を判定するように変更

3. UI/UX改善
   - 確認モーダル表示時に参加モーダルを自動的に閉じるように修正
   - `this.closeModal()` の呼び出しを追加

### 修正前の挙動
- 「参加する」ボタンクリック時に `Unexpected token '既', "既に別の部屋に参加しています" is not valid JSON` というエラーが表示
- その後 `Failed to execute 'text' on 'Response': body stream already read` エラーが発生

### 修正後の挙動
- 既に他の部屋に参加している場合、適切に確認モーダルが表示される
- 参加モーダルが自動的に閉じて、確認モーダルのみが表示される

## 特に注意した点
- レスポンス形式の統一性を保つため、他のエラーレスポンスと同様のJSON形式を採用
- Fetch APIのレスポンスボディは一度しか読み取れないことを考慮
- ユーザー体験を損なわないよう、モーダルの表示順序と重なりを適切に制御

## テスト結果
- 既に部屋に参加している状態で他の部屋の「参加する」ボタンをクリック
- 確認モーダルが正しく表示されることを確認
- 参加モーダルが自動的に閉じることを確認
- エラーメッセージが表示されなくなったことを確認

## 今後の課題
- エラーハンドリングの全体的な見直し（他の箇所でも同様の問題がないか確認）
- モーダル制御のロジックをより堅牢にする
- エンドツーエンドテストの追加