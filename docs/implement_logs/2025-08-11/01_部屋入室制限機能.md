# 部屋入室制限機能の実装

実装開始時刻: 2025-08-11 14:00
実装完了時刻: 2025-08-11 16:30
実装時間: 約2時間30分

## 実装概要

issue #14「部屋の入室制限」に基づき、ユーザーが同時に1つの部屋にしか所属できない制約を完全に実装しました。

## 実装内容

### 1. バックエンド実装

#### リポジトリ層の拡張
- `GetUserRoomStatus`メソッドを追加
  - ユーザーの部屋状態（NONE/HOST/GUEST）を取得
  - ホスト中の部屋、参加中の部屋を判定

#### APIエンドポイント追加
- `/api/user/current/room-status` エンドポイントを追加
  - 現在のユーザーの部屋状態を返す
  - フロントエンドでの事前チェックに使用

#### ハンドラー層の修正
- `CreateRoom`ハンドラー
  - ホスト中のチェックを追加（409エラー: HOST_ROOM_ACTIVE）
  - 参加中の場合は自動退出（既存実装を維持）
  
- `JoinRoom`ハンドラー
  - ホスト中のチェックを追加（409エラー: HOST_CANNOT_JOIN）
  - 参加中の場合は`forceJoin`フラグで処理（既存実装を維持）

### 2. フロントエンド実装

#### room-create-modal.js
- 部屋作成前に`room-status`エンドポイントで状態チェック
- ホスト中：警告モーダルを表示
- 参加中：確認モーダルを表示
- 未参加：通常どおり作成モーダルを開く

#### room_create_modal.tmpl
- ホスト中警告モーダルを追加
  - 「新しい部屋を作成できません」
  - ホスト中の部屋へのリンクを提供
- ゲスト確認モーダルを追加
  - 「他の部屋に参加中です」
  - 「退出して作成」ボタンで確認後に作成

#### rooms.tmpl
- 部屋参加時のホスト中制限モーダルを追加
  - 「他の部屋に参加できません」
  - ホスト中の部屋へのリンクを提供

## 技術的な工夫点

### 1. 状態管理の一元化
- `GetUserRoomStatus`メソッドで状態判定を一元化
- HOST/GUEST/NONEの3状態で管理

### 2. エラーコードの統一
- `HOST_ROOM_ACTIVE`: ホスト中で新規作成不可
- `HOST_CANNOT_JOIN`: ホスト中で他部屋参加不可
- `OTHER_ROOM_ACTIVE`: 他部屋に参加中（既存）

### 3. UXの配慮
- フロントエンドで事前チェックすることで、不要なリクエストを削減
- 適切なモーダル表示で、ユーザーに状況を明確に伝達
- 「ホスト中の部屋へ移動」リンクで、迷わず操作可能

### 4. トランザクション処理
- 部屋作成時の参加中部屋からの退出は、トランザクション内で処理
- データの整合性を保証

## テスト確認項目

1. ホスト中のユーザーが新しい部屋を作成しようとした場合
   - ✓ 警告モーダルが表示される
   - ✓ APIレベルでもブロックされる

2. ホスト中のユーザーが他の部屋に参加しようとした場合
   - ✓ 制限モーダルが表示される
   - ✓ APIレベルでもブロックされる

3. 参加中のユーザーが新しい部屋を作成する場合
   - ✓ 確認モーダルが表示される
   - ✓ 確認後、自動退出して新規作成される

4. 参加中のユーザーが他の部屋に参加する場合
   - ✓ 既存の確認ダイアログが表示される（実装済み）
   - ✓ forceJoinフラグで強制参加可能

## 今後の改善点

1. **設定の永続化**
   - 「この確認を今後省略する」オプションの実装
   - ユーザー設定として保存

2. **通知機能**
   - ホストが部屋を解散した際の通知
   - 参加者が退出した際の通知

3. **部屋状態の可視化**
   - ユーザープロフィールに現在の部屋状態を表示
   - ヘッダーに現在の部屋情報を表示

4. **パフォーマンス最適化**
   - room-statusのキャッシュ機能
   - WebSocketでのリアルタイム状態同期