# プロフィールタブ切り替えバグ修正

## 問題概要

プロフィール画面（マイページ・ユーザー画面）で「作成した部屋」「アクティビティ」「フォロワー」「フォロー中」タブをクリックした際に、コンテンツがレンダリングされずに空白になる問題が発生していました。

## 発生時期

フォロー機能実装時にテンプレートベースのレンダリングシステムに移行した後に発生。

## 症状

1. **初期表示は正常**: 「作成した部屋」タブが最初選択されており表示される
2. **タブ切り替えで空白**: 「アクティビティ」タブを選択すると何も表示されない
3. **再選択も機能しない**: 再度「作成した部屋」を選択しても何も表示されない
4. **HTTPリクエストは正常**: ネットワークタブでリクエストは200で成功している
5. **0バイトレスポンス**: サーバーログでは成功ログが出ているが、実際のレスポンスが0バイト

## 根本原因

### テンプレート名の不一致

`renderPartialTemplate()`関数は**テンプレート名**（`"profile_activity"`）を期待しているが、ProfileHandlerのメソッドから**ファイル名**（`"profile_activity.tmpl"`）が渡されていた。

#### 問題のあったコード例：

```go
// ❌ 間違い: ファイル名を渡していた
func (ph *ProfileHandler) Activity(w http.ResponseWriter, r *http.Request) {
    // ... データ取得処理 ...

    err = renderPartialTemplate(w, "profile_activity.tmpl", data)  // ❌ .tmplが不要
    if err != nil {
        http.Error(w, err.Error(), http.StatusInternalServerError)
        return
    }
}
```

#### `renderPartialTemplate()`関数の動作：

```go
func renderPartialTemplate(w http.ResponseWriter, templateName string, data interface{}) error {
    // templateNameに"profile_activity.tmpl"が渡される
    templateFileName := templateName + ".tmpl"  // "profile_activity.tmpl.tmpl"になってしまう
    templateFiles := []string{filepath.Join("templates", "components", templateFileName)}

    // 存在しないファイルを読み込もうとしてエラー
    tmpl, err := template.New("").Funcs(funcMap).ParseFiles(templateFiles...)
    // ...
}
```

## 修正内容

### 修正したファイル：`/internal/handlers/profile.go`

以下の4つのメソッドで、`renderPartialTemplate()`への引数を修正：

#### 1. Activity()メソッド（152行目）
```go
// ❌ 修正前
err = renderPartialTemplate(w, "profile_activity.tmpl", data)

// ✅ 修正後
err = renderPartialTemplate(w, "profile_activity", data)
```

#### 2. Following()メソッド（167行目）
```go
// ❌ 修正前
err = renderPartialTemplate(w, "profile_following.tmpl", nil)

// ✅ 修正後
err = renderPartialTemplate(w, "profile_following", nil)
```

#### 3. Followers()メソッド（177行目）
```go
// ❌ 修正前
err = renderPartialTemplate(w, "profile_followers.tmpl", nil)

// ✅ 修正後
err = renderPartialTemplate(w, "profile_followers", nil)
```

#### 4. Rooms()メソッド（200行目）
```go
// ❌ 修正前
err = renderPartialTemplate(w, "profile_rooms.tmpl", data)

// ✅ 修正後
err = renderPartialTemplate(w, "profile_rooms", data)
```

## なぜこのバグが見つけにくかったか

### 1. サーバーログでは成功と表示
- データベースクエリは正常に実行されていた
- HTTPステータスコードも200で返されていた
- DEBUGログでも「Template executed successfully」と表示

### 2. エラーハンドリングの問題
- `template.ParseFiles()`が存在しないファイルで失敗していたが、適切にエラーが伝播していなかった可能性
- 空のレスポンスが返されていても、HTTPステータスは200だった

### 3. 関数設計の曖昧さ
- `renderPartialTemplate()`関数の引数が「テンプレート名」なのか「ファイル名」なのかが不明確だった

## 今後の防止策

### 1. 関数の仕様明確化
```go
// renderPartialTemplate は部分テンプレート（コンポーネント）をレンダリングする関数
// templateName: テンプレート名（.tmpl拡張子は不要。例："profile_activity"）
func renderPartialTemplate(w http.ResponseWriter, templateName string, data interface{}) error
```

### 2. エラーハンドリングの強化
```go
func renderPartialTemplate(w http.ResponseWriter, templateName string, data interface{}) error {
    templateFileName := templateName + ".tmpl"
    templateFiles := []string{filepath.Join("templates", "components", templateFileName)}

    tmpl, err := template.New("").Funcs(funcMap).ParseFiles(templateFiles...)
    if err != nil {
        return fmt.Errorf("template parsing error for %s: %w", templateName, err)
    }

    // ... 以降の処理
}
```

### 3. テスト強化
- 各タブの動作確認を必須とする
- HTTPレスポンスのContent-Lengthも確認する
- 実際のHTMLコンテンツが返されているかを検証する

### 4. デバッグログの改善
```go
fmt.Printf("[DEBUG] renderPartialTemplate called with templateName: %s\n", templateName)
fmt.Printf("[DEBUG] Template files: %v\n", templateFiles)
fmt.Printf("[DEBUG] Response length: %d bytes\n", len(renderedHTML))
```

## 学んだ教訓

1. **関数の引数仕様は明確にする**: 「テンプレート名」と「ファイル名」を区別する
2. **エラーハンドリングを徹底する**: 空のレスポンスでも適切にエラーを検出する
3. **テンプレート変更時は全機能をテストする**: 一部の機能だけでなく、影響範囲全体を確認する
4. **デバッグログを活用する**: 成功ログだけでなく、実際のデータ量も記録する

## 関連ファイル

- `/internal/handlers/profile.go` - プロフィールハンドラー（修正対象）
- `/internal/handlers/handlers.go` - `renderPartialTemplate()`関数の定義
- `/templates/components/profile_*.tmpl` - 各タブのテンプレートファイル

## テスト結果

修正後、以下の動作が正常になったことを確認：

1. ✅ アクティビティタブの表示
2. ✅ フォロワータブの表示
3. ✅ フォロー中タブの表示
4. ✅ 作成した部屋タブの再表示
5. ✅ タブ間の切り替え動作

すべてのプロフィールタブが正常に動作するようになりました。