# 認証切れ時のフロントエンド処理

実装時間：約15分

## 実装概要
認証切れ時にフロントエンドでトークンとセッション情報を適切にクリアし、ヘッダーのユーザーアイコンを即座に非表示にする処理を実装しました。

## 背景・問題点
- サーバー側で認証エラー時にリダイレクト処理を実装したが、フロントエンド側で古いトークンが残っていた
- ヘッダーのユーザーアイコンが表示されたままになる問題があった
- 無効なセッション情報がクリアされていなかった

## 実装内容

### 1. htmx-auth.js の改善
#### HX-Redirectヘッダーの処理を追加
```javascript
document.body.addEventListener('htmx:beforeSwap', (evt) => {
  const xhr = evt.detail.xhr
  if (xhr) {
    const redirectUrl = xhr.getResponseHeader('HX-Redirect')
    if (redirectUrl) {
      // 認証関連のリダイレクトの場合はセッションをクリア
      if (redirectUrl.includes('/auth/login')) {
        clearAuthSession()
      }
      evt.detail.shouldSwap = false
      window.location.href = redirectUrl
    }
  }
})
```

#### 401エラー時の処理改善
```javascript
document.body.addEventListener('htmx:responseError', async (evt) => {
  if (evt.detail.xhr.status === 401) {
    // 認証エラー時はセッションをクリアしてリダイレクト
    await clearAuthSession()
    window.location.href = '/auth/login'
  }
})
```

#### clearAuthSession関数の実装
```javascript
async function clearAuthSession() {
  // クッキーを削除
  document.cookie = 'sb-access-token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT'
  
  // Supabaseセッションをクリア
  if (window.supabaseClient && window.supabaseClient.auth) {
    try {
      await window.supabaseClient.auth.signOut()
    } catch (error) {
      console.warn('Supabaseサインアウトエラー:', error)
    }
  }
  
  // Alpineストアをリセット
  if (window.Alpine && window.Alpine.store('auth')) {
    window.Alpine.store('auth').clearSession()
  }
}
```

### 2. auth-store.js の改善
#### clearSessionメソッドの追加
```javascript
clearSession() {
  // セッション情報をクリア
  this.session = null
  this.user = null
  this.error = null
  this.currentRoom = null
  this._currentRoomFetched = false
  this._currentRoomLoading = false
  
  // クッキーを削除
  document.cookie = 'sb-access-token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT'
}
```

## 技術的な工夫点

### 1. 包括的なクリーンアップ
- クッキー、Supabaseセッション、Alpineストアの全てをクリア
- 認証関連の全ての状態を確実にリセット

### 2. エラーハンドリング
- Supabaseのサインアウトでエラーが発生しても処理を継続
- 各種オブジェクトの存在チェックを実施

### 3. htmxとの統合
- `HX-Redirect`ヘッダーを適切に処理
- `htmx:beforeSwap`イベントでリダイレクトを検出
- 401エラー時の自動リダイレクト

## 効果
1. 認証エラー時にヘッダーのユーザーアイコンが即座に非表示になる
2. 無効なトークンが適切にクリーンアップされる
3. ユーザーが迷うことなくログイン画面に遷移できる
4. フロントエンドとバックエンドの認証状態が一致する

## 今後の改善点
- リダイレクト前のURL を保存し、再ログイン後に元のページに戻る機能
- オフライン時のエラーハンドリング
- セッション復元機能の検討