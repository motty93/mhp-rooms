# 認証エラー時のリダイレクト実装

実装時間：約20分

## 実装概要
認証エラー時に「認証が必要です」というエラーメッセージを表示する代わりに、ログイン画面にリダイレクトする機能を実装しました。

## 背景・問題点
- トークンの有効期限切れなどで認証が切れた場合、「認証が必要です」というメッセージが表示されるだけで、ユーザーが次のアクションを取りづらい状態でした
- 特にプロフィールページなどで、認証が切れた際の体験が良くありませんでした

## 実装内容

### 1. 認証ミドルウェアの改善 (`internal/middleware/auth.go`)
以下の場面で認証エラーが発生した際に、リダイレクト処理を追加しました：

- トークンが見つからない場合
- トークンが無効な場合
- 認証ヘッダー形式が無効な場合
- クレーム変換エラーの場合

各エラーハンドリングで以下の処理を実装：
```go
// htmxリクエストの場合はHX-Redirectヘッダーを使用
if r.Header.Get("HX-Request") == "true" {
    w.Header().Set("HX-Redirect", "/auth/login")
    w.WriteHeader(http.StatusUnauthorized)
    return
}
// 通常のリクエストの場合はリダイレクト
http.Redirect(w, r, "/auth/login", http.StatusFound)
return
```

### 2. プロファイルハンドラーの統一処理 (`internal/handlers/profile.go`)
- `EditForm`メソッド：認証エラー時のリダイレクト処理を追加
- `Rooms`メソッド：認証エラー時のリダイレクト処理を追加

## 技術的な工夫点

### htmxとの互換性
- htmxリクエストの場合は、`HX-Redirect`ヘッダーを使用して適切にリダイレクトを処理
- 通常のHTTPリクエストの場合は、標準的な`http.Redirect`を使用
- これにより、AJAXリクエストでも通常のページ遷移でも適切にリダイレクトが動作します

### 統一的なエラーハンドリング
- ミドルウェアレベルで認証エラーを統一的に処理
- 各ハンドラーでも同様の処理パターンを採用し、一貫性を保持

## 効果
- ユーザーが認証エラーに遭遇した際、自動的にログイン画面に遷移するため、次のアクションが明確になります
- トークンの有効期限切れなどの場合でも、ユーザーが迷わずに再認証できます
- UXが向上し、エラー時のユーザーの離脱を防ぐことができます

## 今後の改善点
- 他のハンドラー（auth.go、sse_token.go、room_messages.go）にも同様の処理を適用する必要があります
- リダイレクト先のURLをクエリパラメータで保持し、ログイン後に元のページに戻る機能の検討