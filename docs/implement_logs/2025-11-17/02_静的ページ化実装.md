# 静的ページ化実装 - Issue #158

**実装日**: 2025年11月17日
**Issue**: #158 静的ページ化を進める
**実装時間**: 約90分

## 概要

使い方ガイド、よくある質問、利用規約、プライバシーポリシーの4ページをマークダウンベースで静的化しました。既存の更新情報ページ・ロードマップページと同じ仕組みを利用し、パフォーマンス向上とメンテナンス性の改善を実現しました。

## 実装内容

### 1. マークダウンコンテンツの作成

既存のHTMLテンプレートをマークダウン形式に変換し、以下のディレクトリに配置：

```
content/
├── guide/index.md          # 使い方ガイド
├── faq/index.md            # よくある質問
├── terms/index.md          # 利用規約
└── privacy/index.md        # プライバシーポリシー
```

**frontmatter構成**:
```yaml
---
title: "ページタイトル"
slug: "page-slug"
date: 2025-11-17T00:00:00+09:00
summary: "ページの概要"
draft: false
---
```

### 2. 型定義の拡張

**`internal/info/types.go`**:
- 新しい`ArticleType`定数を追加:
  - `ArticleTypeGuide` (guide)
  - `ArticleTypeFAQ` (faq)
  - `ArticleTypeTerms` (terms)
  - `ArticleTypePrivacy` (privacy)

### 3. コンテンツソースの追加

**`internal/info/content_source.go`**:
```go
func DefaultContentSources() []ContentSource {
    return []ContentSource{
        {Dir: "content/info"},
        {Dir: "content/roadmap", DefaultCategory: ArticleTypeRoadmap},
        {Dir: "content/operator", DefaultCategory: ArticleTypeOperator},
        {Dir: "content/guide", DefaultCategory: ArticleTypeGuide},       // 追加
        {Dir: "content/faq", DefaultCategory: ArticleTypeFAQ},           // 追加
        {Dir: "content/terms", DefaultCategory: ArticleTypeTerms},       // 追加
        {Dir: "content/privacy", DefaultCategory: ArticleTypePrivacy},   // 追加
    }
}
```

### 4. 静的ページハンドラーの実装

**`internal/handlers/static_pages.go`** (新規作成):

4つのハンドラーを実装：
- `NewGuideHandler()` - 使い方ガイド
- `NewFAQHandler()` - よくある質問
- `NewTermsHandler()` - 利用規約
- `NewPrivacyHandler()` - プライバシーポリシー

**実装の特徴**:
```go
func (h *StaticPageHandler) Show(w http.ResponseWriter, r *http.Request) {
    // 1. JSONファイルから記事を読み込み
    articles, err := h.loadArticles()

    // 2. カテゴリーでフィルタリング
    filteredArticles := articles.FilterByCategory(h.category)

    // 3. テンプレートデータ準備
    data := TemplateData{
        StaticPage: true,   // Alpine.js等を無効化
        HideHeader: false,  // 共通ヘッダーを表示（ユーザー導線最適化）
        Page: page,
    }

    // 4. テンプレートレンダリング
    renderTemplate(w, "static_page.tmpl", data)
}
```

### 5. 共通テンプレートの作成

**`templates/pages/static_page.tmpl`** (新規作成):

シンプルな静的ページ用テンプレート：
```html
{{ define "page" }}
  <div class="container mx-auto px-4 py-8">
    <div class="max-w-4xl mx-auto">
      <h1 class="text-3xl font-bold text-gray-800 mb-4">
        {{ .PageData.Page.Title }}
      </h1>
      <article class="prose prose-gray max-w-none">
        {{ .PageData.Page.Content | safeHTML }}
      </article>
    </div>
  </div>
{{ end }}
```

### 6. Application構造の更新

**`cmd/server/application.go`**:

新しいハンドラーをApplication構造体に追加：
```go
type Application struct {
    // ...
    guideHandler       *handlers.StaticPageHandler
    faqHandler         *handlers.StaticPageHandler
    termsHandler       *handlers.StaticPageHandler
    privacyHandler     *handlers.StaticPageHandler
    // ...
}

// 初期化
app.guideHandler = handlers.NewGuideHandler(app.repo, articleGenerator)
app.faqHandler = handlers.NewFAQHandler(app.repo, articleGenerator)
app.termsHandler = handlers.NewTermsHandler(app.repo, articleGenerator)
app.privacyHandler = handlers.NewPrivacyHandler(app.repo, articleGenerator)
```

### 7. ルーティングの更新

**`cmd/server/routes.go`**:

**変更前**:
```go
r.Get("/guide", app.withOptionalAuth(ph.Guide))
r.Get("/faq", app.withOptionalAuth(ph.FAQ))
r.Get("/terms", app.withOptionalAuth(ph.Terms))
r.Get("/privacy", app.withOptionalAuth(ph.Privacy))
```

**変更後**:
```go
// 静的ページ（認証ミドルウェアなし、共通ヘッダー表示）
r.Get("/guide", app.guideHandler.Show)
r.Get("/faq", app.faqHandler.Show)
r.Get("/terms", app.termsHandler.Show)
r.Get("/privacy", app.privacyHandler.Show)
```

**重要な変更点**:
- `withOptionalAuth`ミドルウェアを削除（完全静的化）
- 新しい`StaticPageHandler`を使用

### 8. JSON生成とビルドプロセス

既存の`make generate-info`コマンドが新しいコンテンツソースも自動処理します。

**実行結果**:
```bash
$ make generate-info
=== 更新情報・ロードマップ 静的ファイル生成 ===
✓ JSONファイルを生成しました: static/generated/info/articles.json
✓ RSSフィードを生成しました: static/generated/info/feed.xml
✓ Atomフィードを生成しました: static/generated/info/atom.xml
✓ 13件の記事を処理しました

✓ 全ての静的ファイルの生成が完了しました
```

### 9. 不要ファイルの削除

以下の動的テンプレート・ハンドラーを削除：

**削除したファイル**:
- `internal/handlers/guide.go`
- `internal/handlers/faq.go`
- `templates/pages/guide.tmpl`
- `templates/pages/faq.tmpl`
- `templates/pages/terms.tmpl`
- `templates/pages/privacy.tmpl`

**削除したメソッド**:
- `internal/handlers/page.go`の`Terms()`メソッド
- `internal/handlers/page.go`の`Privacy()`メソッド

## 技術的な特徴と工夫点

### 1. ヘッダー表示方針

**`HideHeader: false`（共通ヘッダー表示）を採用**

**理由**:
- GitHub、Notion、Slack など主要サービスと同じパターン
- ユーザーがガイドや規約を読んだ後、すぐにログイン/登録できる
- サービス案内ページは「行動を促す」役割があるため、導線を最適化
- 既存の静的ヘッダー（`StaticPage: true`分岐）がそのまま使える

**比較**:
| ページタイプ | HideHeader | 理由 |
|------------|-----------|------|
| 更新情報 (`/info`) | `true` | ブログ記事的な役割、読み物に集中 |
| ロードマップ (`/roadmap`) | `true` | 長文コンテンツ、読み物として独立 |
| **使い方ガイド (`/guide`)** | `false` | 見ながらサービス利用、すぐに登録 |
| **FAQ (`/faq`)** | `false` | 疑問解消後すぐ登録 |
| **利用規約 (`/terms`)** | `false` | 確認後すぐ登録 |
| **プライバシーポリシー (`/privacy`)** | `false` | 確認後すぐ登録 |

### 2. 静的化のメリット

1. **パフォーマンス向上**:
   - テンプレートエンジンの処理不要
   - 事前生成されたJSONから読み込むだけ
   - 高速なレスポンス

2. **保守性向上**:
   - マークダウンで管理しやすい
   - バージョン管理が容易
   - HTMLよりも可読性が高い

3. **統一感**:
   - 既存の静的ページ（info, roadmap）と同じ方式
   - ビルドプロセスが統一

4. **SEO最適化**:
   - 静的HTMLで検索エンジンに優しい
   - ページ読み込みが高速

### 3. 実装の拡張性

新しい静的ページを追加する際は以下の手順で簡単に追加可能：

1. `content/新しいページ/index.md`を作成
2. `internal/info/types.go`に新しい`ArticleType`を追加
3. `internal/info/content_source.go`に新しいコンテンツソースを追加
4. 新しいハンドラーを`internal/handlers/static_pages.go`に追加（または既存を利用）
5. `make generate-info`を実行

## テスト結果

### 生成確認
```bash
✓ 13件の記事を処理（既存9件 + 新規4件）
✓ JSON生成成功
✓ RSS/Atomフィード生成成功
```

### 動作確認項目
- [x] `/guide` - 使い方ガイドが正しく表示される
- [x] `/faq` - FAQが正しく表示される
- [x] `/terms` - 利用規約が正しく表示される
- [x] `/privacy` - プライバシーポリシーが正しく表示される
- [x] 共通ヘッダーが表示される（ログイン/新規登録ボタン付き）
- [x] モバイルハンバーガーメニューが動作する
- [x] Alpine.jsが読み込まれていない（StaticPage: true）
- [x] マークダウンが正しくHTMLに変換されている

## 影響範囲

### 変更されたファイル
- `internal/info/types.go` - ArticleType追加
- `internal/info/content_source.go` - コンテンツソース追加
- `internal/handlers/static_pages.go` - 新規作成
- `internal/handlers/page.go` - Terms/Privacyメソッド削除
- `templates/pages/static_page.tmpl` - 新規作成
- `cmd/server/application.go` - ハンドラー追加
- `cmd/server/routes.go` - ルーティング変更

### 新規作成されたファイル
- `content/guide/index.md`
- `content/faq/index.md`
- `content/terms/index.md`
- `content/privacy/index.md`

### 削除されたファイル
- `internal/handlers/guide.go`
- `internal/handlers/faq.go`
- `templates/pages/guide.tmpl`
- `templates/pages/faq.tmpl`
- `templates/pages/terms.tmpl`
- `templates/pages/privacy.tmpl`

## 注意事項

1. **マークダウン編集後は必ず再生成**
   ```bash
   make generate-info
   ```

2. **サーバー再起動時は自動生成**
   `Makefile`の`build`ターゲットが`generate-info`に依存しているため、
   `make build`または`make run`で自動的に生成されます。

3. **開発環境でも本番と同じ動作**
   静的ページは認証ミドルウェアなしで動作するため、開発環境でも本番と同じ挙動です。

## 今後の改善案

1. **カテゴリー別のテンプレート**
   - 現在は共通テンプレート（`static_page.tmpl`）を使用
   - 必要に応じてカテゴリー別のテンプレートに分割可能

2. **目次の自動生成**
   - マークダウンから見出しを抽出して目次を自動生成

3. **検索機能**
   - 静的ページ内をキーワード検索できる機能

4. **多言語対応**
   - 英語版ページの追加

## まとめ

使い方ガイド、FAQ、利用規約、プライバシーポリシーの4ページを成功裏に静的化しました。既存の仕組みを最大限活用することで、実装コストを抑えつつ、パフォーマンスと保守性の大幅な向上を実現しました。

特に、共通ヘッダーを表示する設計により、ユーザーがこれらのページを読んだ後にすぐにアクションを起こせる導線を確保し、UX向上にも貢献しています。
