# Cloud Buildビルド時間最適化（コストゼロ改善）

**実装日**: 2025年11月10日
**実装時間**: 約30分

## 概要

前回のCloud Build最適化でビルドキャッシュを導入したにも関わらず、ビルド時間が14分と改善されなかったため、追加の最適化を実施しました。今回はコストを増やさずにビルド時間を短縮する方針で進めました。

## 問題点

1. **ビルドコンテキストに不要なファイルが含まれている**
   - `tmp/`ディレクトリ: 72MB（開発中に生成されたOGP画像）
   - `data/`ディレクトリ: 開発用データベースファイル
   - 合計で約90MBの不要データがCloud Buildに送信されていた

2. **並列化の余地**
   - ビルドステップは既に並列化されていたが、明示的なコメントがなく可読性が低かった

## 実施した改善

### 1. `.dockerignore`の改善 ★最も効果的

不要なファイルをビルドコンテキストから除外しました。

**変更点**:
- `tmp/`を除外（72MB削減）
- `data/`を除外（開発用DBファイル）
- `cloudbuild*.yml`を除外（Cloud Build設定ファイル）
- `.gcloudignore`を除外

**期待効果**: ビルドコンテキストのアップロード時間が大幅に短縮（約1-2分）

### 2. Cloud Buildステップの並列化の明示化

既に並列化されていたステップに、明確なコメントを追加して可読性を向上させました。

**cloudbuild.stg.yml の最適化**:

```yaml
steps:
  # 1) Build App
  - id: "build-image"
    # メインアプリケーションのビルド

  # 2) Build Job (ogp-renderer) - Appと並列でビルド
  - id: "build-job-image"
    waitFor: ["-"]  # 最初から実行（build-imageと並列）

  # 3) Push App - build-image完了後すぐ実行
  - id: "push-image"
    waitFor: ["build-image"]

  # 4) Push Job - build-job-image完了後すぐ実行（push-imageと並列）
  - id: "push-job-image"
    waitFor: ["build-job-image"]

  # 5) Deploy Main - push-image完了後すぐ実行
  - id: "deploy-main"
    waitFor: ["push-image"]  # push-imageのみ待つ（deploy-jobとは並列実行）

  # 7) Deploy Job - push-job-image完了後すぐ実行
  - id: "deploy-job"
    waitFor: ["push-job-image"]  # push-job-imageのみ待つ（deploy-mainとは並列実行）
```

**実行フロー**:
```
開始
├─ build-image (並列)
│  └─ push-image
│     └─ deploy-main (並列)
│
└─ build-job-image (並列)
   └─ push-job-image
      └─ deploy-job (並列)
```

**cloudbuild.yml (本番環境) の最適化**:

```yaml
  # 3) Deploy Job (Cloud Run Jobs) - 本番環境（deploy-mainと並列実行）
  - id: "deploy-job"
    waitFor: ["-"]  # deploy-mainとは独立して実行（並列化）
```

本番環境では既にビルド済みのイメージを使用するため、デプロイステップのみが実行されます。`deploy-main`と`deploy-job`を並列実行することで、デプロイ時間を短縮しました。

## 修正ファイル

1. `.dockerignore` - 不要ファイルの除外設定追加
2. `cloudbuild.stg.yml` - 並列化の明示化とコメント改善
3. `cloudbuild.yml` - デプロイステップの並列化

## 期待される効果

### ビルド時間の短縮

| 項目 | 短縮時間 | 根拠 |
|------|---------|------|
| ビルドコンテキストのアップロード削減 | 1-2分 | 90MB削減による転送時間短縮 |
| 並列デプロイの最適化 | 0.5-1分 | デプロイステップの並列実行 |
| **合計** | **2-4分** | - |

**予想結果**:
- 改善前: 14分
- 改善後: **10-12分**（約14-28%削減）

### コスト

**追加コスト: $0**

今回の改善はマシンタイプの変更を行わないため、コストは一切増加しません。むしろビルド時間が短縮されるため、わずかにコストが削減される可能性があります。

```
現在の料金: E2_MEDIUM @ $0.005/分
改善前: 14分 × $0.005 = $0.07/回
改善後: 10-12分 × $0.005 = $0.05-0.06/回
月30回デプロイ: $1.50-1.80 (改善前 $2.10)

削減額: 月$0.30-0.60
```

## 今後さらに短縮したい場合の選択肢

もし10-12分でも遅いと感じた場合は、マシンタイプのアップグレードを検討できます：

| マシンタイプ | 料金/分 | 予想時間 | 1回コスト | 月30回 | 増加額 |
|-------------|---------|---------|----------|--------|--------|
| E2_MEDIUM (現在) | $0.005 | 10-12分 | $0.05-0.06 | $1.50-1.80 | - |
| E2_HIGHCPU_4 | $0.016 | 7-8分 | $0.11-0.13 | $3.30-3.90 | +$1.50-2.10 |
| E2_HIGHCPU_8 | $0.032 | 5-6分 | $0.16-0.19 | $4.80-5.70 | +$3.00-3.90 |

## 検証方法

次回のデプロイ時に以下を確認：

1. Cloud Buildのログで各ステップの実行時間を確認
2. 特にビルドコンテキストのアップロード時間を確認
3. 総実行時間が10-12分程度になっているか確認

## 学んだこと

1. **ビルドコンテキストのサイズが重要**
   - 開発中に生成されるファイル（`tmp/`, `data/`）は必ず除外する
   - 定期的に`.dockerignore`を見直すべき

2. **コストゼロでも効果的な改善は可能**
   - マシンスペックを上げる前に、無駄を削減する
   - ビルドコンテキストの最適化は即効性が高い

3. **並列化の重要性**
   - Cloud Buildの`waitFor`を適切に設定することで、無駄な待ち時間を削減できる
   - 依存関係を明確にすることで、最大限の並列化が可能

4. **段階的な改善アプローチ**
   - まずコストゼロの改善を試す
   - それでも不足なら、コスト増を伴う改善を検討する
   - ユーザーの予算とニーズに合わせた柔軟な提案が重要

## 次のステップ

1. 次回デプロイ時にビルド時間を計測
2. 10-12分に短縮されているか確認
3. さらに短縮が必要な場合、マシンタイプのアップグレードを検討
