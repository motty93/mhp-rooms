# ゲームバージョン別プレイヤーネーム機能

**実装期間**: 約45分（開始: 2025-06-25 01:10 - 完了: 2025-06-25 01:55）

## 実装概要

ユーザーがゲームバージョン（MHP、MHP2、MHP2G、MHP3）ごとに異なるプレイヤーネームを設定できる機能を実装しました。従来の統一プレイヤーネーム制から、より柔軟なゲーム別プレイヤーネーム管理システムに変更されました。

## 実装内容

### 1. データベース設計の変更

#### 新しいテーブル: player_names

```sql
CREATE TABLE "player_names" (
  "id" uuid DEFAULT gen_random_uuid(),
  "user_id" uuid NOT NULL,
  "game_version" varchar(10) NOT NULL,
  "player_name" varchar(100) NOT NULL,
  "created_at" timestamptz,
  "updated_at" timestamptz,
  PRIMARY KEY ("id"),
  CONSTRAINT "fk_users_player_names" FOREIGN KEY ("user_id") REFERENCES "users"("id")
);
```

#### インデックスと制約
- ユニークインデックス: `idx_player_names_unique (user_id, game_version)`
- 検索用インデックス: `idx_player_names_user_id_game_version`
- 外部キー制約: user_idでusersテーブルと関連付け

#### モデル定義
```go
type PlayerName struct {
    ID          uuid.UUID `gorm:"type:uuid;primary_key;default:gen_random_uuid()"`
    UserID      uuid.UUID `gorm:"type:uuid;not null;index"`
    GameVersion string    `gorm:"type:varchar(10);not null"` // MHP, MHP2, MHP2G, MHP3
    PlayerName  string    `gorm:"type:varchar(100);not null"`
    CreatedAt   time.Time
    UpdatedAt   time.Time
    User        User      `gorm:"foreignKey:UserID"`
}
```

### 2. リレーション更新

Userモデルに新しいリレーションを追加：
```go
PlayerNames []PlayerName `gorm:"foreignKey:UserID" json:"player_names,omitempty"`
```

### 3. 新規登録フォームの修正

新規登録時のプレイヤーネーム入力フィールドを削除し、ゲームバージョン別に設定する方式に変更：

- HTMLフォームからプレイヤーネーム入力欄を削除
- JavaScriptのフォームデータからplayerNameフィールドを削除
- バリデーション処理からplayerName関連を削除

## 技術的な特徴

### ユニーク制約による整合性担保
- `(user_id, game_version)` の組み合わせでユニーク制約を設定
- 1ユーザーが1ゲームバージョンに対して複数のプレイヤーネームを持つことを防止

### 柔軟な設計
- ゲームバージョンは文字列で管理（MHP、MHP2、MHP2G、MHP3）
- 将来的な新ゲームバージョン追加に対応可能
- プレイヤーネームは100文字まで対応

### 段階的移行対応
- 既存のユーザーデータに影響を与えない設計
- 新しいplayer_namesテーブルは独立して動作
- 既存のdisplay_nameは維持

## 注意点

### 今後の対応が必要な項目

1. **プレイヤーネーム設定UI**: ユーザーがゲームバージョン別にプレイヤーネームを設定するUIが必要
2. **デフォルト値処理**: プレイヤーネームが未設定の場合のフォールバック処理
3. **ルーム表示ロジック**: ルーム一覧でゲームバージョンに応じたプレイヤーネームを表示する処理
4. **既存データ移行**: 既存ユーザーのdisplay_nameをplayer_namesテーブルに移行する処理

### セキュリティ考慮事項
- プレイヤーネームの入力値検証が必要
- 不適切な名前のフィルタリング機能の検討

## マイグレーション結果

- player_namesテーブルが正常に作成されました
- 外部キー制約とインデックスが適用されました
- 既存のテーブル構造への影響はありませんでした

## 今後の拡張予定

1. ユーザー設定画面でのプレイヤーネーム管理機能
2. ルーム作成・参加時のゲームバージョン別プレイヤーネーム表示
3. プレイヤーネーム履歴管理機能（将来的）
4. 重複プレイヤーネームのチェック機能

この実装により、ユーザーは各ゲームバージョンで異なるプレイヤーネームを使用できるようになり、より柔軟なアイデンティティ管理が可能になりました。