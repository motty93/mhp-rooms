# インフラストラクチャ層リファクタリング

実装時間: 30分

## 概要
`database`と`supabase`ディレクトリを`infrastructure`ディレクトリ配下に整理し、より明確なレイヤー構造にリファクタリングしました。

## 実装内容

### 1. ディレクトリ構造の変更

#### Before:
```
internal/
├── database/      # DB接続関連
├── supabase/      # 認証関連
├── handlers/
├── models/
└── repository/
```

#### After:
```
internal/
├── infrastructure/
│   ├── auth/
│   │   └── supabase/      # Supabase認証
│   └── persistence/
│       └── postgres/      # PostgreSQL接続
├── handlers/
├── models/
└── repository/
```

### 2. 主な変更点

#### ディレクトリ移動
- `internal/database` → `internal/infrastructure/persistence/postgres`
- `internal/supabase` → `internal/infrastructure/auth/supabase`

#### パッケージ名の変更
- `package database` → `package postgres`
- `package supabase` はそのまま維持

#### import文の更新
全ファイルのimport文を新しいパスに更新：
```go
// Before
import "mhp-rooms/internal/database"

// After
import "mhp-rooms/internal/infrastructure/persistence/postgres"
```

#### 型参照の更新
リポジトリファイルで使用していた型参照を更新：
```go
// Before
func NewUserRepository(db *database.DB) UserRepository

// After
func NewUserRepository(db *postgres.DB) UserRepository
```

### 3. Supabase APIの修正

Supabase Go SDKのAPIが変更されていたため、以下の修正を実施：

- `SignInWithPassword` → `SignInWithEmailPassword`
- `SignUp` → `Signup`
- `SignOut` → `Logout`
- `GetUser(token)` → `WithToken(token).GetUser()`

### 4. 影響範囲

更新したファイル：
- `cmd/server/main.go`
- `cmd/migrate/main.go`
- `cmd/seed/main.go`
- `internal/repository/*.go`
- `internal/handlers/auth.go`
- `internal/handlers/middleware.go`

## 工夫した点

1. **段階的な移行**: まずディレクトリを移動してから、import文を一括更新
2. **型安全性の維持**: 型参照をすべて正しく更新
3. **Supabase APIの互換性**: 最新のSDK APIに合わせて修正

## テスト結果

- ビルド成功: `go build -o bin/server cmd/server/main.go`
- エラーなし

## 今後の改善案

1. `infrastructure`層をさらに細分化（cache、messaging等）
2. インターフェースの定義を別パッケージに分離
3. 依存性注入パターンの強化