# Supabase-go認証実装

## 実装期間
2025年6月27日 00:00 - 00:30（約30分）

## 実装内容

MonHubにSupabase-goを使用した認証システムを実装しました。メールとパスワードによるログイン・新規登録、JWT トークンの管理、セッション管理、エラーハンドリングを含む完全な認証フローを構築しました。

### 実装ファイル

1. **Supabaseクライアント** (`internal/supabase/client.go`)
   - Supabaseクライアントの初期化
   - 環境変数からの設定読み込み
   - シングルトンパターンでクライアント管理

2. **認証ハンドラーの更新** (`internal/handlers/auth.go`)
   - **ログイン処理**: Supabase AuthのSignInWithPasswordを使用
   - **新規登録処理**: Supabase AuthのSignUpを使用
   - **ログアウト処理**: SignOutとクッキーの削除
   - JWTトークンをHttpOnlyクッキーに保存（セキュリティ向上）

3. **認証ミドルウェア** (`internal/handlers/middleware.go`)
   - JWTトークンの検証
   - AuthorizationヘッダーとCookieの両方に対応
   - ユーザー情報のコンテキスト保存
   - 既存コードとの互換性維持

4. **Handler構造体の更新** (`internal/handlers/handlers.go`)
   - Supabaseクライアントを依存性注入で管理
   - テスタビリティの向上

5. **メインサーバーの更新** (`cmd/server/main.go`)
   - Supabaseクライアントの初期化
   - ログアウトエンドポイントの追加

6. **テストコード** (`internal/handlers/auth_test.go`)
   - ログイン・新規登録のテストケース
   - バリデーションのテスト
   - モック化の準備

### 主な特徴

1. **セキュリティ**
   - JWTトークンをHttpOnlyクッキーに保存（XSS対策）
   - SameSite属性でCSRF対策
   - パスワードの最小長チェック（6文字以上）

2. **ユーザー体験**
   - 「記憶する」オプションで30日間のセッション維持
   - 詳細なエラーメッセージ
   - 既存ユーザーチェック

3. **データ同期**
   - Supabase AuthとローカルDBの自動同期
   - SupabaseUserIDでの紐付け管理
   - プロフィール情報の保存

4. **エラーハンドリング**
   - 適切なHTTPステータスコード
   - 日本語でのエラーメッセージ
   - ログ出力での問題追跡

### 環境変数

`.env.example`に以下を追加：
```env
# Supabase設定
SUPABASE_URL=your_supabase_project_url
SUPABASE_ANON_KEY=your_supabase_anon_key
```

### 認証フロー

1. **新規登録**
   - メール/パスワード/PSN ID/プレイヤー名を受け取る
   - Supabase Authでユーザー作成
   - ローカルDBにユーザー情報保存
   - メール認証の案内を表示

2. **ログイン**
   - メール/パスワードで認証
   - JWTトークンをクッキーに保存
   - ローカルDBユーザーと同期
   - ユーザー情報を返却

3. **認証チェック**
   - ミドルウェアでトークン検証
   - ユーザー情報をコンテキストに保存
   - 保護されたルートへのアクセス制御

4. **ログアウト**
   - Supabaseセッション無効化
   - クッキー削除
   - クライアント側の状態リセット

### 今後の改善案

1. **ソーシャルログイン**: Google/Twitter認証の追加
2. **メール認証**: 確認メール送信とフロー実装
3. **パスワードリセット**: 既存の実装とSupabaseの統合
4. **リフレッシュトークン**: 自動更新の実装
5. **レート制限**: 認証エンドポイントの保護

## まとめ

Supabase-goを使用した堅牢な認証システムを実装しました。セキュリティを重視しつつ、既存のコードベースとの互換性を保ち、将来の拡張にも対応できる設計になっています。