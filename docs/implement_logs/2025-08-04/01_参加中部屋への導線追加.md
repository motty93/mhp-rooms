# 参加中部屋への導線追加

**実装開始**: 2025-08-04 00:30  
**実装完了**: 2025-08-04 00:44  
**所要時間**: 約14分

## 概要

ユーザーが現在参加している部屋への導線を増やす機能を実装しました。PCヘッダーのユーザーアイコンドロップダウンメニューとモバイルハンバーガーメニューに「参加中の部屋」へのリンクを追加しました。

## 実装内容

### 1. APIエンドポイントの作成

**ファイル**: `internal/handlers/rooms.go`

```go
// GetCurrentRoom 現在参加中の部屋を取得するAPIエンドポイント
func (h *RoomHandler) GetCurrentRoom(w http.ResponseWriter, r *http.Request) {
    // 認証情報からユーザーIDを取得
    dbUser, exists := middleware.GetDBUserFromContext(r.Context())
    if !exists || dbUser == nil {
        http.Error(w, "認証されていないか、ユーザー情報が見つかりません", http.StatusUnauthorized)
        return
    }
    
    userID := dbUser.ID
    
    // 現在参加しているアクティブな部屋を検索
    activeRoom, err := h.repo.Room.FindActiveRoomByUserID(userID)
    if err != nil {
        // 参加中の部屋がない場合
        w.Header().Set("Content-Type", "application/json")
        w.WriteHeader(http.StatusOK)
        w.Write([]byte(`{"current_room": null}`))
        return
    }
    
    // 部屋情報をレスポンス用に整形
    roomData := map[string]interface{}{
        "id":               activeRoom.ID,
        "room_code":        activeRoom.RoomCode,
        "name":             activeRoom.Name,
        "description":      activeRoom.Description,
        "game_version_id":  activeRoom.GameVersionID,
        "max_players":      activeRoom.MaxPlayers,
        "current_players":  activeRoom.CurrentPlayers,
        "is_closed":        activeRoom.IsClosed,
        "has_password":     activeRoom.HasPassword(),
        "created_at":       activeRoom.CreatedAt,
    }
    
    response := map[string]interface{}{
        "current_room": roomData,
    }
    
    w.Header().Set("Content-Type", "application/json")
    w.WriteHeader(http.StatusOK)
    json.NewEncoder(w).Encode(response)
}
```

### 2. ルートの追加

**ファイル**: `cmd/server/routes.go`

```go
// 認証必須のAPIエンドポイント
apiRoutes.HandleFunc("/user/current-room", app.authMiddleware.Middleware(http.HandlerFunc(app.roomHandler.GetCurrentRoom)).ServeHTTP).Methods("GET")
```

### 3. PCヘッダーメニューの修正

**ファイル**: `templates/components/header.tmpl`

```html
<div
  class="relative hidden md:block"
  x-show="$store.auth.initialized && !$store.auth.loading && $store.auth.isAuthenticated"
  x-data="{ open: false, currentRoom: null }"
  x-init="
    // 参加中の部屋情報を取得
    $watch('$store.auth.isAuthenticated', (isAuth) => {
      if (isAuth) {
        fetch('/api/user/current-room', { credentials: 'same-origin' })
          .then(response => response.json())
          .then(data => {
            currentRoom = data.current_room;
          })
          .catch(error => {
            console.log('参加中の部屋の取得に失敗:', error);
            currentRoom = null;
          });
      } else {
        currentRoom = null;
      }
    });
  "
  x-cloak
>
```

ドロップダウンメニュー内に参加中部屋のリンクを追加：

```html
<!-- 参加中の部屋 -->
<template x-if="currentRoom">
  <a
    :href="'/rooms/' + currentRoom.id"
    class="block px-4 py-2 text-sm text-blue-600 hover:bg-blue-50 transition-colors border-l-2 border-blue-500"
    @click="open = false"
  >
    <div class="flex items-center space-x-2">
      <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
      </svg>
      <span x-text="'参加中: ' + currentRoom.name"></span>
    </div>
  </a>
</template>
```

### 4. モバイルメニューの修正

**ファイル**: `templates/layouts/base.tmpl`

```html
<!-- 認証済み時のメニュー -->
<div
  x-show="$store.auth.initialized && !$store.auth.loading && $store.auth.isAuthenticated"
  x-data="{ currentRoom: null }"
  x-init="
    // 参加中の部屋情報を取得
    $watch('$store.auth.isAuthenticated', (isAuth) => {
      if (isAuth) {
        fetch('/api/user/current-room', { credentials: 'same-origin' })
          .then(response => response.json())
          .then(data => {
            currentRoom = data.current_room;
          })
          .catch(error => {
            console.log('参加中の部屋の取得に失敗:', error);
            currentRoom = null;
          });
      } else {
        currentRoom = null;
      }
    });
  "
  style="display: none;"
>
```

モバイルメニュー内に参加中部屋のリンクを追加：

```html
<!-- 参加中の部屋 -->
<template x-if="currentRoom">
  <a
    :href="'/rooms/' + currentRoom.id"
    @click="$store.mobileMenu.close()"
    class="block px-4 py-3 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors border-l-4 border-blue-500"
  >
    <div class="flex items-center space-x-2">
      <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
      </svg>
      <div>
        <div class="font-medium" x-text="'参加中の部屋'"></div>
        <div class="text-sm opacity-75" x-text="currentRoom.name"></div>
      </div>
    </div>
  </a>
</template>
```

### 5. 認証ミドルウェアの修正

**ファイル**: `internal/middleware/auth.go`

APIエンドポイントでクッキーベース認証が動作しない問題を修正：

```go
} else {
    // Authorizationヘッダーがない場合、クエリパラメータのtokenを確認（SSE用）
    tokenString = r.URL.Query().Get("token")
    if tokenString == "" {
        // クエリパラメータにもない場合、クッキーを確認（ブラウザからのAJAX用）
        if cookie, err := r.Cookie("sb-access-token"); err == nil {
            tokenString = cookie.Value
            if config.AppConfig.Debug.AuthLogs {
                log.Printf("AUTH DEBUG: %s %s - クッキーからトークンを取得", r.Method, r.URL.Path)
            }
        }
    } else {
        if config.AppConfig.Debug.AuthLogs {
            log.Printf("AUTH DEBUG: %s %s - クエリパラメータからトークンを取得", r.Method, r.URL.Path)
        }
    }
    
    if tokenString == "" {
        if config.AppConfig.Debug.AuthLogs {
            log.Printf("AUTH DEBUG: %s %s - 認証トークンが見つかりません", r.Method, r.URL.Path)
        }
        http.Error(w, "認証が必要です", http.StatusUnauthorized)
        return
    }
}
```

## 特に注意した点・工夫した点

1. **認証処理の統一**: APIエンドポイントとページレンダリングで一貫した認証処理を実装
2. **エラーハンドリング**: 参加中の部屋がない場合も適切にハンドリング
3. **UI/UX配慮**: 参加中の部屋は他のメニューアイテムと視覚的に区別
4. **レスポンシブ対応**: PCとモバイルで異なるレイアウトに対応
5. **クッキーベース認証**: ブラウザからのAJAXリクエストでクッキー認証を使用

## テスト結果・動作確認

### APIエンドポイントのテスト
```bash
curl -H "Cookie: sb-access-token=<token>" http://localhost:8080/api/user/current-room
# レスポンス: {"current_room":{"id":"e6dd4ae6-7ff2-4e03-a5f3-316ad6f7b2ae","name":"初心者歓迎部屋",...}}
```

### ブラウザでの動作確認
- **PCヘッダー**: ユーザーアイコンクリック時に「参加中: 初心者歓迎部屋」メニューが表示される
- **モバイルメニュー**: ハンバーガーメニューに「参加中の部屋 初心者歓迎部屋」が表示される
- **リンク動作**: どちらも正常に部屋詳細ページに遷移する

## 影響を受ける既存コード

- `internal/handlers/rooms.go`: 新しいハンドラー追加
- `cmd/server/routes.go`: 新しいルート追加
- `templates/components/header.tmpl`: ドロップダウンメニュー拡張
- `templates/layouts/base.tmpl`: モバイルメニュー拡張
- `internal/middleware/auth.go`: クッキー認証サポート追加

## 今後の課題・改善点

1. **キャッシュ機能**: 頻繁なAPI呼び出しを避けるためのクライアントサイドキャッシュ
2. **リアルタイム更新**: WebSocketを使った参加状態のリアルタイム更新
3. **パフォーマンス最適化**: 部屋情報取得の最適化
4. **アクセシビリティ**: スクリーンリーダー対応の改善

## 関連する既存機能

- ユーザー認証システム (`internal/middleware/auth.go`)
- 部屋管理機能 (`internal/repository/room_repository.go`)
- ヘッダーコンポーネント (`templates/components/header.tmpl`)
- モバイルメニュー (`templates/layouts/base.tmpl`)

## 実装時間の内訳

- 要件確認・設計: 2分
- APIエンドポイント実装: 3分
- UI修正（PCヘッダー）: 3分
- UI修正（モバイルメニュー）: 2分
- 認証エラー調査・修正: 3分
- 動作確認・テスト: 1分

**総実装時間**: 14分