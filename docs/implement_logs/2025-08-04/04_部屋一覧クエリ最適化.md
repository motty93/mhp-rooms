# 部屋一覧クエリ最適化

## 実装開始時刻
2025-08-04 (継続作業)

## 実装完了時刻
2025-08-04

## 概要
部屋一覧取得時のクエリ性能を最適化。複数クエリを1つに統合し、参加状態チェックを効率化。

## 問題の特定
### 既存の問題点
1. **複数クエリ実行**: `GetActiveRoomsWithJoinStatus`で部屋一覧取得後、別途参加状態を取得
2. **N+1問題の潜在リスク**: 部屋数増加時にパフォーマンス劣化
3. **メモリ上でのソート**: 参加中部屋を先頭に移動する処理

### パフォーマンス影響
- ユーザーがアクセスするたびに2-3個のクエリが実行
- 認証ユーザーの場合、追加のJOINクエリが発行される

## 最適化内容

### 1. 単一クエリ化
**変更前**: 複数のクエリに分離
```go
// 1. 部屋一覧を取得
query := r.db.GetConn().Select("rooms.*, COUNT(DISTINCT rm.id) as current_players")...
// 2. 参加状態を別途取得
err = r.db.GetConn().Table("room_members").Select("room_id")...
```

**変更後**: 1つのSQLで全情報を取得
```sql
SELECT 
    rooms.*,
    gv.name as game_version_name,
    gv.code as game_version_code,
    u.display_name as host_display_name,
    u.psn_online_id as host_psn_online_id,
    COUNT(DISTINCT rm_all.id) as current_players,
    CASE WHEN rm_user.id IS NOT NULL THEN true ELSE false END as is_joined
FROM rooms
LEFT JOIN game_versions gv ON rooms.game_version_id = gv.id
LEFT JOIN users u ON rooms.host_user_id = u.id
LEFT JOIN room_members rm_all ON rooms.id = rm_all.room_id AND rm_all.status = 'active'
LEFT JOIN room_members rm_user ON rooms.id = rm_user.room_id AND rm_user.user_id = ? AND rm_user.status = 'active'
WHERE rooms.is_active = true
GROUP BY rooms.id, gv.id, u.id, rm_user.id
ORDER BY 
    CASE WHEN rm_user.id IS NOT NULL THEN 0 ELSE 1 END,
    rooms.created_at DESC
```

### 2. データベースレベルでのソート
- SQLの`ORDER BY`で参加中の部屋を優先
- メモリ上でのソート処理を削除

### 3. 関連データの事前取得
- GameVersionとHostの情報を同一クエリで取得
- 追加のPreloadクエリを削減

## 技術的な改善点

### クエリ最適化
- **実行クエリ数**: 3個 → 1個に削減
- **JOIN最適化**: LEFT JOINを使用してNULL対応
- **GROUP BY最適化**: 必要な列のみをグループ化

### メモリ使用量削減
- 参加状態マップの作成を削除
- 配列の再構築処理を削除

## パフォーマンス改善予想

### クエリ実行回数
- **Before**: 認証ユーザー時 2-3回のクエリ
- **After**: 1回のクエリのみ

### 応答時間
- **データベース往復**: 66-75%削減
- **メモリ処理**: ソート処理削除で高速化

## 動作確認
✅ ビルド成功 (`go build`)
✅ フォーマット適用済み (`go fmt`)

## 今後の監視ポイント
1. **実際のクエリ実行時間**: ログで確認
2. **部屋数増加時の性能**: スケーラビリティテスト
3. **複雑なJOINの負荷**: データベース負荷監視

## 関連ファイル
- `internal/repository/room_repository.go`: `GetActiveRoomsWithJoinStatus`メソッド最適化
- `internal/handlers/rooms.go`: 呼び出し側は変更なし（互換性維持）

## 備考
- 既存のAPI互換性を維持
- 未認証ユーザーの処理は従来通り
- エラーハンドリングは既存と同等レベルを維持