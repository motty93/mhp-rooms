# 部屋参加リンク認証後リダイレクト問題修正

**実装開始**: 2025-11-16
**実装完了**: 2025-11-16
**所要時間**: 約1時間
**関連issue**: #146

## 概要

部屋参加（join）リンクから認証した場合、認証完了後に部屋一覧に遷移してしまう問題を修正しました。認証後は元のjoin画面に正しくリダイレクトされるようになりました。

## 問題の詳細

### 問題1: ログイン済みユーザーの問題
- SNSからjoinリンクを踏むとログイン画面にリダイレクトされる
- クッキーの有効期限が1時間と短く、セッションが切れやすい

### 問題2: 未認証ユーザーの問題
- joinリンクから認証すると、認証完了後に部屋一覧（/rooms）に遷移してしまう
- 本来はjoin画面に戻るべき

## 根本原因

1. **Googleログイン時のリダイレクト先が固定**
   - `supabase.js`の`signInWithGoogle()`で`redirectTo`が`/auth/callback`固定

2. **認証コールバック後のリダイレクト先が固定**
   - `auth-callback.tmpl`で認証成功後、常に`/rooms`に遷移
   - redirect情報が失われていた

3. **クッキーの有効期限が短い**
   - `sb-access-token`のmax-ageが3600秒（1時間）だった

## 修正内容

### 1. ログインページ（templates/pages/login.tmpl）
```javascript
async handleGoogleLogin() {
  try {
    // 認証後のリダイレクト先をセッションストレージに保存
    sessionStorage.setItem('auth_redirect_url', this.redirectUrl)
    await Alpine.store('auth').signInWithGoogle()
  } catch (error) {
    console.error('Googleログインエラー:', error)
    this.errorMessage = error.message || 'Googleログインに失敗しました'
  }
},
```

**変更点**: Googleログインボタンクリック前に、`redirectUrl`をsessionStorageに保存

### 2. 新規登録ページ（templates/pages/register.tmpl）
**ハンドラー側（internal/handlers/auth.go）**:
```go
func (h *AuthHandler) RegisterPage(w http.ResponseWriter, r *http.Request) {
	redirectURL := r.URL.Query().Get("redirect")
	if redirectURL == "" {
		redirectURL = "/rooms"
	}

	data := TemplateData{
		Title: "新規登録",
		PageData: map[string]interface{}{
			"RedirectURL": redirectURL,
		},
	}
	renderTemplate(w, "register.tmpl", data)
}
```

**テンプレート側**:
```javascript
redirectUrl: '{{ if .PageData }}{{ index .PageData "RedirectURL" }}{{ else }}/rooms{{ end }}',
async handleGoogleRegister() {
  if (!this.agreedToTerms) {
    this.errorMessage = '利用規約に同意してください'
    return
  }
  try {
    // 認証後のリダイレクト先をセッションストレージに保存
    sessionStorage.setItem('auth_redirect_url', this.redirectUrl)
    await Alpine.store('auth').signInWithGoogle()
  } catch (error) {
    console.error('Google登録エラー:', error)
    this.errorMessage = error.message || 'Google登録に失敗しました'
  }
},
```

**変更点**:
- ハンドラーでredirectパラメータを処理してテンプレートに渡す
- Google登録前にredirectUrlをsessionStorageに保存

### 3. 認証コールバックページ（templates/pages/auth-callback.tmpl）
```javascript
if (data.session) {
  console.log('認証成功。セッション取得完了。')
  // アクセストークンをクッキーに保存（SSR用）
  const maxAge = 604800 // 7日間（変更前: 3600秒 = 1時間）
  document.cookie = `sb-access-token=${data.session.access_token}; path=/; max-age=${maxAge}; SameSite=Lax`
  console.log('認証クッキーを設定しました')

  // セッションストレージから元のリダイレクト先を取得
  const redirectUrl = sessionStorage.getItem('auth_redirect_url') || '/rooms'
  // セッションストレージをクリア
  sessionStorage.removeItem('auth_redirect_url')
  // リダイレクト
  console.log('認証成功。リダイレクト先:', redirectUrl)
  window.location.href = redirectUrl
}
```

**変更点**:
- クッキーの有効期限を1時間→7日間に延長
- sessionStorageから元のURLを取得してリダイレクト
- デフォルトは従来通り`/rooms`

## 実装の流れ

### ケース1: 未認証ユーザーがjoinリンクをクリック
1. ユーザーが `/rooms/xxx/join` をクリック
2. 未認証のため `/auth/login?redirect=/rooms/xxx/join` にリダイレクト
3. ログインページでredirectUrl（`/rooms/xxx/join`）をsessionStorageに保存
4. Googleログインをクリック
5. Supabase認証完了後 `/auth/callback` にリダイレクト
6. sessionStorageから元のURL（`/rooms/xxx/join`）を取得
7. **join画面に正しくリダイレクト** ✅

### ケース2: ログイン済みユーザーがjoinリンクをクリック
1. ユーザーが `/rooms/xxx/join` をクリック
2. クッキーが有効（7日間）なので、認証済みと判定
3. **そのままjoin画面が表示される** ✅

## テストケース

- [x] 未認証→joinリンク→ログイン→join画面表示
- [x] 未認証→joinリンク→新規登録→join画面表示
- [x] ログイン済み→joinリンク→join画面表示
- [x] 通常のログイン→部屋一覧表示（既存機能の確認）

### 4. 認証ミドルウェア（internal/middleware/auth.go）【追加修正】

**問題**: 古いトークン（有効期限切れ、署名無効）がクッキーに残っている場合、トークン検証に失敗してもクッキーが削除されず、同じエラーが繰り返し発生する。

**修正内容**: トークン検証失敗時に古いクッキーを削除

#### OptionalMiddleware（325-336行目）
```go
} else {
	http.SetCookie(w, &http.Cookie{
		Name:   "sb-access-token",
		Value:  "",
		Path:   "/",
		MaxAge: -1,
	})

	if config.AppConfig.Debug.AuthLogs {
		log.Printf("AUTH DEBUG: %s %s - トークン解析エラー（クッキー削除）: %v", r.Method, r.URL.Path, err)
	}
}
```

#### Middleware（189-207行目、209-228行目）
```go
// トークン解析エラー時
if err != nil || !token.Valid {
	http.SetCookie(w, &http.Cookie{
		Name:   "sb-access-token",
		Value:  "",
		Path:   "/",
		MaxAge: -1,
	})
	// ...
}

// クレーム変換エラー時
if !ok {
	http.SetCookie(w, &http.Cookie{
		Name:   "sb-access-token",
		Value:  "",
		Path:   "/",
		MaxAge: -1,
	})
	// ...
}
```

**効果**:
- 古いトークンが自動的にクリアされる
- 次回アクセス時は未認証として正しく処理される
- ユーザーは新しい認証フローを開始できる

## 修正ファイル一覧

1. `templates/pages/login.tmpl` - ログインページのJavaScript修正
2. `templates/pages/register.tmpl` - 新規登録ページのJavaScript修正
3. `templates/pages/auth-callback.tmpl` - 認証コールバックページの修正
4. `internal/handlers/auth.go` - RegisterPageメソッドの修正
5. `internal/middleware/auth.go` - トークン検証失敗時のクッキー削除処理追加

## 注意点・今後の課題

### セッションストレージの制限
- タブを閉じると情報が失われる（セッションストレージの仕様）
- ただし、認証フロー中にタブを閉じることは通常ないため、実用上は問題なし

### クッキー有効期限の延長
- セキュリティとのトレードオフ
- 7日間は一般的な設定値
- 必要に応じて調整可能

### 代替案（検討したが採用しなかった）
- **Supabase OAuth stateパラメータを使用**: より堅牢だが実装が複雑
- **サーバー側セッション**: サーバー側の変更が大きい

## まとめ

### 主な修正内容
1. **リダイレクト先の保持**: セッションストレージを使用してjoinリンクのURLを保持
2. **クッキー有効期限の延長**: 1時間→7日間に延長してセッション維持を改善
3. **古いトークンのクリア**: トークン検証失敗時に自動的にクッキーを削除

### 解決した問題
- ✅ joinリンクから認証後、正しくjoin画面にリダイレクトされる
- ✅ ログイン済みユーザーがjoinリンクをクリックしても、古いトークンが原因でログイン画面に飛ばされる問題を根本的に解決
- ✅ クッキー有効期限延長により、セッション維持が大幅に改善

既存のコードへの影響を最小限に抑えつつ、ユーザー体験を大幅に改善できました。
