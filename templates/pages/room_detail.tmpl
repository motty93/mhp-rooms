{{ define "room_detail_page" }}
  <div
    class="flex h-full md:flex-row flex-col mobile-room-detail"
    x-data="roomDetail()"
  >
    <!-- モバイル版ヘッダー（デスクトップでは非表示） -->
    <div
      class="md:hidden bg-white border-b border-gray-200 px-4 py-3 flex-shrink-0"
    >
      <div class="flex items-center space-x-3">
        <div
          class="w-10 h-10 {{ gameVersionColor .PageData.Room.GameVersion.Code }} rounded flex items-center justify-center flex-shrink-0"
        >
          <div
            class="w-6 h-6 flex items-center justify-center text-white text-xs font-bold"
          >
            {{ .PageData.Room.GameVersion.Code }}
          </div>
        </div>
        <button
          class="flex-1 text-left hover:bg-gray-50 py-1 px-2 rounded transition-colors"
          @click="$store.mobileMenu.toggle()"
        >
          <div class="text-gray-800 font-bold text-base">
            {{ if .PageData.Room.HasPassword }}🔑 {{ end }}{{ .PageData.Room.Name }}
          </div>
          <div class="text-gray-500 text-sm">
            参加者 {{ .PageData.MemberCount }}/4
          </div>
        </button>
        <!-- ハンバーガーメニューボタン -->
        <div class="md:hidden">
          <button
            @click="$store.mobileMenu.toggle()"
            x-show="!$store.mobileMenu.open"
            class="text-gray-600 hover:text-gray-800 p-2 relative z-[10000]"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 6h16M4 12h16M4 18h16"
              ></path>
            </svg>
          </button>
        </div>
      </div>
    </div>

    <!-- モバイルメニュー（部屋詳細ページ専用） -->
    <div class="md:hidden">
      <!-- オーバーレイ -->
      <div
        x-show="$store.mobileMenu.open"
        x-cloak
        @click="$store.mobileMenu.close()"
        class="fixed inset-0 bg-black bg-opacity-50 z-[9998]"
        x-transition:enter="transition-opacity ease-out duration-300"
        x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100"
        x-transition:leave="transition-opacity ease-in duration-200"
        x-transition:leave-start="opacity-100"
        x-transition:leave-end="opacity-0"
        style="display: none"
      ></div>

      <!-- モバイルメニューパネル -->
      <div
        x-show="$store.mobileMenu.open"
        x-cloak
        class="fixed top-0 right-0 h-full w-80 bg-white shadow-lg z-[9999] overflow-y-auto"
        x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="transform translate-x-full"
        x-transition:enter-end="transform translate-x-0"
        x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="transform translate-x-0"
        x-transition:leave-end="transform translate-x-full"
        style="display: none"
      >
        <!-- メニューヘッダー -->
        <div
          class="flex items-center justify-between p-6 border-b border-gray-200"
        >
          <div class="flex-1 min-w-0">
            <div class="flex items-center space-x-3 mb-2">
              <img src="/static/images/icon.png" alt="MonHub" class="w-8 h-8 flex-shrink-0" />
              <h2 class="text-xl font-bold text-gray-800 truncate">
                {{ if .PageData.Room.HasPassword }}🔑 {{ end }}{{ .PageData.Room.Name }}
              </h2>
            </div>
            <!-- 部屋詳細情報（モバイル版） -->
            <div class="text-sm text-gray-500 space-y-1">
              {{ if .PageData.Room.GetDescription }}
                <div class="text-xs">{{ .PageData.Room.GetDescription }}</div>
              {{ end }}
              <div class="flex flex-wrap gap-3 text-xs">
                {{ if .PageData.Room.GetTargetMonster }}
                  <span>🎯 {{ .PageData.Room.GetTargetMonster }}</span>
                {{ end }}
                {{ if .PageData.Room.GetRankRequirement }}
                  <span>🏆 {{ .PageData.Room.GetRankRequirement }}</span>
                {{ end }}
              </div>
            </div>
          </div>
          <button
            @click="$store.mobileMenu.close()"
            class="text-gray-500 hover:text-gray-700 flex-shrink-0 ml-3"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              ></path>
            </svg>
          </button>
        </div>

        <!-- メニュー内容 -->
        <div class="p-6 space-y-4">
          <!-- アクションボタン -->
          <div class="space-y-3" x-show="$store.auth.isAuthenticated">
            <!-- ホスト限定：部屋を編集ボタン -->
            <button
              x-show="isHost"
              @click="openSettingsModal(); $store.mobileMenu.close()"
              class="w-full flex items-center justify-center space-x-2 bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded font-medium transition-colors"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
              </svg>
              <span>部屋を編集</span>
            </button>

            <!-- ホストの場合：部屋を解散ボタン -->
            <button
              x-show="isHost"
              @click="dismissRoom(); $store.mobileMenu.close()"
              :disabled="isDismissing"
              class="w-full flex items-center justify-center space-x-2 bg-red-600 hover:bg-red-700 text-white py-3 px-4 rounded font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                />
              </svg>
              <span x-text="isDismissing ? '解散中...' : '部屋を解散'"></span>
            </button>

            <!-- 一般メンバーの場合：部屋を退出ボタン -->
            <button
              x-show="!isHost"
              @click="leaveRoom(); $store.mobileMenu.close()"
              :disabled="isLeaving"
              class="w-full flex items-center justify-center space-x-2 bg-red-600 hover:bg-red-700 text-white py-3 px-4 rounded font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
                />
              </svg>
              <span x-text="isLeaving ? '退出中...' : '部屋を退出'"></span>
            </button>

            <!-- 部屋一覧に戻るボタン -->
            <a
              href="/rooms"
              @click="$store.mobileMenu.close()"
              class="w-full flex items-center justify-center space-x-2 bg-gray-100 hover:bg-gray-200 text-gray-700 py-3 px-4 rounded border border-gray-300 font-medium transition-colors"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M10 19l-7-7m0 0l7-7m-7 7h18"
                />
              </svg>
              <span>部屋一覧に戻る</span>
            </a>
          </div>

          <!-- 未認証時のメッセージ -->
          <div class="text-center py-4" x-show="!$store.auth.isAuthenticated">
            <p class="text-gray-500 text-sm">ログインしてください</p>
          </div>
        </div>
      </div>
    </div>
    <!-- 左側パネル（デスクトップのみ表示） -->
    <div
      class="hidden md:flex w-96 h-full border-r border-gray-200 flex-col bg-white"
    >
      <!-- ヘッダー部分 -->
      <div
        class="bg-white border-b border-gray-200 px-4 py-3 min-h-0 flex-shrink-0"
      >
        <div class="flex items-center space-x-3 mb-2">
          <div
            class="w-12 h-12 {{ gameVersionColor .PageData.Room.GameVersion.Code }} rounded flex items-center justify-center flex-shrink-0"
          >
            <div
              class="w-8 h-8 flex items-center justify-center text-white text-sm font-bold"
            >
              {{ .PageData.Room.GameVersion.Code }}
            </div>
          </div>
          <div class="flex items-center justify-between">
            <div class="text-gray-800 font-bold text-lg">
              {{ if .PageData.Room.HasPassword }}🔑 {{ end }}{{ .PageData.Room.Name }}
            </div>
            <!-- PC版のみ：ホストの場合に設定アイコンを表示 -->
            <button 
              x-show="isHost && $store.auth.initialized && $store.auth.isAuthenticated"
              @click="openSettingsModal()"
              class="hidden md:block text-gray-600 hover:text-gray-800 p-1 rounded hover:bg-gray-100 transition-colors"
              title="部屋設定を変更"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                      d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                      d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
              </svg>
            </button>
          </div>
        </div>
        <div class="text-gray-600 text-sm leading-relaxed">
          <div x-show="!descriptionExpanded" class="overflow-hidden">
            <div class="max-h-10 overflow-hidden">
              {{ .PageData.Room.GetDescription }}
            </div>
            <button
              @click="descriptionExpanded = true"
              x-show="needsExpansion"
              class="text-gray-800 hover:text-gray-600 text-xs mt-1 underline"
            >
              続きを表示
            </button>
          </div>
          <div x-show="descriptionExpanded" x-cloak>
            {{ .PageData.Room.GetDescription }}
            <button
              @click="descriptionExpanded = false"
              class="text-gray-800 hover:text-gray-600 text-xs mt-1 underline block"
            >
              閉じる
            </button>
          </div>
        </div>

        <!-- 部屋の詳細情報 -->
        <div class="mt-3 text-sm text-gray-500 space-y-1">
          {{ $target := .PageData.Room.GetTargetMonster }}
          {{ if and $target (ne $target "<nil>") }}
            <div class="flex items-center">
              <span class="text-gray-400 mr-2">🎯</span>
              <span>ターゲット: {{ $target }}</span>
            </div>
          {{ end }}
          {{ $rank := .PageData.Room.GetRankRequirement }}
          {{ if and $rank (ne $rank "<nil>") }}
            <div class="flex items-center">
              <span class="text-gray-400 mr-2">🏆</span>
              <span>ランク: {{ $rank }}</span>
            </div>
          {{ end }}
        </div>
      </div>

      <!-- ユーザーリスト -->
      <div class="flex-1 px-4 pt-4 space-y-3 overflow-y-auto">
        {{ range $index, $member := .PageData.Members }}
          {{ if $member }}
            <button
              class="w-full flex items-center space-x-3 p-2 bg-gray-100 hover:bg-gray-200 rounded border-2 transition-colors cursor-pointer"
              :class="{'border-blue-500': currentUserId === '{{ $member.User.SupabaseUserID }}', 'border-gray-200': currentUserId !== '{{ $member.User.SupabaseUserID }}'}"
            >
              <img
                src="/static/images/default-avatar.png"
                class="w-8 h-8 rounded-full object-cover"
                alt="ユーザーアバター"
              />
              <span class="text-gray-800 text-sm font-medium"
                >{{ $member.DisplayName }}</span
              >
              {{ if $member.IsHost }}
                <span
                  class="text-xs bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded"
                  >ホスト</span
                >
              {{ end }}
            </button>
          {{ else }}
            <div
              class="flex items-center space-x-3 p-2 bg-gray-50 rounded border border-gray-200 opacity-60"
            >
              <div
                class="w-6 h-8 bg-gray-300 rounded flex items-center justify-center"
              >
                <div class="w-4 h-6 bg-gray-500 rounded-sm"></div>
              </div>
              <span class="text-gray-400 text-sm">－</span>
            </div>
          {{ end }}
        {{ end }}
      </div>

      <!-- ボタンエリア（デスクトップのみ表示） -->
      <div class="hidden md:block p-4 flex-shrink-0 space-y-2">
        <!-- ホストの場合：部屋を解散ボタン -->
        <button
          x-show="isHost"
          @click="dismissRoom()"
          :disabled="isDismissing"
          class="w-full flex items-center justify-center space-x-2 bg-red-600 hover:bg-red-700 text-white py-3 px-4 rounded font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
        >
          <svg
            class="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
            />
          </svg>
          <span x-text="isDismissing ? '解散中...' : '部屋を解散'"></span>
        </button>

        <!-- 一般メンバーの場合：部屋を退出ボタン -->
        <button
          x-show="!isHost"
          @click="leaveRoom()"
          :disabled="isLeaving"
          class="w-full flex items-center justify-center space-x-2 bg-gray-600 hover:bg-gray-700 text-white py-3 px-4 rounded font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
        >
          <svg
            class="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
            />
          </svg>
          <span x-text="isLeaving ? '退出中...' : '部屋を退出'"></span>
        </button>

        <!-- 部屋一覧に戻るボタン -->
        <a
          href="/rooms"
          class="w-full flex items-center justify-center space-x-2 bg-gray-100 hover:bg-gray-200 text-gray-700 py-3 px-4 rounded border border-gray-300 font-medium transition-colors"
        >
          <svg
            class="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M10 19l-7-7m0 0l7-7m-7 7h18"
            />
          </svg>
          <span>部屋一覧に戻る</span>
        </a>
      </div>
    </div>

    <!-- メインエリア（モバイルでは全幅、デスクトップでは右側） -->
    <div class="flex-1 h-full flex flex-col">
      <!-- チャットエリア -->
      <div
        class="flex-1 relative bg-gray-100 overflow-y-auto mobile-chat-area"
        id="chat-container"
      >
        <!-- メッセージリスト -->
        <div class="p-4 space-y-4">
          <template x-for="message in messages" :key="message.id">
            <div>
              <!-- システムメッセージ -->
              <template x-if="message.type === 'system'">
                <div class="text-center">
                  <span
                    class="px-3 py-1 rounded-full text-sm"
                    :class="{
                    'bg-gray-200 text-gray-600': message.subtype === 'create',
                    'bg-green-100 text-green-700': message.subtype === 'join',
                    'bg-red-100 text-red-700': message.subtype === 'leave'
                  }"
                    x-text="message.content"
                  ></span>
                </div>
              </template>

              <!-- ユーザーメッセージ -->
              <template x-if="message.type === 'user'">
                <div
                  :class="message.isOwn ? 'flex justify-end' : 'flex items-start space-x-3'"
                >
                  <!-- 他人のメッセージ -->
                  <template x-if="!message.isOwn">
                    <img
                      :src="message.userAvatar || '/static/images/default-avatar.png'"
                      class="w-8 h-8 rounded-full object-cover flex-shrink-0"
                      :alt="message.userName + 'のアバター'"
                    />
                  </template>

                  <div :class="message.isOwn ? 'max-w-xs' : 'flex-1 max-w-xs'">
                    <div
                      class="flex items-center mb-1"
                      :class="message.isOwn ? 'justify-end' : 'space-x-2'"
                    >
                      <template x-if="!message.isOwn">
                        <button
                          class="font-medium text-gray-800 text-sm hover:text-gray-600 hover:underline transition-colors"
                          x-text="message.userName"
                        ></button>
                      </template>
                      <span
                        class="text-gray-500 text-xs"
                        x-text="formatTime(message.timestamp)"
                      ></span>
                    </div>
                    <div
                      class="rounded-lg p-3 text-sm"
                      :class="message.isOwn ? 'bg-gray-800 text-white' : 'bg-gray-200 text-gray-800'"
                      x-text="message.content"
                    ></div>
                  </div>
                </div>
              </template>
            </div>
          </template>
        </div>
      </div>

      <!-- メッセージフォーム -->
      <div class="bg-white border-t border-gray-200 p-4 flex-shrink-0">
        <form
          method="post"
          hx-post="/rooms/{{ .PageData.Room.ID }}/messages"
          hx-trigger="submit"
          hx-swap="none"
          hx-on::before-request="window.roomDetailInstance?.addOptimisticMessage()"
          hx-on::after-request="this.reset(); document.getElementById('message-input').focus()"
          class="flex space-x-3"
        >
          <input
            id="message-input"
            type="text"
            name="message"
            placeholder="メッセージを入力..."
            class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-800 focus:border-transparent"
            :disabled="!$store.auth.initialized || !$store.auth.isAuthenticated"
            required
          />
          <button
            type="submit"
            :disabled="!$store.auth.initialized || !$store.auth.isAuthenticated"
            class="bg-gray-800 hover:bg-gray-900 text-white px-6 py-2 rounded-lg font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
          >
            送信
          </button>
        </form>
      </div>
    </div>
    <!-- 部屋設定モーダル -->
    {{ template "room_settings_modal.tmpl" }}
  </div>

<script>
// mobileMenuストアの初期化
document.addEventListener('alpine:init', () => {
  if (!Alpine.store('mobileMenu')) {
    Alpine.store('mobileMenu', {
      open: false,
      toggle() {
        this.open = !this.open
      },
      close() {
        this.open = false
      },
    })
  }
})

function roomDetail() {
  return {
    descriptionExpanded: false,
    needsExpansion: false,
    messages: [],
    messageInput: '',
    isAuthenticated: false,
    currentUserId: null,
    roomId: '{{ .PageData.Room.ID }}',
    eventSource: null,
    isLeaving: false,
    isDismissing: false,
    isHost: false,
    hostUserId: '{{ .PageData.Room.Host.SupabaseUserID }}',
    showSettingsModal: false,
    settingsData: {
      name: '',
      description: '',
      game_version_id: '',
      max_players: 4,
      target_monster: '',
      rank_requirement: '',
      password: ''
    },
    gameVersions: [],
    errors: {},
    isSubmitting: false,

    async init() {

      
      // グローバルインスタンスとして登録
      window.roomDetailInstance = this;

      // 説明文の展開が必要かチェック
      this.checkDescriptionLength();

      // Alpine.jsの初期化を確実に待つ
      await this.waitForAlpineAuth();

      // ホスト判定を更新
      this.updateHostStatus();

      // ゲームバージョン一覧を取得
      await this.loadGameVersions();

      // 初期メッセージのロード
      await this.loadInitialMessages();

      // SSE接続を確立
      await this.connectSSE();

      // チャットの最下部にスクロール
      this.$nextTick(() => this.scrollToBottom());

      // ページを離れる時にSSE接続を閉じる
      window.addEventListener('beforeunload', () => {
        if (this.eventSource) {
          this.eventSource.close();
        }
      });
    },

    async waitForAlpineAuth() {
      // Alpine.jsの認証ストアが確実に初期化されるまで待つ
      let retries = 0;
      const maxRetries = 50; // 最大5秒待つ

      while (retries < maxRetries) {
        if (window.Alpine && window.Alpine.store('auth')) {
          await window.Alpine.store('auth').checkAuth();
          const isAuth = window.Alpine.store('auth').isAuthenticated;
          const user = window.Alpine.store('auth').user;

          if (isAuth && user) {
            this.isAuthenticated = true;
            this.currentUserId = user.id;
            console.log('Alpine auth initialized:', { isAuth, userId: user.id });
            return;
          }
        }

        await new Promise(resolve => setTimeout(resolve, 100));
        retries++;
      }

      console.warn('Alpine.js authentication initialization timeout');
    },

    checkDescriptionLength() {
      // 説明文が長い場合は展開ボタンを表示
      const description = '{{ .PageData.Room.GetDescription }}';
      this.needsExpansion = description.length > 100;
    },

    async checkAuth() {
      // 認証状態の確認
      if (window.Alpine && Alpine.store('auth')) {
        await Alpine.store('auth').checkAuth();
        this.isAuthenticated = Alpine.store('auth').isAuthenticated;
        this.currentUserId = Alpine.store('auth').user?.id;

        // Alpine.jsが反応するように強制的に更新を通知
        this.$nextTick(() => {
          this.isAuthenticated = Alpine.store('auth').isAuthenticated;
          // ホスト判定を更新
          this.updateHostStatus();
          // 強制的にDOMを更新
          this.$dispatch('host-status-updated', { isHost: this.isHost });
        });
      } else {
        // Alpine.jsまたはauthストアが利用できない場合は少し待ってリトライ
        await new Promise(resolve => setTimeout(resolve, 100));
        return await this.checkAuth();
      }
    },

    async loadInitialMessages() {
      // ログからシステムメッセージを生成
      this.messages = [];

      {{ range .PageData.Logs }}
        {{ if eq .Action "create" }}
          this.messages.push({
            id: '{{ .ID }}',
            type: 'system',
            subtype: 'create',
            content: '{{ if .User }}{{ .User.DisplayName }}{{ else }}ユーザー{{ end }}さんが部屋を作成しました',
            timestamp: new Date('{{ .CreatedAt.Format "2006-01-02T15:04:05Z07:00" }}')
          });
        {{ else if eq .Action "join" }}
          this.messages.push({
            id: '{{ .ID }}',
            type: 'system',
            subtype: 'join',
            content: '{{ index .Details.Data "user_name" }}さんが入室しました',
            timestamp: new Date('{{ .CreatedAt.Format "2006-01-02T15:04:05Z07:00" }}')
          });
        {{ else if eq .Action "leave" }}
          this.messages.push({
            id: '{{ .ID }}',
            type: 'system',
            subtype: 'leave',
            content: '{{ index .Details.Data "user_name" }}さんが退室しました',
            timestamp: new Date('{{ .CreatedAt.Format "2006-01-02T15:04:05Z07:00" }}')
          });
        {{ end }}
      {{ end }}

      // 既存のメッセージを取得
      if (this.isAuthenticated) {
        try {
          // 認証ヘッダーを取得
          const token = Alpine.store('auth').session?.access_token;
          const headers = {};
          if (token) {
            headers['Authorization'] = `Bearer ${token}`;
          }

          const response = await fetch(`/rooms/${this.roomId}/messages?limit=20`, {
            headers: headers
          });
          if (response.ok) {
            const messages = await response.json();
            messages.forEach(msg => {
              // SupabaseユーザーIDで比較（APIレスポンスにuser.supabase_user_idが含まれている場合）
              const isOwn = msg.user.supabase_user_id === this.currentUserId;
              this.messages.push({
                id: msg.id,
                type: 'user',
                content: msg.message,
                userName: msg.user.display_name,
                userAvatar: msg.user.avatar_url || '/static/images/default-avatar.png',
                isOwn: isOwn,
                timestamp: new Date(msg.created_at)
              });
            });
          }
        } catch (err) {
          console.error('メッセージの取得に失敗しました:', err);
        }
      }
    },

    sendMessage() {
      if (!this.messageInput.trim() || !this.isAuthenticated) return;

      // メッセージを送信（仮実装）
      const newMessage = {
        id: Date.now(),
        type: 'user',
        content: this.messageInput,
        userName: Alpine.store('auth').user?.displayName || 'ゲスト',
        isOwn: true,
        timestamp: new Date()
      };

      this.messages.push(newMessage);
      this.messageInput = '';

      this.$nextTick(() => this.scrollToBottom());
    },

    formatTime(timestamp) {
      const date = new Date(timestamp);
      return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
    },

    scrollToBottom() {
      const container = document.getElementById('chat-container');
      if (container) {
        container.scrollTop = container.scrollHeight;
      }
    },

    async connectSSE() {
      if (!this.isAuthenticated) return;

      // 既存の接続があれば閉じる
      if (this.eventSource) {
        this.eventSource.close();
        this.eventSource = null;
      }

      try {
        // 一時的なSSEトークンを取得
        const authToken = Alpine.store('auth').session?.access_token;
        if (!authToken) {
          console.error('SSE接続: 認証トークンが取得できません');
          return;
        }

        const response = await fetch(`/rooms/${this.roomId}/sse-token`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          throw new Error(`SSEトークン取得失敗: ${response.status}`);
        }

        const tokenData = await response.json();
        const sseToken = tokenData.token;

        const url = `/rooms/${this.roomId}/messages/stream?token=${encodeURIComponent(sseToken)}`;

        this.eventSource = new EventSource(url);
      } catch (error) {
        console.error('SSEトークン取得エラー:', error);
        return;
      }
      this.sseReconnectCount = (this.sseReconnectCount || 0);

      this.eventSource.addEventListener('open', (event) => {
        this.sseReconnectCount = 0; // 接続成功時にリセット
      });

      // 接続確認メッセージ
      this.eventSource.addEventListener('connected', (event) => {
        this.sseReconnectCount = 0; // 接続成功確認時にリセット
      });

      this.eventSource.addEventListener('message', (event) => {
        try {
          const data = JSON.parse(event.data);
          if (data.type === 'message') {
            this.handleNewMessage(data.data);
          } else if (data.type === 'system_message') {
            this.handleSystemMessage(data.data);
          }
        } catch (err) {
          console.error('SSEメッセージの解析エラー:', err);
        }
      });

      this.eventSource.addEventListener('error', (event) => {
        console.error('SSE接続エラー:', event, '状態:', this.eventSource.readyState);

        // 再接続の制限（最大5回まで）
        if (this.sseReconnectCount < 5) {
          this.sseReconnectCount++;
          const delay = Math.min(1000 * Math.pow(2, this.sseReconnectCount - 1), 30000); // 指数バックオフ（最大30秒）

          setTimeout(async () => {
            if (this.isAuthenticated && Alpine.store('auth').session?.access_token) {
              await this.connectSSE();
            }
          }, delay);
        } else {
          console.error('SSE最大再接続回数に達しました。手動でページをリロードしてください。');
        }
      });
    },

    handleNewMessage(message) {
      // 自分のメッセージの場合はスキップ（すでに送信時に追加されている）
      // SupabaseユーザーIDで比較
      if (message.user.supabase_user_id === this.currentUserId) return;

      // メッセージを追加
      this.messages.push({
        id: message.id,
        type: 'user',
        content: message.message,
        userName: message.user.display_name,
        userAvatar: message.user.avatar_url || '/static/images/default-avatar.png',
        isOwn: false,
        timestamp: new Date(message.created_at)
      });

      this.$nextTick(() => this.scrollToBottom());
    },

    handleSystemMessage(message) {
      // システムメッセージを追加
      this.messages.push({
        id: message.id,
        type: 'system',
        subtype: 'join', // 入室メッセージとして扱う
        content: message.message,
        timestamp: new Date()
      });

      this.$nextTick(() => this.scrollToBottom());
    },

    addOptimisticMessage() {
      const messageInput = document.getElementById('message-input');
      const messageText = messageInput.value.trim();

      if (!messageText || !Alpine.store('auth').isAuthenticated) return;

      // メッセージを即座に表示（楽観的更新）
      const newMessage = {
        id: Date.now(),
        type: 'user',
        content: messageText,
        userName: Alpine.store('auth').user?.displayName || 'ゲスト',
        userAvatar: Alpine.store('auth').user?.avatarUrl || '/static/images/default-avatar.png',
        isOwn: true,
        timestamp: new Date()
      };

      this.messages.push(newMessage);
      this.$nextTick(() => this.scrollToBottom());
    },

    async leaveRoom() {
      if (this.isLeaving) return;

      // 確認ダイアログを表示
      if (!confirm('本当に部屋を退出しますか？')) {
        return;
      }

      this.isLeaving = true;

      try {
        const authToken = Alpine.store('auth').session?.access_token;
        if (!authToken) {
          throw new Error('認証が必要です');
        }

        const response = await fetch(`/rooms/${this.roomId}/leave`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          throw new Error('退出処理に失敗しました');
        }

        // SSE接続を閉じる
        if (this.eventSource) {
          this.eventSource.close();
        }

        // 部屋一覧へリダイレクト
        window.location.href = '/rooms';
      } catch (error) {
        console.error('退出エラー:', error);
        alert('退出処理に失敗しました。もう一度お試しください。');
        this.isLeaving = false;
      }
    },

    updateHostStatus() {
      if (this.isAuthenticated && this.currentUserId) {
        this.isHost = this.currentUserId === this.hostUserId;
        console.log('Host status updated:', { 
          currentUserId: this.currentUserId, 
          hostUserId: this.hostUserId, 
          isHost: this.isHost 
        });
      } else {
        this.isHost = false;
        console.log('Not authenticated or no current user, isHost set to false');
      }
      
      // 強制的にAlpine.jsの反応を促す
      this.$nextTick(() => {
        this.$el.dispatchEvent(new CustomEvent('host-status-changed'));
      });
    },

    async loadGameVersions() {
      try {
        const response = await fetch('/api/game-versions/active');
        if (response.ok) {
          const data = await response.json();
          this.gameVersions = data.game_versions || [];
          console.log('Loaded game versions:', this.gameVersions);
        }
      } catch (error) {
        console.error('ゲームバージョンの取得に失敗しました:', error);
      }
    },

    openSettingsModal() {
      console.log('openSettingsModal called');
      
      // 現在の部屋データで設定フォームを初期化
      const room = {
        name: '{{ .PageData.Room.Name }}',
        description: '{{ .PageData.Room.GetDescription }}',
        game_version_id: '{{ .PageData.Room.GameVersionID }}',
        max_players: {{ .PageData.Room.MaxPlayers }},
        target_monster: '{{ .PageData.Room.GetTargetMonster }}',
        rank_requirement: '{{ .PageData.Room.GetRankRequirement }}'
      };
      
      console.log('Room data:', room);
      
      this.settingsData = {
        name: room.name || '',
        description: room.description || '',
        game_version_id: room.game_version_id || '',
        max_players: room.max_players || 4,
        target_monster: (room.target_monster && room.target_monster !== '<nil>') ? room.target_monster : '',
        rank_requirement: (room.rank_requirement && room.rank_requirement !== '<nil>') ? room.rank_requirement : '',
        password: '' // パスワードは常に空で初期化
      };
      
      this.errors = {};
      this.showSettingsModal = true;
      
      console.log('showSettingsModal set to:', this.showSettingsModal);
      console.log('settingsData:', this.settingsData);
    },

    closeSettingsModal() {
      this.showSettingsModal = false;
      this.errors = {};
      this.isSubmitting = false;
    },

    get isFormValid() {
      return this.settingsData.name.trim() !== '' &&
             this.settingsData.game_version_id !== '' &&
             this.settingsData.max_players >= 2 &&
             this.settingsData.max_players <= 4 &&
             Object.keys(this.errors).length === 0;
    },

    validateField(field) {
      // エラーをクリア
      delete this.errors[field];

      switch (field) {
        case 'name':
          if (!this.settingsData.name.trim()) {
            this.errors.name = '部屋名は必須です。';
          } else if (this.settingsData.name.length > 100) {
            this.errors.name = '部屋名は100文字以内で入力してください。';
          }
          break;

        case 'description':
          if (this.settingsData.description.length > 500) {
            this.errors.description = '説明文は500文字以内で入力してください。';
          }
          break;

        case 'game_version_id':
          if (!this.settingsData.game_version_id) {
            this.errors.game_version_id = 'ゲームバージョンを選択してください。';
          }
          break;

        case 'max_players':
          if (this.settingsData.max_players < 2 || this.settingsData.max_players > 4) {
            this.errors.max_players = '最大プレイヤー数は2〜4人の間で設定してください。';
          }
          break;

        case 'target_monster':
          if (this.settingsData.target_monster.length > 50) {
            this.errors.target_monster = 'ターゲットモンスターは50文字以内で入力してください。';
          }
          break;

        case 'rank_requirement':
          if (this.settingsData.rank_requirement.length > 20) {
            this.errors.rank_requirement = 'ランク要求は20文字以内で入力してください。';
          }
          break;

        case 'password':
          if (this.settingsData.password.length > 20) {
            this.errors.password = 'パスワードは20文字以内で入力してください。';
          }
          break;
      }

      // リアクティブな更新を促す
      this.$nextTick();
    },

    async updateRoom() {
      if (this.isSubmitting || !this.isFormValid) return;

      // 全フィールドのバリデーション
      Object.keys(this.settingsData).forEach(field => {
        this.validateField(field);
      });

      if (Object.keys(this.errors).length > 0) {
        return;
      }

      this.isSubmitting = true;

      try {
        const authToken = Alpine.store('auth').session?.access_token;
        if (!authToken) {
          throw new Error('認証が必要です');
        }

        const response = await fetch(`/rooms/${this.roomId}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(this.settingsData)
        });

        if (!response.ok) {
          const errorData = await response.text();
          throw new Error(errorData || '部屋設定の更新に失敗しました');
        }

        const result = await response.json();
        
        // 成功メッセージを表示
        alert('部屋設定を更新しました');
        
        // モーダルを閉じる
        this.closeSettingsModal();
        
        // ページをリロードして最新の情報を表示
        window.location.reload();
      } catch (error) {
        console.error('部屋設定更新エラー:', error);
        alert('部屋設定の更新に失敗しました: ' + error.message);
        this.isSubmitting = false;
      }
    },

    async dismissRoom() {
      if (this.isDismissing) return;

      // 確認ダイアログを表示
      if (!confirm('本当に部屋を解散しますか？\n解散すると、すべてのメンバーが退出し、部屋は削除されます。')) {
        return;
      }

      this.isDismissing = true;

      try {
        const authToken = Alpine.store('auth').session?.access_token;
        if (!authToken) {
          throw new Error('認証が必要です');
        }

        const response = await fetch(`/rooms/${this.roomId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          throw new Error('解散処理に失敗しました');
        }

        const result = await response.json();

        // SSE接続を閉じる
        if (this.eventSource) {
          this.eventSource.close();
        }

        // リダイレクト先が指定されている場合はそちらへ、そうでなければ部屋一覧へ
        window.location.href = result.redirect || '/rooms';
      } catch (error) {
        console.error('解散エラー:', error);
        alert('解散処理に失敗しました。もう一度お試しください。');
        this.isDismissing = false;
      }
    }
  };
}

// グローバルスコープに公開
window.roomDetail = roomDetail;
</script>
{{ end }}
