{{ define "room_detail_page" }}
  <div
    class="flex h-full md:flex-row flex-col mobile-room-detail"
    x-data="roomDetail()"
  >
    <!-- ãƒ¢ãƒã‚¤ãƒ«ç‰ˆãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã§ã¯éè¡¨ç¤ºï¼‰ -->
    <div
      class="md:hidden bg-white border-b border-gray-200 px-4 py-3 flex-shrink-0"
    >
      <div class="flex items-center space-x-3">
        <div
          class="w-10 h-10 {{ gameVersionColor .PageData.Room.GameVersion.Code }} rounded flex items-center justify-center flex-shrink-0"
        >
          <div
            class="w-6 h-6 flex items-center justify-center text-white text-xs font-bold"
          >
            {{ .PageData.Room.GameVersion.Code }}
          </div>
        </div>
        <button
          class="flex-1 text-left hover:bg-gray-50 py-1 px-2 rounded transition-colors"
          @click="$store.mobileMenu.toggle()"
        >
          <div class="text-gray-800 font-bold text-base">
            {{ if .PageData.Room.HasPassword }}ğŸ”‘ {{ end }}{{ .PageData.Room.Name }}
          </div>
          <div class="text-gray-500 text-sm">
            å‚åŠ è€… {{ .PageData.MemberCount }}/4
          </div>
        </button>
        <!-- ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ -->
        <div class="md:hidden">
          <button
            @click="$store.mobileMenu.toggle()"
            x-show="!$store.mobileMenu.open"
            class="text-gray-600 hover:text-gray-800 p-2 relative z-[10000]"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 6h16M4 12h16M4 18h16"
              ></path>
            </svg>
          </button>
        </div>
      </div>
    </div>

    <!-- ãƒ¢ãƒã‚¤ãƒ«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆéƒ¨å±‹è©³ç´°ãƒšãƒ¼ã‚¸å°‚ç”¨ï¼‰ -->
    <div class="md:hidden">
      <!-- ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
      <div
        x-show="$store.mobileMenu.open"
        x-cloak
        @click="$store.mobileMenu.close()"
        class="fixed inset-0 bg-black bg-opacity-50 z-[9998]"
        x-transition:enter="transition-opacity ease-out duration-300"
        x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100"
        x-transition:leave="transition-opacity ease-in duration-200"
        x-transition:leave-start="opacity-100"
        x-transition:leave-end="opacity-0"
        style="display: none"
      ></div>

      <!-- ãƒ¢ãƒã‚¤ãƒ«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ‘ãƒãƒ« -->
      <div
        x-show="$store.mobileMenu.open"
        x-cloak
        class="fixed top-0 right-0 h-full w-80 bg-white shadow-lg z-[9999] overflow-y-auto"
        x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="transform translate-x-full"
        x-transition:enter-end="transform translate-x-0"
        x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="transform translate-x-0"
        x-transition:leave-end="transform translate-x-full"
        style="display: none"
      >
        <!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div
          class="flex items-center justify-between p-6 border-b border-gray-200"
        >
          <div class="flex-1 min-w-0">
            <div class="flex items-center space-x-3 mb-2">
              <img src="/static/images/icon.png" alt="MonHub" class="w-8 h-8 flex-shrink-0" />
              <h2 class="text-xl font-bold text-gray-800 truncate">
                {{ if .PageData.Room.HasPassword }}ğŸ”‘ {{ end }}{{ .PageData.Room.Name }}
              </h2>
            </div>
            <!-- éƒ¨å±‹è©³ç´°æƒ…å ±ï¼ˆãƒ¢ãƒã‚¤ãƒ«ç‰ˆï¼‰ -->
            <div class="text-sm text-gray-500 space-y-1">
              {{ if .PageData.Room.GetDescription }}
                <div class="text-xs">{{ .PageData.Room.GetDescription }}</div>
              {{ end }}
              <div class="flex flex-wrap gap-3 text-xs">
                {{ if .PageData.Room.GetTargetMonster }}
                  <span>ğŸ¯ {{ .PageData.Room.GetTargetMonster }}</span>
                {{ end }}
                {{ if .PageData.Room.GetRankRequirement }}
                  <span>ğŸ† {{ .PageData.Room.GetRankRequirement }}</span>
                {{ end }}
              </div>
            </div>
          </div>
          <button
            @click="$store.mobileMenu.close()"
            class="text-gray-500 hover:text-gray-700 flex-shrink-0 ml-3"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              ></path>
            </svg>
          </button>
        </div>

        <!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼å†…å®¹ -->
        <div class="p-6 space-y-4">
          <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
          <div class="space-y-3" x-show="$store.auth.isAuthenticated">
            <!-- ãƒ›ã‚¹ãƒˆé™å®šï¼šéƒ¨å±‹ã‚’ç·¨é›†ãƒœã‚¿ãƒ³ -->
            <button
              x-show="isHost"
              @click="openSettingsModal(); $store.mobileMenu.close()"
              class="w-full flex items-center justify-center space-x-2 bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded font-medium transition-colors"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
              </svg>
              <span>éƒ¨å±‹ã‚’ç·¨é›†</span>
            </button>

            <!-- ãƒ›ã‚¹ãƒˆã®å ´åˆï¼šéƒ¨å±‹ã‚’è§£æ•£ãƒœã‚¿ãƒ³ -->
            <button
              x-show="isHost"
              @click="dismissRoom(); $store.mobileMenu.close()"
              :disabled="isDismissing"
              class="w-full flex items-center justify-center space-x-2 bg-red-600 hover:bg-red-700 text-white py-3 px-4 rounded font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                />
              </svg>
              <span x-text="isDismissing ? 'è§£æ•£ä¸­...' : 'éƒ¨å±‹ã‚’è§£æ•£'"></span>
            </button>

            <!-- ä¸€èˆ¬ãƒ¡ãƒ³ãƒãƒ¼ã®å ´åˆï¼šéƒ¨å±‹ã‚’é€€å‡ºãƒœã‚¿ãƒ³ -->
            <button
              x-show="!isHost"
              @click="leaveRoom(); $store.mobileMenu.close()"
              :disabled="isLeaving"
              class="w-full flex items-center justify-center space-x-2 bg-red-600 hover:bg-red-700 text-white py-3 px-4 rounded font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
                />
              </svg>
              <span x-text="isLeaving ? 'é€€å‡ºä¸­...' : 'éƒ¨å±‹ã‚’é€€å‡º'"></span>
            </button>

            <!-- éƒ¨å±‹ä¸€è¦§ã«æˆ»ã‚‹ãƒœã‚¿ãƒ³ -->
            <a
              href="/rooms"
              @click="$store.mobileMenu.close()"
              class="w-full flex items-center justify-center space-x-2 bg-gray-100 hover:bg-gray-200 text-gray-700 py-3 px-4 rounded border border-gray-300 font-medium transition-colors"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M10 19l-7-7m0 0l7-7m-7 7h18"
                />
              </svg>
              <span>éƒ¨å±‹ä¸€è¦§ã«æˆ»ã‚‹</span>
            </a>
          </div>

          <!-- æœªèªè¨¼æ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
          <div class="text-center py-4" x-show="!$store.auth.isAuthenticated">
            <p class="text-gray-500 text-sm">ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„</p>
          </div>
        </div>
      </div>
    </div>
    <!-- å·¦å´ãƒ‘ãƒãƒ«ï¼ˆãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã®ã¿è¡¨ç¤ºï¼‰ -->
    <div
      class="hidden md:flex w-96 h-full border-r border-gray-200 flex-col bg-white"
    >
      <!-- ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ† -->
      <div
        class="bg-white border-b border-gray-200 px-4 py-3 min-h-0 flex-shrink-0"
      >
        <div class="flex items-center space-x-3 mb-2">
          <div
            class="w-12 h-12 {{ gameVersionColor .PageData.Room.GameVersion.Code }} rounded flex items-center justify-center flex-shrink-0"
          >
            <div
              class="w-8 h-8 flex items-center justify-center text-white text-sm font-bold"
            >
              {{ .PageData.Room.GameVersion.Code }}
            </div>
          </div>
          <div class="flex items-center justify-between">
            <div class="text-gray-800 font-bold text-lg">
              {{ if .PageData.Room.HasPassword }}ğŸ”‘ {{ end }}{{ .PageData.Room.Name }}
            </div>
            <!-- PCç‰ˆã®ã¿ï¼šãƒ›ã‚¹ãƒˆã®å ´åˆã«è¨­å®šã‚¢ã‚¤ã‚³ãƒ³ã‚’è¡¨ç¤º -->
            <button 
              x-show="isHost && $store.auth.initialized && $store.auth.isAuthenticated"
              @click="openSettingsModal()"
              class="hidden md:block text-gray-600 hover:text-gray-800 p-1 rounded hover:bg-gray-100 transition-colors"
              title="éƒ¨å±‹è¨­å®šã‚’å¤‰æ›´"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                      d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                      d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
              </svg>
            </button>
          </div>
        </div>
        <div class="text-gray-600 text-sm leading-relaxed">
          <div x-show="!descriptionExpanded" class="overflow-hidden">
            <div class="max-h-10 overflow-hidden">
              {{ .PageData.Room.GetDescription }}
            </div>
            <button
              @click="descriptionExpanded = true"
              x-show="needsExpansion"
              class="text-gray-800 hover:text-gray-600 text-xs mt-1 underline"
            >
              ç¶šãã‚’è¡¨ç¤º
            </button>
          </div>
          <div x-show="descriptionExpanded" x-cloak>
            {{ .PageData.Room.GetDescription }}
            <button
              @click="descriptionExpanded = false"
              class="text-gray-800 hover:text-gray-600 text-xs mt-1 underline block"
            >
              é–‰ã˜ã‚‹
            </button>
          </div>
        </div>

        <!-- éƒ¨å±‹ã®è©³ç´°æƒ…å ± -->
        <div class="mt-3 text-sm text-gray-500 space-y-1">
          {{ $target := .PageData.Room.GetTargetMonster }}
          {{ if and $target (ne $target "<nil>") }}
            <div class="flex items-center">
              <span class="text-gray-400 mr-2">ğŸ¯</span>
              <span>ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ: {{ $target }}</span>
            </div>
          {{ end }}
          {{ $rank := .PageData.Room.GetRankRequirement }}
          {{ if and $rank (ne $rank "<nil>") }}
            <div class="flex items-center">
              <span class="text-gray-400 mr-2">ğŸ†</span>
              <span>ãƒ©ãƒ³ã‚¯: {{ $rank }}</span>
            </div>
          {{ end }}
        </div>
      </div>

      <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆ -->
      <div class="flex-1 px-4 pt-4 space-y-3 overflow-y-auto">
        {{ range $index, $member := .PageData.Members }}
          {{ if $member }}
            <button
              class="w-full flex items-center space-x-3 p-2 bg-gray-100 hover:bg-gray-200 rounded border-2 transition-colors cursor-pointer"
              :class="{'border-blue-500': currentUserId === '{{ $member.User.SupabaseUserID }}', 'border-gray-200': currentUserId !== '{{ $member.User.SupabaseUserID }}'}"
            >
              <img
                src="/static/images/default-avatar.png"
                class="w-8 h-8 rounded-full object-cover"
                alt="ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ãƒã‚¿ãƒ¼"
              />
              <span class="text-gray-800 text-sm font-medium"
                >{{ $member.DisplayName }}</span
              >
              {{ if $member.IsHost }}
                <span
                  class="text-xs bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded"
                  >ãƒ›ã‚¹ãƒˆ</span
                >
              {{ end }}
            </button>
          {{ else }}
            <div
              class="flex items-center space-x-3 p-2 bg-gray-50 rounded border border-gray-200 opacity-60"
            >
              <div
                class="w-6 h-8 bg-gray-300 rounded flex items-center justify-center"
              >
                <div class="w-4 h-6 bg-gray-500 rounded-sm"></div>
              </div>
              <span class="text-gray-400 text-sm">ï¼</span>
            </div>
          {{ end }}
        {{ end }}
      </div>

      <!-- ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ï¼ˆãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã®ã¿è¡¨ç¤ºï¼‰ -->
      <div class="hidden md:block p-4 flex-shrink-0 space-y-2">
        <!-- ãƒ›ã‚¹ãƒˆã®å ´åˆï¼šéƒ¨å±‹ã‚’è§£æ•£ãƒœã‚¿ãƒ³ -->
        <button
          x-show="isHost"
          @click="dismissRoom()"
          :disabled="isDismissing"
          class="w-full flex items-center justify-center space-x-2 bg-red-600 hover:bg-red-700 text-white py-3 px-4 rounded font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
        >
          <svg
            class="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
            />
          </svg>
          <span x-text="isDismissing ? 'è§£æ•£ä¸­...' : 'éƒ¨å±‹ã‚’è§£æ•£'"></span>
        </button>

        <!-- ä¸€èˆ¬ãƒ¡ãƒ³ãƒãƒ¼ã®å ´åˆï¼šéƒ¨å±‹ã‚’é€€å‡ºãƒœã‚¿ãƒ³ -->
        <button
          x-show="!isHost"
          @click="leaveRoom()"
          :disabled="isLeaving"
          class="w-full flex items-center justify-center space-x-2 bg-gray-600 hover:bg-gray-700 text-white py-3 px-4 rounded font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
        >
          <svg
            class="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
            />
          </svg>
          <span x-text="isLeaving ? 'é€€å‡ºä¸­...' : 'éƒ¨å±‹ã‚’é€€å‡º'"></span>
        </button>

        <!-- éƒ¨å±‹ä¸€è¦§ã«æˆ»ã‚‹ãƒœã‚¿ãƒ³ -->
        <a
          href="/rooms"
          class="w-full flex items-center justify-center space-x-2 bg-gray-100 hover:bg-gray-200 text-gray-700 py-3 px-4 rounded border border-gray-300 font-medium transition-colors"
        >
          <svg
            class="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M10 19l-7-7m0 0l7-7m-7 7h18"
            />
          </svg>
          <span>éƒ¨å±‹ä¸€è¦§ã«æˆ»ã‚‹</span>
        </a>
      </div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ï¼ˆãƒ¢ãƒã‚¤ãƒ«ã§ã¯å…¨å¹…ã€ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã§ã¯å³å´ï¼‰ -->
    <div class="flex-1 h-full flex flex-col">
      <!-- ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ -->
      <div
        class="flex-1 relative bg-gray-100 overflow-y-auto mobile-chat-area"
        id="chat-container"
      >
        <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒªã‚¹ãƒˆ -->
        <div class="p-4 space-y-4">
          <template x-for="message in messages" :key="message.id">
            <div>
              <!-- ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
              <template x-if="message.type === 'system'">
                <div class="text-center">
                  <span
                    class="px-3 py-1 rounded-full text-sm"
                    :class="{
                    'bg-gray-200 text-gray-600': message.subtype === 'create',
                    'bg-green-100 text-green-700': message.subtype === 'join',
                    'bg-red-100 text-red-700': message.subtype === 'leave'
                  }"
                    x-text="message.content"
                  ></span>
                </div>
              </template>

              <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
              <template x-if="message.type === 'user'">
                <div
                  :class="message.isOwn ? 'flex justify-end' : 'flex items-start space-x-3'"
                >
                  <!-- ä»–äººã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
                  <template x-if="!message.isOwn">
                    <img
                      :src="message.userAvatar || '/static/images/default-avatar.png'"
                      class="w-8 h-8 rounded-full object-cover flex-shrink-0"
                      :alt="message.userName + 'ã®ã‚¢ãƒã‚¿ãƒ¼'"
                    />
                  </template>

                  <div :class="message.isOwn ? 'max-w-xs' : 'flex-1 max-w-xs'">
                    <div
                      class="flex items-center mb-1"
                      :class="message.isOwn ? 'justify-end' : 'space-x-2'"
                    >
                      <template x-if="!message.isOwn">
                        <button
                          class="font-medium text-gray-800 text-sm hover:text-gray-600 hover:underline transition-colors"
                          x-text="message.userName"
                        ></button>
                      </template>
                      <span
                        class="text-gray-500 text-xs"
                        x-text="formatTime(message.timestamp)"
                      ></span>
                    </div>
                    <div
                      class="rounded-lg p-3 text-sm"
                      :class="message.isOwn ? 'bg-gray-800 text-white' : 'bg-gray-200 text-gray-800'"
                      x-text="message.content"
                    ></div>
                  </div>
                </div>
              </template>
            </div>
          </template>
        </div>
      </div>

      <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ•ã‚©ãƒ¼ãƒ  -->
      <div class="bg-white border-t border-gray-200 p-4 flex-shrink-0">
        <form
          method="post"
          hx-post="/rooms/{{ .PageData.Room.ID }}/messages"
          hx-trigger="submit"
          hx-swap="none"
          hx-on::before-request="window.roomDetailInstance?.addOptimisticMessage()"
          hx-on::after-request="this.reset(); document.getElementById('message-input').focus()"
          class="flex space-x-3"
        >
          <input
            id="message-input"
            type="text"
            name="message"
            placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..."
            class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-800 focus:border-transparent"
            :disabled="!$store.auth.initialized || !$store.auth.isAuthenticated"
            required
          />
          <button
            type="submit"
            :disabled="!$store.auth.initialized || !$store.auth.isAuthenticated"
            class="bg-gray-800 hover:bg-gray-900 text-white px-6 py-2 rounded-lg font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
          >
            é€ä¿¡
          </button>
        </form>
      </div>
    </div>
    <!-- éƒ¨å±‹è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
    {{ template "room_settings_modal.tmpl" }}
  </div>

<script>
// mobileMenuã‚¹ãƒˆã‚¢ã®åˆæœŸåŒ–
document.addEventListener('alpine:init', () => {
  if (!Alpine.store('mobileMenu')) {
    Alpine.store('mobileMenu', {
      open: false,
      toggle() {
        this.open = !this.open
      },
      close() {
        this.open = false
      },
    })
  }
})

function roomDetail() {
  return {
    descriptionExpanded: false,
    needsExpansion: false,
    messages: [],
    messageInput: '',
    isAuthenticated: false,
    currentUserId: null,
    roomId: '{{ .PageData.Room.ID }}',
    eventSource: null,
    isLeaving: false,
    isDismissing: false,
    isHost: false,
    hostUserId: '{{ .PageData.Room.Host.SupabaseUserID }}',
    showSettingsModal: false,
    settingsData: {
      name: '',
      description: '',
      game_version_id: '',
      max_players: 4,
      target_monster: '',
      rank_requirement: '',
      password: ''
    },
    gameVersions: [],
    errors: {},
    isSubmitting: false,

    async init() {

      
      // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¨ã—ã¦ç™»éŒ²
      window.roomDetailInstance = this;

      // èª¬æ˜æ–‡ã®å±•é–‹ãŒå¿…è¦ã‹ãƒã‚§ãƒƒã‚¯
      this.checkDescriptionLength();

      // Alpine.jsã®åˆæœŸåŒ–ã‚’ç¢ºå®Ÿã«å¾…ã¤
      await this.waitForAlpineAuth();

      // ãƒ›ã‚¹ãƒˆåˆ¤å®šã‚’æ›´æ–°
      this.updateHostStatus();

      // ã‚²ãƒ¼ãƒ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä¸€è¦§ã‚’å–å¾—
      await this.loadGameVersions();

      // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒ­ãƒ¼ãƒ‰
      await this.loadInitialMessages();

      // SSEæ¥ç¶šã‚’ç¢ºç«‹
      await this.connectSSE();

      // ãƒãƒ£ãƒƒãƒˆã®æœ€ä¸‹éƒ¨ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
      this.$nextTick(() => this.scrollToBottom());

      // ãƒšãƒ¼ã‚¸ã‚’é›¢ã‚Œã‚‹æ™‚ã«SSEæ¥ç¶šã‚’é–‰ã˜ã‚‹
      window.addEventListener('beforeunload', () => {
        if (this.eventSource) {
          this.eventSource.close();
        }
      });
    },

    async waitForAlpineAuth() {
      // Alpine.jsã®èªè¨¼ã‚¹ãƒˆã‚¢ãŒç¢ºå®Ÿã«åˆæœŸåŒ–ã•ã‚Œã‚‹ã¾ã§å¾…ã¤
      let retries = 0;
      const maxRetries = 50; // æœ€å¤§5ç§’å¾…ã¤

      while (retries < maxRetries) {
        if (window.Alpine && window.Alpine.store('auth')) {
          await window.Alpine.store('auth').checkAuth();
          const isAuth = window.Alpine.store('auth').isAuthenticated;
          const user = window.Alpine.store('auth').user;

          if (isAuth && user) {
            this.isAuthenticated = true;
            this.currentUserId = user.id;
            console.log('Alpine auth initialized:', { isAuth, userId: user.id });
            return;
          }
        }

        await new Promise(resolve => setTimeout(resolve, 100));
        retries++;
      }

      console.warn('Alpine.js authentication initialization timeout');
    },

    checkDescriptionLength() {
      // èª¬æ˜æ–‡ãŒé•·ã„å ´åˆã¯å±•é–‹ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
      const description = '{{ .PageData.Room.GetDescription }}';
      this.needsExpansion = description.length > 100;
    },

    async checkAuth() {
      // èªè¨¼çŠ¶æ…‹ã®ç¢ºèª
      if (window.Alpine && Alpine.store('auth')) {
        await Alpine.store('auth').checkAuth();
        this.isAuthenticated = Alpine.store('auth').isAuthenticated;
        this.currentUserId = Alpine.store('auth').user?.id;

        // Alpine.jsãŒåå¿œã™ã‚‹ã‚ˆã†ã«å¼·åˆ¶çš„ã«æ›´æ–°ã‚’é€šçŸ¥
        this.$nextTick(() => {
          this.isAuthenticated = Alpine.store('auth').isAuthenticated;
          // ãƒ›ã‚¹ãƒˆåˆ¤å®šã‚’æ›´æ–°
          this.updateHostStatus();
          // å¼·åˆ¶çš„ã«DOMã‚’æ›´æ–°
          this.$dispatch('host-status-updated', { isHost: this.isHost });
        });
      } else {
        // Alpine.jsã¾ãŸã¯authã‚¹ãƒˆã‚¢ãŒåˆ©ç”¨ã§ããªã„å ´åˆã¯å°‘ã—å¾…ã£ã¦ãƒªãƒˆãƒ©ã‚¤
        await new Promise(resolve => setTimeout(resolve, 100));
        return await this.checkAuth();
      }
    },

    async loadInitialMessages() {
      // ãƒ­ã‚°ã‹ã‚‰ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç”Ÿæˆ
      this.messages = [];

      {{ range .PageData.Logs }}
        {{ if eq .Action "create" }}
          this.messages.push({
            id: '{{ .ID }}',
            type: 'system',
            subtype: 'create',
            content: '{{ if .User }}{{ .User.DisplayName }}{{ else }}ãƒ¦ãƒ¼ã‚¶ãƒ¼{{ end }}ã•ã‚“ãŒéƒ¨å±‹ã‚’ä½œæˆã—ã¾ã—ãŸ',
            timestamp: new Date('{{ .CreatedAt.Format "2006-01-02T15:04:05Z07:00" }}')
          });
        {{ else if eq .Action "join" }}
          this.messages.push({
            id: '{{ .ID }}',
            type: 'system',
            subtype: 'join',
            content: '{{ index .Details.Data "user_name" }}ã•ã‚“ãŒå…¥å®¤ã—ã¾ã—ãŸ',
            timestamp: new Date('{{ .CreatedAt.Format "2006-01-02T15:04:05Z07:00" }}')
          });
        {{ else if eq .Action "leave" }}
          this.messages.push({
            id: '{{ .ID }}',
            type: 'system',
            subtype: 'leave',
            content: '{{ index .Details.Data "user_name" }}ã•ã‚“ãŒé€€å®¤ã—ã¾ã—ãŸ',
            timestamp: new Date('{{ .CreatedAt.Format "2006-01-02T15:04:05Z07:00" }}')
          });
        {{ end }}
      {{ end }}

      // æ—¢å­˜ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
      if (this.isAuthenticated) {
        try {
          // èªè¨¼ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’å–å¾—
          const token = Alpine.store('auth').session?.access_token;
          const headers = {};
          if (token) {
            headers['Authorization'] = `Bearer ${token}`;
          }

          const response = await fetch(`/rooms/${this.roomId}/messages?limit=20`, {
            headers: headers
          });
          if (response.ok) {
            const messages = await response.json();
            messages.forEach(msg => {
              // Supabaseãƒ¦ãƒ¼ã‚¶ãƒ¼IDã§æ¯”è¼ƒï¼ˆAPIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«user.supabase_user_idãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆï¼‰
              const isOwn = msg.user.supabase_user_id === this.currentUserId;
              this.messages.push({
                id: msg.id,
                type: 'user',
                content: msg.message,
                userName: msg.user.display_name,
                userAvatar: msg.user.avatar_url || '/static/images/default-avatar.png',
                isOwn: isOwn,
                timestamp: new Date(msg.created_at)
              });
            });
          }
        } catch (err) {
          console.error('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', err);
        }
      }
    },

    sendMessage() {
      if (!this.messageInput.trim() || !this.isAuthenticated) return;

      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ï¼ˆä»®å®Ÿè£…ï¼‰
      const newMessage = {
        id: Date.now(),
        type: 'user',
        content: this.messageInput,
        userName: Alpine.store('auth').user?.displayName || 'ã‚²ã‚¹ãƒˆ',
        isOwn: true,
        timestamp: new Date()
      };

      this.messages.push(newMessage);
      this.messageInput = '';

      this.$nextTick(() => this.scrollToBottom());
    },

    formatTime(timestamp) {
      const date = new Date(timestamp);
      return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
    },

    scrollToBottom() {
      const container = document.getElementById('chat-container');
      if (container) {
        container.scrollTop = container.scrollHeight;
      }
    },

    async connectSSE() {
      if (!this.isAuthenticated) return;

      // æ—¢å­˜ã®æ¥ç¶šãŒã‚ã‚Œã°é–‰ã˜ã‚‹
      if (this.eventSource) {
        this.eventSource.close();
        this.eventSource = null;
      }

      try {
        // ä¸€æ™‚çš„ãªSSEãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
        const authToken = Alpine.store('auth').session?.access_token;
        if (!authToken) {
          console.error('SSEæ¥ç¶š: èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãŒå–å¾—ã§ãã¾ã›ã‚“');
          return;
        }

        const response = await fetch(`/rooms/${this.roomId}/sse-token`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          throw new Error(`SSEãƒˆãƒ¼ã‚¯ãƒ³å–å¾—å¤±æ•—: ${response.status}`);
        }

        const tokenData = await response.json();
        const sseToken = tokenData.token;

        const url = `/rooms/${this.roomId}/messages/stream?token=${encodeURIComponent(sseToken)}`;

        this.eventSource = new EventSource(url);
      } catch (error) {
        console.error('SSEãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        return;
      }
      this.sseReconnectCount = (this.sseReconnectCount || 0);

      this.eventSource.addEventListener('open', (event) => {
        this.sseReconnectCount = 0; // æ¥ç¶šæˆåŠŸæ™‚ã«ãƒªã‚»ãƒƒãƒˆ
      });

      // æ¥ç¶šç¢ºèªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      this.eventSource.addEventListener('connected', (event) => {
        this.sseReconnectCount = 0; // æ¥ç¶šæˆåŠŸç¢ºèªæ™‚ã«ãƒªã‚»ãƒƒãƒˆ
      });

      this.eventSource.addEventListener('message', (event) => {
        try {
          const data = JSON.parse(event.data);
          if (data.type === 'message') {
            this.handleNewMessage(data.data);
          } else if (data.type === 'system_message') {
            this.handleSystemMessage(data.data);
          }
        } catch (err) {
          console.error('SSEãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è§£æã‚¨ãƒ©ãƒ¼:', err);
        }
      });

      this.eventSource.addEventListener('error', (event) => {
        console.error('SSEæ¥ç¶šã‚¨ãƒ©ãƒ¼:', event, 'çŠ¶æ…‹:', this.eventSource.readyState);

        // å†æ¥ç¶šã®åˆ¶é™ï¼ˆæœ€å¤§5å›ã¾ã§ï¼‰
        if (this.sseReconnectCount < 5) {
          this.sseReconnectCount++;
          const delay = Math.min(1000 * Math.pow(2, this.sseReconnectCount - 1), 30000); // æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ï¼ˆæœ€å¤§30ç§’ï¼‰

          setTimeout(async () => {
            if (this.isAuthenticated && Alpine.store('auth').session?.access_token) {
              await this.connectSSE();
            }
          }, delay);
        } else {
          console.error('SSEæœ€å¤§å†æ¥ç¶šå›æ•°ã«é”ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚');
        }
      });
    },

    handleNewMessage(message) {
      // è‡ªåˆ†ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆã™ã§ã«é€ä¿¡æ™‚ã«è¿½åŠ ã•ã‚Œã¦ã„ã‚‹ï¼‰
      // Supabaseãƒ¦ãƒ¼ã‚¶ãƒ¼IDã§æ¯”è¼ƒ
      if (message.user.supabase_user_id === this.currentUserId) return;

      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
      this.messages.push({
        id: message.id,
        type: 'user',
        content: message.message,
        userName: message.user.display_name,
        userAvatar: message.user.avatar_url || '/static/images/default-avatar.png',
        isOwn: false,
        timestamp: new Date(message.created_at)
      });

      this.$nextTick(() => this.scrollToBottom());
    },

    handleSystemMessage(message) {
      // ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
      this.messages.push({
        id: message.id,
        type: 'system',
        subtype: 'join', // å…¥å®¤ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ã—ã¦æ‰±ã†
        content: message.message,
        timestamp: new Date()
      });

      this.$nextTick(() => this.scrollToBottom());
    },

    addOptimisticMessage() {
      const messageInput = document.getElementById('message-input');
      const messageText = messageInput.value.trim();

      if (!messageText || !Alpine.store('auth').isAuthenticated) return;

      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å³åº§ã«è¡¨ç¤ºï¼ˆæ¥½è¦³çš„æ›´æ–°ï¼‰
      const newMessage = {
        id: Date.now(),
        type: 'user',
        content: messageText,
        userName: Alpine.store('auth').user?.displayName || 'ã‚²ã‚¹ãƒˆ',
        userAvatar: Alpine.store('auth').user?.avatarUrl || '/static/images/default-avatar.png',
        isOwn: true,
        timestamp: new Date()
      };

      this.messages.push(newMessage);
      this.$nextTick(() => this.scrollToBottom());
    },

    async leaveRoom() {
      if (this.isLeaving) return;

      // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
      if (!confirm('æœ¬å½“ã«éƒ¨å±‹ã‚’é€€å‡ºã—ã¾ã™ã‹ï¼Ÿ')) {
        return;
      }

      this.isLeaving = true;

      try {
        const authToken = Alpine.store('auth').session?.access_token;
        if (!authToken) {
          throw new Error('èªè¨¼ãŒå¿…è¦ã§ã™');
        }

        const response = await fetch(`/rooms/${this.roomId}/leave`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          throw new Error('é€€å‡ºå‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

        // SSEæ¥ç¶šã‚’é–‰ã˜ã‚‹
        if (this.eventSource) {
          this.eventSource.close();
        }

        // éƒ¨å±‹ä¸€è¦§ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
        window.location.href = '/rooms';
      } catch (error) {
        console.error('é€€å‡ºã‚¨ãƒ©ãƒ¼:', error);
        alert('é€€å‡ºå‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
        this.isLeaving = false;
      }
    },

    updateHostStatus() {
      if (this.isAuthenticated && this.currentUserId) {
        this.isHost = this.currentUserId === this.hostUserId;
        console.log('Host status updated:', { 
          currentUserId: this.currentUserId, 
          hostUserId: this.hostUserId, 
          isHost: this.isHost 
        });
      } else {
        this.isHost = false;
        console.log('Not authenticated or no current user, isHost set to false');
      }
      
      // å¼·åˆ¶çš„ã«Alpine.jsã®åå¿œã‚’ä¿ƒã™
      this.$nextTick(() => {
        this.$el.dispatchEvent(new CustomEvent('host-status-changed'));
      });
    },

    async loadGameVersions() {
      try {
        const response = await fetch('/api/game-versions/active');
        if (response.ok) {
          const data = await response.json();
          this.gameVersions = data.game_versions || [];
          console.log('Loaded game versions:', this.gameVersions);
        }
      } catch (error) {
        console.error('ã‚²ãƒ¼ãƒ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
      }
    },

    openSettingsModal() {
      console.log('openSettingsModal called');
      
      // ç¾åœ¨ã®éƒ¨å±‹ãƒ‡ãƒ¼ã‚¿ã§è¨­å®šãƒ•ã‚©ãƒ¼ãƒ ã‚’åˆæœŸåŒ–
      const room = {
        name: '{{ .PageData.Room.Name }}',
        description: '{{ .PageData.Room.GetDescription }}',
        game_version_id: '{{ .PageData.Room.GameVersionID }}',
        max_players: {{ .PageData.Room.MaxPlayers }},
        target_monster: '{{ .PageData.Room.GetTargetMonster }}',
        rank_requirement: '{{ .PageData.Room.GetRankRequirement }}'
      };
      
      console.log('Room data:', room);
      
      this.settingsData = {
        name: room.name || '',
        description: room.description || '',
        game_version_id: room.game_version_id || '',
        max_players: room.max_players || 4,
        target_monster: (room.target_monster && room.target_monster !== '<nil>') ? room.target_monster : '',
        rank_requirement: (room.rank_requirement && room.rank_requirement !== '<nil>') ? room.rank_requirement : '',
        password: '' // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯å¸¸ã«ç©ºã§åˆæœŸåŒ–
      };
      
      this.errors = {};
      this.showSettingsModal = true;
      
      console.log('showSettingsModal set to:', this.showSettingsModal);
      console.log('settingsData:', this.settingsData);
    },

    closeSettingsModal() {
      this.showSettingsModal = false;
      this.errors = {};
      this.isSubmitting = false;
    },

    get isFormValid() {
      return this.settingsData.name.trim() !== '' &&
             this.settingsData.game_version_id !== '' &&
             this.settingsData.max_players >= 2 &&
             this.settingsData.max_players <= 4 &&
             Object.keys(this.errors).length === 0;
    },

    validateField(field) {
      // ã‚¨ãƒ©ãƒ¼ã‚’ã‚¯ãƒªã‚¢
      delete this.errors[field];

      switch (field) {
        case 'name':
          if (!this.settingsData.name.trim()) {
            this.errors.name = 'éƒ¨å±‹åã¯å¿…é ˆã§ã™ã€‚';
          } else if (this.settingsData.name.length > 100) {
            this.errors.name = 'éƒ¨å±‹åã¯100æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
          }
          break;

        case 'description':
          if (this.settingsData.description.length > 500) {
            this.errors.description = 'èª¬æ˜æ–‡ã¯500æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
          }
          break;

        case 'game_version_id':
          if (!this.settingsData.game_version_id) {
            this.errors.game_version_id = 'ã‚²ãƒ¼ãƒ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚';
          }
          break;

        case 'max_players':
          if (this.settingsData.max_players < 2 || this.settingsData.max_players > 4) {
            this.errors.max_players = 'æœ€å¤§ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•°ã¯2ã€œ4äººã®é–“ã§è¨­å®šã—ã¦ãã ã•ã„ã€‚';
          }
          break;

        case 'target_monster':
          if (this.settingsData.target_monster.length > 50) {
            this.errors.target_monster = 'ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã¯50æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
          }
          break;

        case 'rank_requirement':
          if (this.settingsData.rank_requirement.length > 20) {
            this.errors.rank_requirement = 'ãƒ©ãƒ³ã‚¯è¦æ±‚ã¯20æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
          }
          break;

        case 'password':
          if (this.settingsData.password.length > 20) {
            this.errors.password = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯20æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
          }
          break;
      }

      // ãƒªã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªæ›´æ–°ã‚’ä¿ƒã™
      this.$nextTick();
    },

    async updateRoom() {
      if (this.isSubmitting || !this.isFormValid) return;

      // å…¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      Object.keys(this.settingsData).forEach(field => {
        this.validateField(field);
      });

      if (Object.keys(this.errors).length > 0) {
        return;
      }

      this.isSubmitting = true;

      try {
        const authToken = Alpine.store('auth').session?.access_token;
        if (!authToken) {
          throw new Error('èªè¨¼ãŒå¿…è¦ã§ã™');
        }

        const response = await fetch(`/rooms/${this.roomId}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(this.settingsData)
        });

        if (!response.ok) {
          const errorData = await response.text();
          throw new Error(errorData || 'éƒ¨å±‹è¨­å®šã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

        const result = await response.json();
        
        // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        alert('éƒ¨å±‹è¨­å®šã‚’æ›´æ–°ã—ã¾ã—ãŸ');
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        this.closeSettingsModal();
        
        // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦æœ€æ–°ã®æƒ…å ±ã‚’è¡¨ç¤º
        window.location.reload();
      } catch (error) {
        console.error('éƒ¨å±‹è¨­å®šæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
        alert('éƒ¨å±‹è¨­å®šã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        this.isSubmitting = false;
      }
    },

    async dismissRoom() {
      if (this.isDismissing) return;

      // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
      if (!confirm('æœ¬å½“ã«éƒ¨å±‹ã‚’è§£æ•£ã—ã¾ã™ã‹ï¼Ÿ\nè§£æ•£ã™ã‚‹ã¨ã€ã™ã¹ã¦ã®ãƒ¡ãƒ³ãƒãƒ¼ãŒé€€å‡ºã—ã€éƒ¨å±‹ã¯å‰Šé™¤ã•ã‚Œã¾ã™ã€‚')) {
        return;
      }

      this.isDismissing = true;

      try {
        const authToken = Alpine.store('auth').session?.access_token;
        if (!authToken) {
          throw new Error('èªè¨¼ãŒå¿…è¦ã§ã™');
        }

        const response = await fetch(`/rooms/${this.roomId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          throw new Error('è§£æ•£å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

        const result = await response.json();

        // SSEæ¥ç¶šã‚’é–‰ã˜ã‚‹
        if (this.eventSource) {
          this.eventSource.close();
        }

        // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå…ˆãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ãã¡ã‚‰ã¸ã€ãã†ã§ãªã‘ã‚Œã°éƒ¨å±‹ä¸€è¦§ã¸
        window.location.href = result.redirect || '/rooms';
      } catch (error) {
        console.error('è§£æ•£ã‚¨ãƒ©ãƒ¼:', error);
        alert('è§£æ•£å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
        this.isDismissing = false;
      }
    }
  };
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã«å…¬é–‹
window.roomDetail = roomDetail;
</script>
{{ end }}
