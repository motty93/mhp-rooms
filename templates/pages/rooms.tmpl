{{ define "head" }}
  <meta
    name="description"
    content="ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ãƒãƒ³ã‚¿ãƒ¼éƒ¨å±‹ä¸€è¦§ - MonHubï¼ˆãƒ¢ãƒ³ãƒãƒ–ï¼‰ã€‚ãƒ¢ãƒ³ãƒãƒ³ãƒãƒ¼ã‚¿ãƒ–ãƒ«ã‚·ãƒªãƒ¼ã‚ºã®å”åŠ›ãƒ—ãƒ¬ã‚¤ãƒ«ãƒ¼ãƒ ã‚’æ¤œç´¢ãƒ»å‚åŠ ã§ãã¾ã™ã€‚"
  />
  <meta
    name="keywords"
    content="ãƒ¢ãƒ³ãƒãƒ³,éƒ¨å±‹ä¸€è¦§,ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ãƒãƒ³ã‚¿ãƒ¼,å”åŠ›ãƒ—ãƒ¬ã‚¤,ã‚ªãƒ³ãƒ©ã‚¤ãƒ³,MonHub,ãƒ¢ãƒ³ãƒãƒ–"
  />
  <meta property="og:title" content="éƒ¨å±‹ä¸€è¦§ - MonHub" />
  <meta
    property="og:description"
    content="ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ãƒãƒ³ã‚¿ãƒ¼ã®éƒ¨å±‹ä¸€è¦§ã€‚ãƒ¢ãƒ³ãƒãƒ³ãƒãƒ¼ã‚¿ãƒ–ãƒ«ã‚·ãƒªãƒ¼ã‚ºã®å”åŠ›ãƒ—ãƒ¬ã‚¤ã‚’æ¥½ã—ã‚‚ã†"
  />
{{ end }}

{{ define "page" }}
  <div x-data="rooms()" x-init="checkPSNIdRequired()">
    <section class="bg-white py-8 border-b border-gray-200">
      <div class="container mx-auto px-4">
        <div class="hidden md:flex items-center justify-between">
          <div>
            <h1 class="text-3xl font-bold text-gray-800 mb-2">éƒ¨å±‹ä¸€è¦§</h1>
            <p class="text-gray-600">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªéƒ¨å±‹ã‚’æ¢ãã†</p>
          </div>

          {{ template "room-create-button" (dict "Size" "large") }}
        </div>

        <!-- ãƒ¢ãƒã‚¤ãƒ«ç”¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ -->
        <div class="md:hidden">
          <div class="mb-4">
            <h1 class="text-2xl font-bold text-gray-800 mb-2">éƒ¨å±‹ä¸€è¦§</h1>
            <p class="text-gray-600 text-sm">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªéƒ¨å±‹ã‚’æ¢ãã†</p>
          </div>

          <div class="flex justify-center">
            <!-- éƒ¨å±‹ä½œæˆãƒœã‚¿ãƒ³ï¼ˆèªè¨¼çŠ¶æ…‹ã§åˆ‡ã‚Šæ›¿ãˆï¼‰ -->
            {{ template "room-create-button" (dict "Size" "small") }}
          </div>
        </div>
      </div>
    </section>

    <section class="bg-gray-50 py-6">
      <div class="container mx-auto px-4">
        <div class="flex flex-col items-start sm:flex-row sm:items-center mb-6">
          <span class="mb-2 sm:mb-0 sm:mr-4 text-gray-700 dark:text-gray-300"
            >ã‚²ãƒ¼ãƒ ã§çµã‚Šè¾¼ã¿ï¼š</span
          >
          <select
            id="game-version-select"
            name="game_version"
            class="w-full sm:w-48 px-3 py-2 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm text-gray-900 dark:text-gray-100"
            @change="filterRooms($event.target.value)"
          >
            <option value="">ã™ã¹ã¦ã®ã‚²ãƒ¼ãƒ </option>
            {{ range .PageData.GameVersions }}
              <option value="{{ .Code }}">{{ .Name }}</option>
            {{ end }}
          </select>
        </div>
        <div
          class="mt-4 text-sm text-gray-600"
          x-show="filteredRooms.length > 0"
          x-cloak
          aria-live="polite"
          aria-atomic="true"
        >
          <span x-text="filteredRooms.length"></span>ä»¶ã®éƒ¨å±‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ
        </div>
      </div>
    </section>

    <section class="py-8">
      <div class="container mx-auto px-4" id="room-list-container">
        <div
          class="grid md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"
          x-show="filteredRooms.length > 0"
          x-cloak
        >
          <template x-for="room in filteredRooms" :key="room.id">
            <div
              class="room-card bg-white rounded-lg shadow-md border flex flex-col h-full hover:shadow-lg transition-all"
              :class="room.isJoined ? 'border-blue-300 bg-blue-50' : 'border-gray-200'"
            >
              <div class="p-6 flex-grow">
                <div class="flex items-center justify-between mb-4">
                  <div class="flex items-center space-x-3">
                    <div
                      :class="getGameIconClass(room.gameVersion.code)"
                      class="game-icon rounded"
                      :data-game="room.gameVersion.code"
                    ></div>
                    <div>
                      <h4
                        class="font-bold text-gray-800"
                        x-text="(room.hasPassword ? 'ğŸ”‘ ' : '') + room.name"
                      ></h4>
                      <p
                        class="text-sm text-gray-500"
                        x-text="room.gameVersion.name"
                      ></p>
                    </div>
                  </div>

                  <template x-if="room.isClosed">
                    <span
                      class="bg-gray-100 text-gray-800 text-sm px-2 py-1 rounded-full"
                      >closed</span
                    >
                  </template>
                  <template x-if="!room.isClosed">
                    <div class="flex items-center space-x-2">
                      <!-- å‚åŠ ä¸­ãƒãƒƒã‚¸ -->
                      <template x-if="room.isJoined">
                        <span
                          class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full font-medium"
                        >
                          å‚åŠ ä¸­
                        </span>
                      </template>
                      <!-- äººæ•°è¡¨ç¤º -->
                      <span
                        class="bg-green-100 text-green-800 text-sm px-2 py-1 rounded-full"
                        x-text="room.currentPlayers + '/' + room.maxPlayers"
                      ></span>
                    </div>
                  </template>
                </div>

                <template x-if="room.description">
                  <p
                    class="text-gray-600 text-sm mb-3"
                    x-text="room.description"
                  ></p>
                </template>

                <template
                  x-if="room.questType || room.targetMonster || room.rankRequirement"
                >
                  <div class="text-xs text-gray-500 space-y-1">
                    <template x-if="room.questType">
                      <div x-text="'ã‚¿ã‚¤ãƒ—: ' + room.questType"></div>
                    </template>
                    <template x-if="room.targetMonster">
                      <div x-text="'ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ: ' + room.targetMonster"></div>
                    </template>
                    <template x-if="room.rankRequirement">
                      <div x-text="'ãƒ©ãƒ³ã‚¯: ' + room.rankRequirement"></div>
                    </template>
                  </div>
                </template>
              </div>

              <div class="p-6 pt-0">
                <div class="flex items-center justify-between min-h-[40px]">
                  <span
                    class="text-sm text-gray-500"
                    x-text="'ãƒ›ã‚¹ãƒˆ: ' + (room.host.username || room.host.displayName)"
                  ></span>

                  <!-- ãƒœã‚¿ãƒ³é ˜åŸŸ - å›ºå®šé«˜ã•ã‚’ç¢ºä¿ -->
                  <div class="h-[36px] flex items-center justify-end">
                    <!-- å‚åŠ æ¸ˆã¿ã®éƒ¨å±‹ã®å ´åˆ -->
                    <template x-if="room.isJoined">
                      <button
                        @click="window.location.href = '/rooms/' + room.id"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm transition-colors h-full"
                      >
                        å…¥å®¤ã™ã‚‹
                      </button>
                    </template>

                    <!-- å‚åŠ å¯èƒ½ãªéƒ¨å±‹ã®å ´åˆ -->
                    <template
                      x-if="!room.isJoined && !room.isClosed && room.currentPlayers < room.maxPlayers"
                    >
                      <div class="h-full flex items-center">
                        <!-- èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”¨ -->
                        <button
                          x-show="$store.auth.initialized && $store.auth.isAuthenticated"
                          x-cloak
                          @click="openModal(room)"
                          :aria-label="'ã€Œ' + room.name + 'ã€ã«å‚åŠ '"
                          class="modal-button bg-gray-800 hover:bg-gray-900 text-white px-4 py-2 rounded text-sm transition-colors h-full"
                        >
                          å‚åŠ 
                        </button>

                        <!-- æœªèªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”¨ -->
                        <button
                          x-show="$store.auth.initialized && !$store.auth.isAuthenticated"
                          x-cloak
                          @click="openLoginModal()"
                          class="modal-button bg-gray-800 hover:bg-gray-900 text-white px-4 py-2 rounded text-sm transition-colors h-full"
                        >
                          å‚åŠ 
                        </button>
                      </div>
                    </template>
                    <!-- å‚åŠ ä¸å¯ã®å ´åˆ -->
                    <template
                      x-if="!room.isJoined && (room.isClosed || room.currentPlayers >= room.maxPlayers)"
                    >
                      <button
                        disabled
                        class="bg-gray-400 text-white px-4 py-2 rounded text-sm cursor-not-allowed h-full"
                      >
                        å‚åŠ ä¸å¯
                      </button>
                    </template>
                  </div>
                </div>
              </div>
            </div>
          </template>
        </div>
        <!-- ç©ºã®çŠ¶æ…‹ -->
        <div
          class="text-center py-16"
          x-show="filteredRooms.length === 0"
          x-cloak
        >
          <div class="text-gray-400 mb-4">
            <svg
              class="w-16 h-16 mx-auto mb-4"
              fill="currentColor"
              viewBox="0 0 20 20"
            >
              <path
                fill-rule="evenodd"
                d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z"
                clip-rule="evenodd"
              />
            </svg>
          </div>

          <h3 class="text-lg font-medium text-gray-500 mb-2">
            <span
              x-show="activeFilter !== ''"
              x-text="activeFilter + 'ã®éƒ¨å±‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'"
            ></span>
            <span x-show="activeFilter === ''"
              >ç¾åœ¨ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªéƒ¨å±‹ãŒã‚ã‚Šã¾ã›ã‚“</span
            >
          </h3>

          <p class="text-gray-400 mb-6">
            æ–°ã—ã„éƒ¨å±‹ã‚’ä½œã£ã¦ã€ãƒãƒ³ã‚¿ãƒ¼ã‚’å‹Ÿé›†ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼
          </p>

          <!-- éƒ¨å±‹ä½œæˆãƒœã‚¿ãƒ³ï¼ˆèªè¨¼çŠ¶æ…‹ã§åˆ‡ã‚Šæ›¿ãˆï¼‰ -->
          {{ template "room-create-button" (dict "Size" "inline") }}
        </div>
      </div>
    </section>

    <!-- éƒ¨å±‹å‚åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div
      x-show="showModal"
      x-cloak
      @click="closeModal()"
      x-transition:enter="transition ease-out duration-300"
      x-transition:enter-start="opacity-0"
      x-transition:enter-end="opacity-100"
      x-transition:leave="transition ease-in duration-200"
      x-transition:leave-start="opacity-100"
      x-transition:leave-end="opacity-0"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
    >
      <div
        @click.stop
        x-show="showModal"
        x-cloak
        x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="transform scale-95 opacity-0"
        x-transition:enter-end="transform scale-100 opacity-100"
        x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="transform scale-100 opacity-100"
        x-transition:leave-end="transform scale-95 opacity-0"
        role="dialog"
        aria-modal="true"
        aria-labelledby="modal-title"
        class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4"
      >
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="px-6 py-4 border-b border-gray-200">
          <h3
            id="modal-title"
            class="text-xl font-bold text-gray-800"
            x-text="currentRoom.name"
          ></h3>
          <p
            class="text-gray-600 mt-2 text-sm"
            x-show="currentRoom.description"
            x-text="currentRoom.description"
          ></p>
          <span
            class="inline-block px-3 py-1 text-xs font-medium rounded-full mt-2 bg-gray-100 text-gray-700"
            x-text="currentRoom.gameVersionCode"
          ></span>
        </div>

        <!-- éƒ¨å±‹æƒ…å ± -->
        <div class="px-6 py-4">
          <div class="space-y-3 text-sm">
            <div class="flex items-center justify-between">
              <span class="text-gray-500">éƒ¨å±‹ä¸»</span>
              <span
                class="font-medium text-gray-800"
                x-text="currentRoom.hostName"
              ></span>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-gray-500">å‚åŠ äººæ•°</span>
              <span
                class="font-medium text-gray-800"
                x-text="`${currentRoom.currentPlayers}/${currentRoom.maxPlayers}`"
              ></span>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-gray-500">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</span>
              <span
                class="font-medium"
                :class="currentRoom.hasPassword ? 'text-red-600' : 'text-green-600'"
                x-text="currentRoom.hasPassword ? 'ã‚ã‚Š' : 'ãªã—'"
              ></span>
            </div>
          </div>

          <!-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›ï¼ˆå¿…è¦ãªå ´åˆã®ã¿ï¼‰ -->
          <div x-show="currentRoom.hasPassword" class="mt-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">
              ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„
            </label>
            <input
              type="password"
              x-model="password"
              @keydown.enter="joinRoom()"
              placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"
              autocomplete="new-password"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-800 focus:border-transparent"
            />
          </div>
        </div>

        <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
        <div
          class="px-6 py-4 bg-gray-50 rounded-b-lg flex justify-end space-x-3 relative"
        >
          <button
            @click="closeModal()"
            class="modal-button px-4 py-2 text-gray-600 hover:text-gray-800 font-medium transition-colors"
          >
            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
          </button>
          <div class="relative">
            <button
              @click="joinRoom()"
              :disabled="isJoinDisabled"
              x-text="isJoining ? 'å‚åŠ ä¸­...' : 'å‚åŠ ã™ã‚‹'"
              class="modal-button px-6 py-2 bg-gray-800 hover:bg-gray-900 text-white font-medium rounded-lg transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed"
            ></button>

            <!-- ã‚¨ãƒ©ãƒ¼tooltip -->
            <div
              x-show="showError"
              x-transition:enter="transition ease-out duration-200"
              x-transition:enter-start="opacity-0 transform scale-95"
              x-transition:enter-end="opacity-100 transform scale-100"
              x-transition:leave="transition ease-in duration-150"
              x-transition:leave-start="opacity-100 transform scale-100"
              x-transition:leave-end="opacity-0 transform scale-95"
              class="absolute bottom-full right-0 mb-2 px-3 py-2 bg-red-600 text-white text-sm rounded-lg shadow-lg whitespace-nowrap z-50 max-w-xs"
              x-cloak
            >
              <div x-text="errorMessage"></div>
              <!-- ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã®çŸ¢å° -->
              <div
                class="absolute top-full right-4 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-red-600"
              ></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ãƒ­ã‚°ã‚¤ãƒ³æ¡ˆå†…ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div
      x-show="showLoginModal"
      x-cloak
      @click.self="closeLoginModal()"
      x-transition:enter="transition ease-out duration-300"
      x-transition:enter-start="opacity-0"
      x-transition:enter-end="opacity-100"
      x-transition:leave="transition ease-in duration-200"
      x-transition:leave-start="opacity-100"
      x-transition:leave-end="opacity-0"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
    >
      <div
        x-show="showLoginModal"
        x-cloak
        x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="transform scale-95 opacity-0"
        x-transition:enter-end="transform scale-100 opacity-100"
        x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="transform scale-100 opacity-100"
        x-transition:leave-end="transform scale-95 opacity-0"
        class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4"
      >
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div
          class="flex items-center justify-between p-6 border-b border-gray-200"
        >
          <h3 class="text-lg font-semibold text-gray-800">
            ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™
          </h3>
          <button
            @click="closeLoginModal()"
            class="text-gray-400 hover:text-gray-600 text-xl font-bold"
          >
            Ã—
          </button>
        </div>

        <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <div class="p-6 text-center">
          <div class="text-gray-600 mb-6">
            éƒ¨å±‹ã«å‚åŠ ã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚<br />
            ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ä»–ã®ãƒãƒ³ã‚¿ãƒ¼ã¨ä¸€ç·’ã«ç‹©ã‚Šã‚’æ¥½ã—ã¿ã¾ã—ã‚‡ã†ï¼
          </div>

          <div class="mb-6">
            <svg
              class="mx-auto h-16 w-16 text-gray-400"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
              />
            </svg>
          </div>
        </div>

        <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
        <div
          class="px-6 py-4 bg-gray-50 rounded-b-lg flex justify-center space-x-3"
        >
          <button
            @click="closeLoginModal()"
            class="modal-button px-4 py-2 text-gray-600 hover:text-gray-800 font-medium transition-colors"
          >
            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
          </button>
          <a
            href="/auth/login"
            class="modal-button px-6 py-2 bg-gray-800 hover:bg-gray-900 text-white font-medium rounded-lg transition-colors"
          >
            ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹
          </a>
        </div>
      </div>
    </div>

    <!-- ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
    <div
      x-show="showConfirmDialog"
      x-cloak
      @click.self="closeConfirmDialog()"
      x-transition:enter="transition ease-out duration-300"
      x-transition:enter-start="opacity-0"
      x-transition:enter-end="opacity-100"
      x-transition:leave="transition ease-in duration-200"
      x-transition:leave-start="opacity-100"
      x-transition:leave-end="opacity-0"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
    >
      <div
        x-show="showConfirmDialog"
        x-cloak
        x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="transform scale-95 opacity-0"
        x-transition:enter-end="transform scale-100 opacity-100"
        x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="transform scale-100 opacity-100"
        x-transition:leave-end="transform scale-95 opacity-0"
        class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4"
      >
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="px-6 py-4 border-b border-gray-200">
          <h3 class="text-lg font-semibold text-gray-800">
            ä»–ã®éƒ¨å±‹ã«å‚åŠ ä¸­ã§ã™
          </h3>
        </div>

        <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <div class="p-6">
          <div class="text-gray-600 mb-4">
            æ—¢ã«åˆ¥ã®éƒ¨å±‹ã«å‚åŠ ã—ã¦ã„ã¾ã™ã€‚<br />
            æ–°ã—ã„éƒ¨å±‹ã«å‚åŠ ã™ã‚‹ã¨ã€ç¾åœ¨ã®éƒ¨å±‹ã‹ã‚‰é€€å‡ºã—ã¾ã™ã€‚ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ
          </div>

          <div class="mb-4">
            <svg
              class="mx-auto h-12 w-12 text-yellow-400"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.464 0L4.35 16.5c-.77.833.192 2.5 1.732 2.5z"
              />
            </svg>
          </div>
        </div>

        <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
        <div
          class="px-6 py-4 bg-gray-50 rounded-b-lg flex justify-end space-x-3"
        >
          <button
            @click="closeConfirmDialog()"
            class="modal-button px-4 py-2 text-gray-600 hover:text-gray-800 font-medium transition-colors"
          >
            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
          </button>
          <button
            @click="confirmJoinRoom()"
            :disabled="isJoining"
            x-text="isJoining ? 'é€€å‡ºã—ã¦å‚åŠ ä¸­...' : 'é€€å‡ºã—ã¦å‚åŠ '"
            class="modal-button px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white font-medium rounded-lg transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed"
          ></button>
        </div>
      </div>
    </div>

    <!-- ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°éƒ¨å±‹ä½œæˆãƒœã‚¿ãƒ³ï¼ˆãƒ¢ãƒã‚¤ãƒ«å°‚ç”¨ï¼‰ -->
    {{ template "room-create-button" (dict "Size" "floating") }}
  </div>

<script>
  document.addEventListener('alpine:init', () => {
    function rooms() {
      return {
        showModal: false,
        showLoginModal: false,
        currentRoom: {},
        password: '',
        isJoining: false,
        showError: false,
        errorMessage: '',
        allRooms: [],
        filteredRooms: [],
        activeFilter: '',
        lastFocusedElement: null,
        showConfirmDialog: false,
        confirmRoomId: null,
        async checkPSNIdRequired() {
          try {
            const authStore = Alpine.store('auth');
            // æ—¢ã«åˆæœŸåŒ–æ¸ˆã¿ã®å ´åˆã¯ã€å†åº¦checkAuth()ã‚’å‘¼ã°ãªã„
            if (!authStore.initialized) {
              return; // ã¾ã åˆæœŸåŒ–ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„
            }
            if (authStore.needsPSNId) {
              console.log('PSN IDãŒæœªè¨­å®šã§ã™ã€‚ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®šç”»é¢ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã¾ã™ã€‚');
              window.location.href = '/auth/complete-profile';
            }
          } catch (error) {
            console.error('PSN IDãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
          }
        },
        // åˆæœŸåŒ–å‡¦ç†
        init() {
          // ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
          const roomsData = {{.PageData.Rooms | json}};
          this.allRooms = roomsData.map(room => ({
            id: room.id,
            name: room.name,
            description: room.description || '',
            gameVersion: {
              code: room.game_version?.code || '',
              name: room.game_version?.name || ''
            },
            host: {
              username: room.host?.username || '',
              displayName: room.host?.display_name || ''
            },
            currentPlayers: room.current_players || 0,
            maxPlayers: room.max_players || 4,
            isClosed: room.is_closed || false,
            hasPassword: room.password_hash ? true : false,
            targetMonster: room.target_monster || '',
            rankRequirement: room.rank_requirement || '',
            isJoined: room.is_joined || false
          }));
          // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰åˆæœŸãƒ•ã‚£ãƒ«ã‚¿ã‚’è¨­å®š
          const urlParams = new URLSearchParams(window.location.search);
          const gameVersionFilter = urlParams.get('game_version') || '';
          this.activeFilter = gameVersionFilter;
          // åˆæœŸãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
          this.filterRooms(gameVersionFilter);
          // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
          document.addEventListener('keydown', this.handleEsc.bind(this));
        },
        // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ©Ÿèƒ½
        filterRooms(gameVersion) {
          this.activeFilter = gameVersion;
          if (gameVersion === '') {
            this.filteredRooms = this.allRooms;
          } else {
            this.filteredRooms = this.allRooms.filter(room => room.gameVersion.code === gameVersion);
          }
          // URLã‚’æ›´æ–°ï¼ˆå±¥æ­´ã‚’è¿½åŠ ã›ãšã«ï¼‰
          const url = new URL(window.location);
          if (gameVersion) {
            url.searchParams.set('game_version', gameVersion);
          } else {
            url.searchParams.delete('game_version');
          }
          window.history.replaceState({}, '', url);
        },
        // å‚åŠ ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹åˆ¤å®š
        get isJoinDisabled() {
          return this.isJoining || (this.currentRoom.hasPassword && !this.password.trim())
        },
        // éƒ¨å±‹å‚åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        openModal(room) {
          // ç¾åœ¨ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ä½ç½®ã‚’ä¿å­˜
          this.lastFocusedElement = document.activeElement;
          this.currentRoom = {
            id: room.id,
            name: room.name,
            description: room.description,
            gameVersionCode: room.gameVersion.code,
            gameVersionName: room.gameVersion.name,
            hostName: room.host.username || room.host.displayName,
            currentPlayers: room.currentPlayers,
            maxPlayers: room.maxPlayers,
            hasPassword: room.hasPassword
          };
          this.password = ''
          this.isJoining = false
          this.showModal = true
          // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ç®¡ç†
          this.$nextTick(() => {
            const modal = this.$el.querySelector('[role="dialog"]')
            if (modal) {
              // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã«ãƒˆãƒ©ãƒƒãƒ—
              const focusableElements = modal.querySelectorAll('button, input, a');
              if (room.hasPassword) {
                const passwordInput = modal.querySelector("input[type='password']")
                if (passwordInput) passwordInput.focus()
              } else if (focusableElements.length > 0) {
                focusableElements[focusableElements.length - 1].focus() // å‚åŠ ãƒœã‚¿ãƒ³ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
              }
            }
          })
        },
        closeModal() {
          this.showModal = false
          // ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³å®Œäº†å¾Œã«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
          setTimeout(() => {
            this.currentRoom = {}
            this.password = ''
            this.isJoining = false
            this.showError = false
            this.errorMessage = ''
          }, 300) // ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³æ™‚é–“ã¨åŒã˜
          // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’å…ƒã®è¦ç´ ã«æˆ»ã™
          if (this.lastFocusedElement) {
            this.lastFocusedElement.focus()
            this.lastFocusedElement = null
          }
        },
        openLoginModal() {
          this.showLoginModal = true
        },
        closeLoginModal() {
          this.showLoginModal = false
        },
        async joinRoom() {
          if (this.isJoinDisabled) return

          // èªè¨¼çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
          if (!Alpine.store('auth').isAuthenticated) {
            this.closeModal()
            this.openLoginModal()
            return
          }

          this.isJoining = true
          const requestData = {}
          if (this.currentRoom.hasPassword) {
            requestData.password = this.password
          }
          try {
            // èªè¨¼ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’æº–å‚™
            const headers = {
              'Content-Type': 'application/json'
            }

            if (Alpine.store('auth').session?.access_token) {
              headers['Authorization'] = `Bearer ${Alpine.store('auth').session.access_token}`
            }

            const response = await fetch(`/rooms/${this.currentRoom.id}/join`, {
              method: 'POST',
              headers: headers,
              body: JSON.stringify(requestData),
            })
            if (!response.ok) {
              if (response.status === 401) {
                throw new Error('èªè¨¼ãŒå¿…è¦ã§ã™ã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚')
              } else if (response.status === 409) {
                // ä»–ã®éƒ¨å±‹ã«å‚åŠ ã—ã¦ã„ã‚‹å ´åˆã®ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
                const errorText = await response.text()
                if (errorText.includes('æ—¢ã«åˆ¥ã®éƒ¨å±‹ã«å‚åŠ ã—ã¦ã„ã¾ã™')) {
                  this.showConfirmDialog = true
                  this.confirmRoomId = this.currentRoom.id
                  this.isJoining = false
                  return
                }
                throw new Error(errorText || 'å‚åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ')
              } else if (response.status === 400) {
                const errorData = await response.text()
                throw new Error(errorData || 'å‚åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ')
              }
              throw new Error('å‚åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ')
            }

            const result = await response.json()

            // æˆåŠŸæ™‚ã¯éƒ¨å±‹è©³ç´°ç”»é¢ã«é·ç§»ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã¯é–‰ã˜ãªã„ï¼‰
            if (result.redirect) {
              window.location.href = result.redirect
            } else {
              window.location.reload()
            }
          } catch (error) {
            this.showErrorMessage(error.message || 'å‚åŠ ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚')
            this.isJoining = false
            if (this.currentRoom.hasPassword) {
              this.password = ''
              this.$nextTick(() => {
                const passwordInput = this.$el.querySelector("input[type='password']")
                if (passwordInput) passwordInput.focus()
              })
            }
          }
        },
        // Escã‚­ãƒ¼ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        handleEsc(event) {
          if (event.key === 'Escape' && this.showModal) {
            this.closeModal()
          }
        },
        // ã‚²ãƒ¼ãƒ ã‚¢ã‚¤ã‚³ãƒ³ã‚¯ãƒ©ã‚¹ã‚’å®‰å…¨ã«å–å¾—
        getGameIconClass(code) {
          const validCodes = ['mhp', 'mhp2', 'mhp2g', 'mhp3', 'mhxx'];
          const lowerCode = code.toLowerCase();
          if (validCodes.includes(lowerCode)) {
            return lowerCode + '-icon';
          }
          return 'default-icon';
        },
        // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºï¼ˆtooltipå½¢å¼ï¼‰
        showErrorMessage(message) {
          this.errorMessage = message
          this.showError = true

          // 3ç§’å¾Œã«è‡ªå‹•ã§éè¡¨ç¤º
          setTimeout(() => {
            this.showError = false
            this.errorMessage = ''
          }, 3000)
        },
        // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‰ã˜ã‚‹
        closeConfirmDialog() {
          this.showConfirmDialog = false
          this.confirmRoomId = null
          this.isJoining = false
          // å‚åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚‚ä¸€ç·’ã«é–‰ã˜ã‚‹
          this.closeModal()
        },

        // å¼·åˆ¶çš„ã«é€€å‡ºã—ã¦å‚åŠ 
        async confirmJoinRoom() {
          if (!this.confirmRoomId) return

          this.isJoining = true
          let hasLeft = false // é€€å‡ºå‡¦ç†ãŒå®Ÿè¡Œã•ã‚ŒãŸã‹ã‚’è¿½è·¡

          try {
            const authToken = Alpine.store('auth').session?.access_token
            const requestData = {}
            if (this.currentRoom.hasPassword) {
              requestData.password = this.password
            }

            // æ–°ã—ã„ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½¿ç”¨ã—ã¦ã€é€€å‡ºã¨å‚åŠ ã‚’ä¸€åº¦ã«å‡¦ç†
            requestData.forceJoin = true // å¼·åˆ¶å‚åŠ ãƒ•ãƒ©ã‚°ã‚’è¿½åŠ 

            const joinResponse = await fetch(`/rooms/${this.confirmRoomId}/join`, {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${authToken}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(requestData)
            })

            if (!joinResponse.ok) {
              const errorText = await joinResponse.text()
              
              // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼ã®å ´åˆ
              if (joinResponse.status === 400 && errorText.includes('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™')) {
                throw new Error('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™')
              }
              
              throw new Error(errorText || 'å‚åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ')
            }

            const result = await joinResponse.json()

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã¦éƒ¨å±‹è©³ç´°ã«é·ç§»
            this.closeConfirmDialog()
            this.closeModal()

            if (result.redirect) {
              window.location.href = result.redirect
            } else {
              window.location.reload()
            }

          } catch (error) {
            console.error('å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error)
            
            // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é©åˆ‡ã«è¡¨ç¤º
            let errorMessage = error.message || 'å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚'
            
            // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢ã—ã¦ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
            if (errorMessage.includes('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™')) {
              this.password = ''
              // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‰ã˜ã¦ã€é€šå¸¸ã®å‚åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«ã«æˆ»ã‚‹
              this.closeConfirmDialog()
              this.$nextTick(() => {
                const passwordInput = this.$el.querySelector("input[type='password']")
                if (passwordInput) passwordInput.focus()
              })
            }
            
            this.showErrorMessage(errorMessage)
            this.isJoining = false
          }
        },

        // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å‡¦ç†
        destroy() {
          document.removeEventListener('keydown', this.handleEsc.bind(this))
        },
      }
    }
    Alpine.data('rooms', rooms)
  })

</script>
{{ end }}
